# Fooling around with https://github.com/gunnarmorling/1brc

## Linux Performance Tools (Brendan Gregg)

https://www.youtube.com/watch?v=FJW8nGV4jxY

### Methodologies

Objectives
- Recognize the Streetlight Anti-Method
- Perform the Workload Characterization Method
- Perform the USE Method
- Learn how to start with the questions before using the tools
- Be aware of other methodologies

"program is slow, what does it do?"

- top / iostat / iotop / netstat / ss / dstat / sar / vmstat / strace

- methodologies should have a starting point, a process, and an ending point (checklist, then done)

#### Anti-Methods

Streetlight Anti-Method
- "Start where the light is best" (I'm used to top so I start with top)

Drunk Man Anti-Method:
- "Tune things at random until the problem goes away", doesn't help much / whack-a-mole

Blame Someone Else Anti-Method
- Find a system or environment that you are not responsible for and ask them

#### Actual Methodologies

Problem Statement Method
- What makes you think that there is a performance problem?
- Has this system ever performend well?
- What has changed recently? (Software? Hardware? Load?)
- Can the performance degradation be expressed in latency or run time?
- Does the problem affect other people or applications (or is it just you)?
- What is the environment? Software, hardware, instance types? Versions? Configuration?

Workload Characterization Method
- Who is causing the load? PID, UID, IP addr, ...
- Why is the load called? code pth, stack trace
- What is the load? IOPS, tput, type, r/w
- How is the load changing over time?

The USE Method
- For every resource, check:
	- Utilization
	- Saturation
	- Errors
- Definitions:
	- Utilization: busy time
	- Saturation: queue length or queued time
	- Errors: easy to interpret (objective)
- Helps if you have a functional (block) diagram of your system / software / environment, showing all resources

Start with the questions, then find the tools

- Examples (hardware): CPU interconnect / CPU / DRAM / Power / Fan / I/O Bridge / I/O Controller / Network Controller / Ports
- Every component in your data path can be the problem
- `Linux USE Method Example` posted online by Brendan Gregg

Off-CPU Analysis
- "when does my program step off of the CPU, and why?"
- Thread State Transition Diagram
- anon. major fault

CPU Profile Method
- CPU Profile
- Flamegraph

RTFM Method (How to understand performance tools and metrics?)
- Man pages
- Books
- Web search
- Co-workers
- Prior talk slides/video (like this one!)
- Support services
- Source code
- Experimentation
- Social

#### Tools

Objectives
- Perform the USE Method for resource utilization
- Perform the Workload Characterization method for disks, network
- Perform the CPU Profile Method using flame graphs
- Have exposure to various observability tools:
	- Basic: vmstat, iostat, mpstat, ps, top, ...
	- Intermediate: tcpdump, netstat, nicstat, pidstat, sar, ...
	- Advanced: ss, slaptop, perf_events, ...
- Perform Active Benchmarking
- Understand tuning risks
- Perform Static Performance Tuning

Command Line Tools
- Useful to study even if you don't use them directly, vmstat etcc

Tool Types
- Observability (watch activity, safe)
	- Basic
		- uptime, top, ps, vmstat, iostat, mpstat (multi-proc stats), free
		- Debug latency:
			- top: high system time, high idle and wait io
			- vmstat: moderate system time, wait io and idle time
			- vmstat: plenty free, no swapping
			- iostat: disks are pretty busy
			- sar: network seems idle
	- Intermediate
		- strace, tcpdump, netstat, nicstat, pidstat, swapon, lsof, sar
		- Debug "slow" app:
			- vmstat: lots of use time and system time, no swap
			- mpstat: same
			- pidstat: lab003
			- iostat: not disks
			- sar: no network
			- strace: spams read on fd 3, requesting 0 bytes (in a loop)
- Benchmarking ( 
	- UnixBench, lmbench, sysbench, perf bench
	- dd, hdparm, fio
	- ab, wrk, jmeter, openssl
	- ping, hping3, iperf, ttcp, traceroute, mtr, pchar
	- "Active Benchmarking (Method)": run the actual workload, use observability to measure
- Tuning
	- sysctl, /sys
	- app config / nice / renice/ taskset / ulimit / chcpu / tune2gs / ionice / hdparm / blockdev / ethtool / tc / ip / route / stap / kpatch
	- Tuning Method: Question -> Hypothesis -> Prediction -> Test -> Analysis
- Static
	- Static Performance Tuning (no workload): CPU types + flags, CPU Frequency Scaling / storage devices / file system capacity / route table
	- /proc/cpuinfo, /sys/devices/system/cpu/cpu0/cpufreq/{scaling_availale_frequencies,scaling_governor}
	- /proc/scsi/scsi, netstat -rn, ip route get xx.yy.zz.ww
	- dmesg / ifconfig -a / df -h / mdadm --misd -D /dev/md0, smartctl, numactl -s, lspci, lsmod, crontab -l, service --status-all

- Profiling
	- perf ( record -F 99 -ag -- ... ) (99 for avoiding sampling lock steps, so maybe even better to use a prime?)
	- perf repot (stack traces)
	- flamegraph -- merge stack traces ( perf script | ./stackcollapse-perf.pl | ./flamegraph.pl > perf.svg )
	- high CPU Usage by not attributed to a PID might be because of many short-lived processes
	- perf_events workflow: perf list, perf stat, perf record, perf report or perf script -> stackcollapse -> flamegraph
	- perf event mixed mode (see JVM stack trace + java stack traces + kernel stack traces)

- Tracing
	- tracepoints (kernel trace points)
	- kprobes etc
	- choosing a tracer, some companices standardize. Brendan's suggestion is to use what's in the kernel to begin with
	- ./funccount -i 1 'bio_*'  <-- summarize kernel functions starting with bio_
	- ./funcgraph -Htp 5363 vfs_read <--- tracing vfs_read and children
	- perf_events have different event sources, some from hardware and some from software
	- perf record -e block:block_rq_complete -a sleep 10 ...
	- eBPF (program that run on perf events in the kernel, JITed)

##### Namedropping other things
- tiptop, "top" for PMCs (might need some love in the cloud, maybe perfmon2 lib integration? PMCs are not always enabled in the guest.)
- rdmsr (read model specific registers), usually enabled in guests
- github.com/brendangregg/msr-cloud-tools
- 



## System

System:
  CPU: Intel Core Ultra 9 285K (Arrow Lake-S), 24 cores / 24 threads
       Hybrid architecture (P-cores + E-cores), SMT disabled
  Cache:
    L1d/L1i: private per P-core (≈38 KiB L1d, 64 KiB L1i)
    L2: 12 instances (private on P-cores, shared on E-core clusters), total 40 MiB
    L3: 36 MiB shared (single instance)
  NUMA: single node
  Memory: <fill from free -h / dmidecode>

Memory:
  Capacity: 32 GB
  Configuration: 2 × 16 GB DDR5 DIMMs
  Channels: Dual-channel
  Speed: DDR5-6400 (configured)
  Rank: Single-rank
  Voltage: 1.4 V
  Manufacturer: Corsair
  Part number: CMK32GX5M2B6400C32
  ECC: No
  Slots populated: DIMMA2, DIMMB2 (2 of 4)

Memory profile: XMP enabled (DDR5-6400)

## Installing Java

$ curl -s "https://get.sdkman.io" | bash
$ sdk install java 21.0.5-tem
$ javac --version
javac 21.0.5

## Prepare the data

$ git clone https://github.com/gunnarmorling/1brc.git java-orig

>> The tests in the official challenge were ran from a RAM disk

$ sudo mkdir /media/measurements
$ mount -t tmpfs -o size=16G tmpfs /media/measurements

$ ln -fs /media/measurements/measurements.txt measurements.txt 

$ time ./create_measurements.sh 1000000000
Wrote 50,000,000 measurements in 5534 ms
Wrote 100,000,000 measurements in 12735 ms
Wrote 150,000,000 measurements in 19899 ms
Wrote 200,000,000 measurements in 27111 ms
Wrote 250,000,000 measurements in 34291 ms
Wrote 300,000,000 measurements in 41568 ms
Wrote 350,000,000 measurements in 48735 ms
Wrote 400,000,000 measurements in 55947 ms
Wrote 450,000,000 measurements in 63162 ms
Wrote 500,000,000 measurements in 70353 ms
Wrote 550,000,000 measurements in 77554 ms
Wrote 600,000,000 measurements in 84747 ms
Wrote 650,000,000 measurements in 91935 ms
Wrote 700,000,000 measurements in 99113 ms
Wrote 750,000,000 measurements in 106295 ms
Wrote 800,000,000 measurements in 113494 ms
Wrote 850,000,000 measurements in 120687 ms
Wrote 900,000,000 measurements in 127898 ms
Wrote 950,000,000 measurements in 135105 ms
Created file with 1,000,000,000 measurements in 142302 ms

real	2m22.348s
user	2m20.210s
sys	0m2.697s

$ time wc -l measurements.txt 
1000000000 measurements.txt

real	0m0.913s
user	0m0.085s
sys	0m0.828s

folkol@ubuntu:~/code/labs/1brc/java-orig$ time ./calculate_average_baseline.sh 
#
# A fatal error has been detected by the Java Runtime Environment:
#
#  SIGSEGV (0xb) at pc=0x00007360243b9fea, pid=94484, tid=94485
#
# JRE version: OpenJDK Runtime Environment Temurin-21.0.5+11 (21.0.5+11) (build 21.0.5+11-LTS)
# Java VM: OpenJDK 64-Bit Server VM Temurin-21.0.5+11 (21.0.5+11-LTS, mixed mode, sharing, tiered, compressed oops, compressed class ptrs, g1 gc, linux-amd64)
# Problematic frame:
# J 261 c2 java.util.HashMap.computeIfAbsent(Ljava/lang/Object;Ljava/util/function/Function;)Ljava/lang/Object; java.base@21.0.5 (330 bytes) @ 0x00007360243b9fea [0x00007360243b9d80+0x000000000000026a]
#
# Core dump will be written. Default location: Core dumps may be processed with "/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -F%F -- %E" (or dumping to /home/folkol/code/labs/1brc/java-orig/core.94484)
#
# An error report file with more information is saved as:
# /home/folkol/code/labs/1brc/java-orig/hs_err_pid94484.log
[7.927s][warning][os] Loading hsdis library failed
#
# If you would like to submit a bug report, please visit:
#   https://github.com/adoptium/adoptium-support/issues
#
Aborted (core dumped)

real	0m9.027s
user	0m8.010s
sys	0m0.370s

$ sdk install java 21.0.9-tem

$ crashed again...

$ third time is a charm! :)

$ /usr/bin/time -v time ./calculate_average_baseline.sh 
{Abha=-33.8/18.0/71.1, Abidjan=-23.6/26.0/77.3, Abéché=-23.2/29.4/78.4, Accra=-24.3/26.4/79.3, Addis Ababa=-34.5/16.0/64.9, Adelaide=-30.2/17.3/71.5, Aden=-20.4/29.1/79.8, Ahvaz=-25.4/25.4/73.8, Albuquerque=-39.2/14.0/66.5, Alexandra=-47.2/11.0/63.2, Alexandria=-31.4/20.0/68.1, Algiers=-32.1/18.2/69.8, Alice Springs=-30.5/21.0/68.0, Almaty=-45.3/10.0/58.1, Amsterdam=-40.1/10.2/59.0, Anadyr=-62.8/-6.9/41.8, Anchorage=-45.2/2.8/50.0, Andorra la Vella=-38.7/9.8/63.8, Ankara=-35.6/12.0/61.5, Antananarivo=-38.7/17.9/66.7, Antsiranana=-26.5/25.2/75.0, Arkhangelsk=-48.3/1.3/50.9, Ashgabat=-31.6/17.1/70.0, Asmara=-32.9/15.6/67.9, Assab=-16.7/30.5/77.9, Astana=-44.6/3.5/55.2, Athens=-31.2/19.2/66.6, Atlanta=-34.2/17.0/64.3, Auckland=-40.5/15.2/63.7, Austin=-30.0/20.7/71.6, Baghdad=-26.6/22.8/73.0, Baguio=-34.7/19.5/73.4, Baku=-42.1/15.1/66.5, Baltimore=-38.4/13.1/61.2, Bamako=-22.5/27.8/75.8, Bangkok=-22.3/28.6/78.2, Bangui=-26.7/26.0/73.9, Banjul=-23.0/26.0/74.9, Barcelona=-32.1/18.2/67.3, Bata=-22.9/25.1/76.3, Batumi=-32.6/14.0/64.5, Beijing=-37.7/12.9/60.8, Beirut=-31.0/20.9/69.9, Belgrade=-41.2/12.5/60.6, Belize City=-23.2/26.7/74.2, Benghazi=-34.4/19.9/67.0, Bergen=-39.9/7.7/55.5, Berlin=-40.4/10.3/67.7, Bilbao=-35.5/14.7/63.6, Birao=-29.1/26.5/77.4, Bishkek=-38.0/11.3/60.3, Bissau=-28.3/27.0/76.4, Blantyre=-25.6/22.2/71.8, Bloemfontein=-37.0/15.6/64.2, Boise=-35.2/11.4/59.5, Bordeaux=-33.0/14.2/66.0, Bosaso=-17.8/30.0/80.3, Boston=-36.8/10.9/71.6, Bouaké=-25.7/26.0/75.6, Bratislava=-39.0/10.5/61.6, Brazzaville=-29.1/25.0/73.2, Bridgetown=-21.9/27.0/76.9, Brisbane=-30.6/21.4/70.6, Brussels=-38.1/10.5/60.0, Bucharest=-42.1/10.8/60.8, Budapest=-41.3/11.3/61.7, Bujumbura=-24.1/23.8/72.8, Bulawayo=-31.9/18.9/74.1, Burnie=-34.0/13.1/63.7, Busan=-36.7/15.0/66.3, Cabo San Lucas=-25.5/23.9/72.3, Cairns=-26.3/25.0/74.1, Cairo=-29.7/21.4/72.6, Calgary=-46.0/4.4/55.7, Canberra=-36.7/13.1/66.9, Cape Town=-31.8/16.2/67.1, Changsha=-34.8/17.4/68.1, Charlotte=-36.6/16.1/66.8, Chiang Mai=-29.7/25.8/72.6, Chicago=-39.6/9.8/62.2, Chihuahua=-30.7/18.6/66.7, Chittagong=-26.0/25.9/82.7, Chișinău=-38.7/10.2/55.8, Chongqing=-33.8/18.6/66.7, Christchurch=-38.4/12.2/61.7, City of San Marino=-37.4/11.8/57.4, Colombo=-23.4/27.4/79.1, Columbus=-35.9/11.7/73.2, Conakry=-23.3/26.4/74.6, Copenhagen=-39.3/9.1/60.7, Cotonou=-21.0/27.2/80.1, Cracow=-44.9/9.3/58.3, Da Lat=-32.6/17.9/65.6, Da Nang=-24.8/25.8/75.6, Dakar=-27.6/24.0/73.8, Dallas=-31.3/19.0/70.2, Damascus=-32.9/17.0/64.2, Dampier=-20.4/26.4/77.5, Dar es Salaam=-25.5/25.8/73.2, Darwin=-26.1/27.6/79.0, Denpasar=-23.6/23.7/74.5, Denver=-39.7/10.4/62.4, Detroit=-43.4/10.0/63.1, Dhaka=-22.1/25.9/78.3, Dikson=-64.9/-11.1/39.5, Dili=-22.8/26.6/78.2, Djibouti=-19.0/29.9/84.4, Dodoma=-25.3/22.7/76.2, Dolisie=-24.4/24.0/76.6, Douala=-21.8/26.7/79.3, Dubai=-20.2/26.9/74.2, Dublin=-45.0/9.8/56.9, Dunedin=-44.3/11.1/63.1, Durban=-28.1/20.6/72.6, Dushanbe=-35.9/14.7/63.6, Edinburgh=-43.6/9.3/64.0, Edmonton=-45.4/4.2/52.4, El Paso=-31.7/18.1/65.7, Entebbe=-32.0/21.0/72.1, Erbil=-27.9/19.5/67.4, Erzurum=-42.6/5.1/55.2, Fairbanks=-49.7/-2.3/49.8, Fianarantsoa=-32.9/17.9/66.1, Flores,  Petén=-23.7/26.4/78.9, Frankfurt=-40.1/10.6/58.2, Fresno=-33.9/17.9/66.0, Fukuoka=-33.0/17.0/68.8, Gaborone=-27.4/21.0/68.8, Gabès=-29.9/19.5/67.4, Gagnoa=-25.9/26.0/74.5, Gangtok=-32.0/15.2/65.4, Garissa=-22.6/29.3/77.9, Garoua=-23.0/28.3/80.1, George Town=-22.0/27.9/80.3, Ghanzi=-25.5/21.4/74.6, Gjoa Haven=-64.0/-14.4/36.1, Guadalajara=-28.5/20.9/70.1, Guangzhou=-26.9/22.4/70.8, Guatemala City=-32.0/20.4/70.9, Halifax=-40.7/7.5/55.2, Hamburg=-38.3/9.7/59.7, Hamilton=-37.7/13.8/62.7, Hanga Roa=-29.0/20.5/71.8, Hanoi=-28.9/23.6/75.7, Harare=-37.7/18.4/71.6, Harbin=-48.2/5.0/60.7, Hargeisa=-26.4/21.7/68.6, Hat Yai=-22.5/27.0/74.9, Havana=-23.4/25.2/77.2, Helsinki=-45.7/5.9/60.0, Heraklion=-40.2/18.9/65.3, Hiroshima=-36.1/16.3/65.6, Ho Chi Minh City=-24.4/27.4/76.3, Hobart=-39.3/12.7/62.3, Hong Kong=-24.8/23.3/73.4, Honiara=-27.1/26.5/76.9, Honolulu=-24.1/25.4/74.2, Houston=-28.6/20.8/77.1, Ifrane=-39.4/11.4/63.2, Indianapolis=-42.1/11.8/64.6, Iqaluit=-56.3/-9.3/41.8, Irkutsk=-50.8/1.0/49.9, Istanbul=-40.4/13.9/61.7, Jacksonville=-30.9/20.3/67.6, Jakarta=-21.4/26.7/74.5, Jayapura=-24.6/27.0/79.6, Jerusalem=-30.4/18.3/70.2, Johannesburg=-34.8/15.5/68.2, Jos=-27.0/22.8/74.9, Juba=-19.9/27.8/78.6, Kabul=-38.6/12.1/60.0, Kampala=-31.5/20.0/67.9, Kandi=-23.4/27.7/79.0, Kankan=-23.2/26.5/81.6, Kano=-27.1/26.4/74.4, Kansas City=-39.3/12.5/62.0, Karachi=-27.1/26.0/75.5, Karonga=-29.7/24.4/70.6, Kathmandu=-34.1/18.3/67.6, Khartoum=-26.2/29.9/77.9, Kingston=-24.3/27.4/81.1, Kinshasa=-22.3/25.3/75.8, Kolkata=-22.0/26.7/79.8, Kuala Lumpur=-22.4/27.3/78.1, Kumasi=-20.9/26.0/76.0, Kunming=-33.5/15.7/69.3, Kuopio=-46.6/3.4/55.9, Kuwait City=-27.2/25.7/75.4, Kyiv=-42.3/8.4/57.5, Kyoto=-32.9/15.8/66.4, La Ceiba=-22.4/26.2/80.0, La Paz=-29.1/23.7/77.9, Lagos=-23.3/26.8/76.5, Lahore=-30.8/24.3/74.6, Lake Havasu City=-27.0/23.7/70.0, Lake Tekapo=-45.1/8.7/56.8, Las Palmas de Gran Canaria=-31.1/21.2/72.2, Las Vegas=-28.6/20.3/69.4, Launceston=-40.0/13.1/65.1, Lhasa=-43.5/7.6/63.7, Libreville=-23.3/25.9/76.1, Lisbon=-34.0/17.5/64.7, Livingstone=-27.7/21.8/72.2, Ljubljana=-42.6/10.9/60.3, Lodwar=-20.6/29.3/76.7, Lomé=-26.5/26.9/76.1, London=-35.9/11.3/59.5, Los Angeles=-34.2/18.6/70.0, Louisville=-36.0/13.9/67.5, Luanda=-26.2/25.8/77.2, Lubumbashi=-27.2/20.8/66.3, Lusaka=-32.0/19.9/70.8, Luxembourg City=-40.8/9.3/61.1, Lviv=-38.6/7.8/59.3, Lyon=-35.0/12.5/57.7, Madrid=-33.2/15.0/63.1, Mahajanga=-26.0/26.3/79.1, Makassar=-22.0/26.7/75.4, Makurdi=-27.2/26.0/81.2, Malabo=-22.2/26.3/77.7, Malé=-20.6/28.0/81.6, Managua=-25.6/27.3/75.2, Manama=-24.6/26.5/74.7, Mandalay=-22.0/28.0/78.6, Mango=-19.7/28.1/80.6, Manila=-20.7/28.4/80.6, Maputo=-25.0/22.8/72.2, Marrakesh=-27.4/19.6/68.8, Marseille=-32.8/15.8/64.9, Maun=-30.5/22.4/73.0, Medan=-26.2/26.5/78.0, Mek'ele=-26.6/22.7/77.8, Melbourne=-46.0/15.1/71.8, Memphis=-35.3/17.2/68.3, Mexicali=-24.8/23.1/75.3, Mexico City=-34.7/17.5/66.8, Miami=-25.3/24.9/73.5, Milan=-34.7/13.0/63.5, Milwaukee=-46.4/8.9/58.4, Minneapolis=-42.0/7.8/56.5, Minsk=-42.8/6.7/55.9, Mogadishu=-27.5/27.1/75.5, Mombasa=-23.1/26.3/72.7, Monaco=-34.4/16.4/65.2, Moncton=-40.1/6.1/59.1, Monterrey=-28.5/22.3/75.7, Montreal=-43.3/6.8/58.5, Moscow=-45.0/5.8/53.6, Mumbai=-19.6/27.1/76.5, Murmansk=-53.3/0.6/50.6, Muscat=-23.0/28.0/80.4, Mzuzu=-32.4/17.7/66.4, N'Djamena=-21.2/28.3/74.8, Naha=-30.1/23.1/74.6, Nairobi=-32.1/17.8/65.2, Nakhon Ratchasima=-24.6/27.3/80.1, Napier=-34.5/14.6/60.2, Napoli=-37.7/15.9/66.2, Nashville=-34.2/15.4/62.5, Nassau=-29.1/24.6/75.7, Ndola=-27.9/20.3/69.4, New Delhi=-30.5/25.0/74.9, New Orleans=-33.1/20.7/77.8, New York City=-37.6/12.9/63.8, Ngaoundéré=-30.2/22.0/75.7, Niamey=-26.6/29.3/79.4, Nicosia=-27.7/19.7/68.8, Niigata=-35.1/13.9/65.4, Nouadhibou=-30.4/21.3/72.7, Nouakchott=-24.9/25.7/73.9, Novosibirsk=-49.9/1.7/54.6, Nuuk=-48.8/-1.4/49.9, Odesa=-38.7/10.7/64.3, Odienné=-24.8/26.0/76.7, Oklahoma City=-31.6/15.9/64.8, Omaha=-39.6/10.6/60.8, Oranjestad=-26.4/28.1/78.1, Oslo=-45.8/5.7/54.8, Ottawa=-42.3/6.6/58.7, Ouagadougou=-20.4/28.3/80.3, Ouahigouya=-18.9/28.6/77.8, Ouarzazate=-30.9/18.9/81.8, Oulu=-45.8/2.7/53.3, Palembang=-20.5/27.3/76.0, Palermo=-35.6/18.5/72.9, Palm Springs=-29.0/24.5/73.2, Palmerston North=-37.8/13.2/63.0, Panama City=-21.2/28.0/77.2, Parakou=-23.3/26.8/77.6, Paris=-41.0/12.3/61.6, Perth=-34.9/18.7/70.0, Petropavlovsk-Kamchatsky=-45.6/1.9/51.1, Philadelphia=-42.3/13.2/64.2, Phnom Penh=-23.5/28.3/80.6, Phoenix=-27.5/23.9/74.1, Pittsburgh=-41.1/10.8/66.7, Podgorica=-36.2/15.3/68.1, Pointe-Noire=-21.2/26.1/76.8, Pontianak=-19.2/27.7/79.8, Port Moresby=-24.0/26.9/74.9, Port Sudan=-19.1/28.4/78.2, Port Vila=-28.2/24.3/71.3, Port-Gentil=-22.6/26.0/81.2, Portland (OR)=-37.2/12.4/64.9, Porto=-34.6/15.7/65.3, Prague=-43.5/8.4/56.4, Praia=-25.1/24.4/73.9, Pretoria=-32.1/18.2/68.7, Pyongyang=-36.5/10.8/62.1, Rabat=-31.8/17.2/65.1, Rangpur=-24.0/24.4/71.3, Reggane=-24.1/28.3/78.0, Reykjavík=-44.0/4.3/54.8, Riga=-46.4/6.2/53.0, Riyadh=-26.5/26.0/75.3, Rome=-37.8/15.2/64.4, Roseau=-22.7/26.2/76.4, Rostov-on-Don=-38.2/9.9/58.8, Sacramento=-37.6/16.3/65.8, Saint Petersburg=-43.3/5.8/53.8, Saint-Pierre=-46.9/5.7/57.1, Salt Lake City=-36.3/11.6/62.2, San Antonio=-28.4/20.8/68.9, San Diego=-30.2/17.8/65.7, San Francisco=-36.1/14.6/63.3, San Jose=-33.5/16.4/66.0, San José=-28.2/22.6/81.0, San Juan=-22.4/27.2/79.3, San Salvador=-27.5/23.1/71.8, Sana'a=-28.6/20.0/70.6, Santo Domingo=-21.4/25.9/78.2, Sapporo=-39.8/8.9/61.5, Sarajevo=-36.3/10.1/59.0, Saskatoon=-45.5/3.3/52.1, Seattle=-34.9/11.3/60.8, Seoul=-34.6/12.5/59.5, Seville=-28.2/19.2/71.0, Shanghai=-37.9/16.7/65.4, Singapore=-24.3/27.0/75.6, Skopje=-37.1/12.4/65.1, Sochi=-41.5/14.2/64.4, Sofia=-38.3/10.6/58.1, Sokoto=-19.5/28.0/76.0, Split=-33.0/16.1/65.9, St. John's=-45.8/5.0/54.4, St. Louis=-38.4/13.9/61.6, Stockholm=-43.3/6.6/61.4, Surabaya=-22.7/27.1/80.4, Suva=-25.5/25.6/75.4, Suwałki=-40.5/7.2/55.1, Sydney=-34.9/17.7/69.5, Ségou=-22.3/28.0/75.5, Tabora=-26.9/23.0/74.5, Tabriz=-35.0/12.6/63.8, Taipei=-28.6/23.0/75.9, Tallinn=-43.8/6.4/56.7, Tamale=-21.5/27.9/78.9, Tamanrasset=-24.9/21.7/73.8, Tampa=-24.2/22.9/72.1, Tashkent=-34.1/14.8/68.4, Tauranga=-34.4/14.8/62.9, Tbilisi=-35.7/12.9/63.7, Tegucigalpa=-29.4/21.7/72.5, Tehran=-31.7/17.0/65.1, Tel Aviv=-32.2/20.0/67.5, Thessaloniki=-35.8/16.0/67.4, Thiès=-28.4/24.0/75.5, Tijuana=-31.2/17.8/71.6, Timbuktu=-20.7/28.0/75.4, Tirana=-34.9/15.2/66.1, Toamasina=-27.0/23.4/72.7, Tokyo=-33.2/15.4/61.9, Toliara=-26.0/24.1/78.0, Toluca=-39.8/12.4/67.9, Toronto=-40.4/9.4/62.2, Tripoli=-28.2/20.0/68.7, Tromsø=-45.0/2.9/54.5, Tucson=-31.0/20.9/71.0, Tunis=-29.8/18.4/68.3, Ulaanbaatar=-50.6/-0.4/47.6, Upington=-27.6/20.4/70.6, Vaduz=-42.2/10.1/59.0, Valencia=-28.5/18.3/71.9, Valletta=-30.3/18.8/68.7, Vancouver=-40.3/10.4/63.5, Veracruz=-21.7/25.4/73.2, Vienna=-42.7/10.4/59.5, Vientiane=-23.7/25.9/73.1, Villahermosa=-20.9/27.1/79.3, Vilnius=-47.1/6.0/55.3, Virginia Beach=-34.2/15.8/69.8, Vladivostok=-43.8/4.9/54.0, Warsaw=-37.1/8.5/60.0, Washington, D.C.=-36.6/14.6/62.5, Wau=-22.2/27.8/76.1, Wellington=-37.5/12.9/64.0, Whitehorse=-49.8/-0.1/59.8, Wichita=-34.0/13.9/65.8, Willemstad=-29.4/28.0/78.5, Winnipeg=-47.4/3.0/55.2, Wrocław=-37.7/9.6/60.3, Xi'an=-37.1/14.1/62.4, Yakutsk=-61.5/-8.8/39.4, Yangon=-20.8/27.5/78.5, Yaoundé=-25.4/23.8/74.6, Yellowknife=-58.3/-4.3/44.8, Yerevan=-35.5/12.4/70.4, Yinchuan=-47.9/9.0/61.2, Zagreb=-41.8/10.7/60.5, Zanzibar City=-21.8/26.0/78.9, Zürich=-41.5/9.3/59.8, Ürümqi=-40.6/7.4/58.6, İzmir=-29.6/17.9/71.1}
78.04user 2.05system 1:19.53elapsed 100%CPU (0avgtext+0avgdata 738180maxresident)k
0inputs+0outputs (0major+185464minor)pagefaults 0swaps
	Command being timed: "time ./calculate_average_baseline.sh"
	User time (seconds): 78.04
	System time (seconds): 2.05
	Percent of CPU this job got: 100%
	Elapsed (wall clock) time (h:mm:ss or m:ss): 1:19.53
	Average shared text size (kbytes): 0
	Average unshared data size (kbytes): 0
	Average stack size (kbytes): 0
	Average total size (kbytes): 0
	Maximum resident set size (kbytes): 738180
	Average resident set size (kbytes): 0
	Major (requiring I/O) page faults: 0
	Minor (reclaiming a frame) page faults: 185553
	Voluntary context switches: 65988
	Involuntary context switches: 1172
	Swaps: 0
	File system inputs: 0
	File system outputs: 0
	Socket messages sent: 0
	Socket messages received: 0
	Signals delivered: 0
	Page size (bytes): 4096
	Exit status: 0

## Trying fastest solution

$ time ./calculate_average_thomaswue.sh 
Chosing to run the app in JVM mode as no native image was found, use prepare_thomaswue.sh to generate.
{Abha=-33.8/18.0/71.1, Abidjan=-23.6/26.0/77.3, Abéché=-23.2/29.4/78.4, Accra=-24.3/26.4/79.3, Addis Ababa=-34.5/16.0/64.9, Adelaide=-30.2/17.3/71.5, Aden=-20.4/29.1/79.8, Ahvaz=-25.4/25.4/73.8, Albuquerque=-39.2/14.0/66.5, Alexandra=-47.2/11.0/63.2, Alexandria=-31.4/20.0/68.1, Algiers=-32.1/18.2/69.8, Alice Springs=-30.5/21.0/68.0, Almaty=-45.3/10.0/58.1, Amsterdam=-40.1/10.2/59.0, Anadyr=-62.8/-6.9/41.8, Anchorage=-45.2/2.8/50.0, Andorra la Vella=-38.7/9.8/63.8, Ankara=-35.6/12.0/61.5, Antananarivo=-38.7/17.9/66.7, Antsiranana=-26.5/25.2/75.0, Arkhangelsk=-48.3/1.3/50.9, Ashgabat=-31.6/17.1/70.0, Asmara=-32.9/15.6/67.9, Assab=-16.7/30.5/77.9, Astana=-44.6/3.5/55.2, Athens=-31.2/19.2/66.6, Atlanta=-34.2/17.0/64.3, Auckland=-40.5/15.2/63.7, Austin=-30.0/20.7/71.6, Baghdad=-26.6/22.8/73.0, Baguio=-34.7/19.5/73.4, Baku=-42.1/15.1/66.5, Baltimore=-38.4/13.1/61.2, Bamako=-22.5/27.8/75.8, Bangkok=-22.3/28.6/78.2, Bangui=-26.7/26.0/73.9, Banjul=-23.0/26.0/74.9, Barcelona=-32.1/18.2/67.3, Bata=-22.9/25.1/76.3, Batumi=-32.6/14.0/64.5, Beijing=-37.7/12.9/60.8, Beirut=-31.0/20.9/69.9, Belgrade=-41.2/12.5/60.6, Belize City=-23.2/26.7/74.2, Benghazi=-34.4/19.9/67.0, Bergen=-39.9/7.7/55.5, Berlin=-40.4/10.3/67.7, Bilbao=-35.5/14.7/63.6, Birao=-29.1/26.5/77.4, Bishkek=-38.0/11.3/60.3, Bissau=-28.3/27.0/76.4, Blantyre=-25.6/22.2/71.8, Bloemfontein=-37.0/15.6/64.2, Boise=-35.2/11.4/59.5, Bordeaux=-33.0/14.2/66.0, Bosaso=-17.8/30.0/80.3, Boston=-36.8/10.9/71.6, Bouaké=-25.7/26.0/75.6, Bratislava=-39.0/10.5/61.6, Brazzaville=-29.1/25.0/73.2, Bridgetown=-21.9/27.0/76.9, Brisbane=-30.6/21.4/70.6, Brussels=-38.1/10.5/60.0, Bucharest=-42.1/10.8/60.8, Budapest=-41.3/11.3/61.7, Bujumbura=-24.1/23.8/72.8, Bulawayo=-31.9/18.9/74.1, Burnie=-34.0/13.1/63.7, Busan=-36.7/15.0/66.3, Cabo San Lucas=-25.5/23.9/72.3, Cairns=-26.3/25.0/74.1, Cairo=-29.7/21.4/72.6, Calgary=-46.0/4.4/55.7, Canberra=-36.7/13.1/66.9, Cape Town=-31.8/16.2/67.1, Changsha=-34.8/17.4/68.1, Charlotte=-36.6/16.1/66.8, Chiang Mai=-29.7/25.8/72.6, Chicago=-39.6/9.8/62.2, Chihuahua=-30.7/18.6/66.7, Chittagong=-26.0/25.9/82.7, Chișinău=-38.7/10.2/55.8, Chongqing=-33.8/18.6/66.7, Christchurch=-38.4/12.2/61.7, City of San Marino=-37.4/11.8/57.4, Colombo=-23.4/27.4/79.1, Columbus=-35.9/11.7/73.2, Conakry=-23.3/26.4/74.6, Copenhagen=-39.3/9.1/60.7, Cotonou=-21.0/27.2/80.1, Cracow=-44.9/9.3/58.3, Da Lat=-32.6/17.9/65.6, Da Nang=-24.8/25.8/75.6, Dakar=-27.6/24.0/73.8, Dallas=-31.3/19.0/70.2, Damascus=-32.9/17.0/64.2, Dampier=-20.4/26.4/77.5, Dar es Salaam=-25.5/25.8/73.2, Darwin=-26.1/27.6/79.0, Denpasar=-23.6/23.7/74.5, Denver=-39.7/10.4/62.4, Detroit=-43.4/10.0/63.1, Dhaka=-22.1/25.9/78.3, Dikson=-64.9/-11.1/39.5, Dili=-22.8/26.6/78.2, Djibouti=-19.0/29.9/84.4, Dodoma=-25.3/22.7/76.2, Dolisie=-24.4/24.0/76.6, Douala=-21.8/26.7/79.3, Dubai=-20.2/26.9/74.2, Dublin=-45.0/9.8/56.9, Dunedin=-44.3/11.1/63.1, Durban=-28.1/20.6/72.6, Dushanbe=-35.9/14.7/63.6, Edinburgh=-43.6/9.3/64.0, Edmonton=-45.4/4.2/52.4, El Paso=-31.7/18.1/65.7, Entebbe=-32.0/21.0/72.1, Erbil=-27.9/19.5/67.4, Erzurum=-42.6/5.1/55.2, Fairbanks=-49.7/-2.3/49.8, Fianarantsoa=-32.9/17.9/66.1, Flores,  Petén=-23.7/26.4/78.9, Frankfurt=-40.1/10.6/58.2, Fresno=-33.9/17.9/66.0, Fukuoka=-33.0/17.0/68.8, Gaborone=-27.4/21.0/68.8, Gabès=-29.9/19.5/67.4, Gagnoa=-25.9/26.0/74.5, Gangtok=-32.0/15.2/65.4, Garissa=-22.6/29.3/77.9, Garoua=-23.0/28.3/80.1, George Town=-22.0/27.9/80.3, Ghanzi=-25.5/21.4/74.6, Gjoa Haven=-64.0/-14.4/36.1, Guadalajara=-28.5/20.9/70.1, Guangzhou=-26.9/22.4/70.8, Guatemala City=-32.0/20.4/70.9, Halifax=-40.7/7.5/55.2, Hamburg=-38.3/9.7/59.7, Hamilton=-37.7/13.8/62.7, Hanga Roa=-29.0/20.5/71.8, Hanoi=-28.9/23.6/75.7, Harare=-37.7/18.4/71.6, Harbin=-48.2/5.0/60.7, Hargeisa=-26.4/21.7/68.6, Hat Yai=-22.5/27.0/74.9, Havana=-23.4/25.2/77.2, Helsinki=-45.7/5.9/60.0, Heraklion=-40.2/18.9/65.3, Hiroshima=-36.1/16.3/65.6, Ho Chi Minh City=-24.4/27.4/76.3, Hobart=-39.3/12.7/62.3, Hong Kong=-24.8/23.3/73.4, Honiara=-27.1/26.5/76.9, Honolulu=-24.1/25.4/74.2, Houston=-28.6/20.8/77.1, Ifrane=-39.4/11.4/63.2, Indianapolis=-42.1/11.8/64.6, Iqaluit=-56.3/-9.3/41.8, Irkutsk=-50.8/1.0/49.9, Istanbul=-40.4/13.9/61.7, Jacksonville=-30.9/20.3/67.6, Jakarta=-21.4/26.7/74.5, Jayapura=-24.6/27.0/79.6, Jerusalem=-30.4/18.3/70.2, Johannesburg=-34.8/15.5/68.2, Jos=-27.0/22.8/74.9, Juba=-19.9/27.8/78.6, Kabul=-38.6/12.1/60.0, Kampala=-31.5/20.0/67.9, Kandi=-23.4/27.7/79.0, Kankan=-23.2/26.5/81.6, Kano=-27.1/26.4/74.4, Kansas City=-39.3/12.5/62.0, Karachi=-27.1/26.0/75.5, Karonga=-29.7/24.4/70.6, Kathmandu=-34.1/18.3/67.6, Khartoum=-26.2/29.9/77.9, Kingston=-24.3/27.4/81.1, Kinshasa=-22.3/25.3/75.8, Kolkata=-22.0/26.7/79.8, Kuala Lumpur=-22.4/27.3/78.1, Kumasi=-20.9/26.0/76.0, Kunming=-33.5/15.7/69.3, Kuopio=-46.6/3.4/55.9, Kuwait City=-27.2/25.7/75.4, Kyiv=-42.3/8.4/57.5, Kyoto=-32.9/15.8/66.4, La Ceiba=-22.4/26.2/80.0, La Paz=-29.1/23.7/77.9, Lagos=-23.3/26.8/76.5, Lahore=-30.8/24.3/74.6, Lake Havasu City=-27.0/23.7/70.0, Lake Tekapo=-45.1/8.7/56.8, Las Palmas de Gran Canaria=-31.1/21.2/72.2, Las Vegas=-28.6/20.3/69.4, Launceston=-40.0/13.1/65.1, Lhasa=-43.5/7.6/63.7, Libreville=-23.3/25.9/76.1, Lisbon=-34.0/17.5/64.7, Livingstone=-27.7/21.8/72.2, Ljubljana=-42.6/10.9/60.3, Lodwar=-20.6/29.3/76.7, Lomé=-26.5/26.9/76.1, London=-35.9/11.3/59.5, Los Angeles=-34.2/18.6/70.0, Louisville=-36.0/13.9/67.5, Luanda=-26.2/25.8/77.2, Lubumbashi=-27.2/20.8/66.3, Lusaka=-32.0/19.9/70.8, Luxembourg City=-40.8/9.3/61.1, Lviv=-38.6/7.8/59.3, Lyon=-35.0/12.5/57.7, Madrid=-33.2/15.0/63.1, Mahajanga=-26.0/26.3/79.1, Makassar=-22.0/26.7/75.4, Makurdi=-27.2/26.0/81.2, Malabo=-22.2/26.3/77.7, Malé=-20.6/28.0/81.6, Managua=-25.6/27.3/75.2, Manama=-24.6/26.5/74.7, Mandalay=-22.0/28.0/78.6, Mango=-19.7/28.1/80.6, Manila=-20.7/28.4/80.6, Maputo=-25.0/22.8/72.2, Marrakesh=-27.4/19.6/68.8, Marseille=-32.8/15.8/64.9, Maun=-30.5/22.4/73.0, Medan=-26.2/26.5/78.0, Mek'ele=-26.6/22.7/77.8, Melbourne=-46.0/15.1/71.8, Memphis=-35.3/17.2/68.3, Mexicali=-24.8/23.1/75.3, Mexico City=-34.7/17.5/66.8, Miami=-25.3/24.9/73.5, Milan=-34.7/13.0/63.5, Milwaukee=-46.4/8.9/58.4, Minneapolis=-42.0/7.8/56.5, Minsk=-42.8/6.7/55.9, Mogadishu=-27.5/27.1/75.5, Mombasa=-23.1/26.3/72.7, Monaco=-34.4/16.4/65.2, Moncton=-40.1/6.1/59.1, Monterrey=-28.5/22.3/75.7, Montreal=-43.3/6.8/58.5, Moscow=-45.0/5.8/53.6, Mumbai=-19.6/27.1/76.5, Murmansk=-53.3/0.6/50.6, Muscat=-23.0/28.0/80.4, Mzuzu=-32.4/17.7/66.4, N'Djamena=-21.2/28.3/74.8, Naha=-30.1/23.1/74.6, Nairobi=-32.1/17.8/65.2, Nakhon Ratchasima=-24.6/27.3/80.1, Napier=-34.5/14.6/60.2, Napoli=-37.7/15.9/66.2, Nashville=-34.2/15.4/62.5, Nassau=-29.1/24.6/75.7, Ndola=-27.9/20.3/69.4, New Delhi=-30.5/25.0/74.9, New Orleans=-33.1/20.7/77.8, New York City=-37.6/12.9/63.8, Ngaoundéré=-30.2/22.0/75.7, Niamey=-26.6/29.3/79.4, Nicosia=-27.7/19.7/68.8, Niigata=-35.1/13.9/65.4, Nouadhibou=-30.4/21.3/72.7, Nouakchott=-24.9/25.7/73.9, Novosibirsk=-49.9/1.7/54.6, Nuuk=-48.8/-1.4/49.9, Odesa=-38.7/10.7/64.3, Odienné=-24.8/26.0/76.7, Oklahoma City=-31.6/15.9/64.8, Omaha=-39.6/10.6/60.8, Oranjestad=-26.4/28.1/78.1, Oslo=-45.8/5.7/54.8, Ottawa=-42.3/6.6/58.7, Ouagadougou=-20.4/28.3/80.3, Ouahigouya=-18.9/28.6/77.8, Ouarzazate=-30.9/18.9/81.8, Oulu=-45.8/2.7/53.3, Palembang=-20.5/27.3/76.0, Palermo=-35.6/18.5/72.9, Palm Springs=-29.0/24.5/73.2, Palmerston North=-37.8/13.2/63.0, Panama City=-21.2/28.0/77.2, Parakou=-23.3/26.8/77.6, Paris=-41.0/12.3/61.6, Perth=-34.9/18.7/70.0, Petropavlovsk-Kamchatsky=-45.6/1.9/51.1, Philadelphia=-42.3/13.2/64.2, Phnom Penh=-23.5/28.3/80.6, Phoenix=-27.5/23.9/74.1, Pittsburgh=-41.1/10.8/66.7, Podgorica=-36.2/15.3/68.1, Pointe-Noire=-21.2/26.1/76.8, Pontianak=-19.2/27.7/79.8, Port Moresby=-24.0/26.9/74.9, Port Sudan=-19.1/28.4/78.2, Port Vila=-28.2/24.3/71.3, Port-Gentil=-22.6/26.0/81.2, Portland (OR)=-37.2/12.4/64.9, Porto=-34.6/15.7/65.3, Prague=-43.5/8.4/56.4, Praia=-25.1/24.4/73.9, Pretoria=-32.1/18.2/68.7, Pyongyang=-36.5/10.8/62.1, Rabat=-31.8/17.2/65.1, Rangpur=-24.0/24.4/71.3, Reggane=-24.1/28.3/78.0, Reykjavík=-44.0/4.3/54.8, Riga=-46.4/6.2/53.0, Riyadh=-26.5/26.0/75.3, Rome=-37.8/15.2/64.4, Roseau=-22.7/26.2/76.4, Rostov-on-Don=-38.2/9.9/58.8, Sacramento=-37.6/16.3/65.8, Saint Petersburg=-43.3/5.8/53.8, Saint-Pierre=-46.9/5.7/57.1, Salt Lake City=-36.3/11.6/62.2, San Antonio=-28.4/20.8/68.9, San Diego=-30.2/17.8/65.7, San Francisco=-36.1/14.6/63.3, San Jose=-33.5/16.4/66.0, San José=-28.2/22.6/81.0, San Juan=-22.4/27.2/79.3, San Salvador=-27.5/23.1/71.8, Sana'a=-28.6/20.0/70.6, Santo Domingo=-21.4/25.9/78.2, Sapporo=-39.8/8.9/61.5, Sarajevo=-36.3/10.1/59.0, Saskatoon=-45.5/3.3/52.1, Seattle=-34.9/11.3/60.8, Seoul=-34.6/12.5/59.5, Seville=-28.2/19.2/71.0, Shanghai=-37.9/16.7/65.4, Singapore=-24.3/27.0/75.6, Skopje=-37.1/12.4/65.1, Sochi=-41.5/14.2/64.4, Sofia=-38.3/10.6/58.1, Sokoto=-19.5/28.0/76.0, Split=-33.0/16.1/65.9, St. John's=-45.8/5.0/54.4, St. Louis=-38.4/13.9/61.6, Stockholm=-43.3/6.6/61.4, Surabaya=-22.7/27.1/80.4, Suva=-25.5/25.6/75.4, Suwałki=-40.5/7.2/55.1, Sydney=-34.9/17.7/69.5, Ségou=-22.3/28.0/75.5, Tabora=-26.9/23.0/74.5, Tabriz=-35.0/12.6/63.8, Taipei=-28.6/23.0/75.9, Tallinn=-43.8/6.4/56.7, Tamale=-21.5/27.9/78.9, Tamanrasset=-24.9/21.7/73.8, Tampa=-24.2/22.9/72.1, Tashkent=-34.1/14.8/68.4, Tauranga=-34.4/14.8/62.9, Tbilisi=-35.7/12.9/63.7, Tegucigalpa=-29.4/21.7/72.5, Tehran=-31.7/17.0/65.1, Tel Aviv=-32.2/20.0/67.5, Thessaloniki=-35.8/16.0/67.4, Thiès=-28.4/24.0/75.5, Tijuana=-31.2/17.8/71.6, Timbuktu=-20.7/28.0/75.4, Tirana=-34.9/15.2/66.1, Toamasina=-27.0/23.4/72.7, Tokyo=-33.2/15.4/61.9, Toliara=-26.0/24.1/78.0, Toluca=-39.8/12.4/67.9, Toronto=-40.4/9.4/62.2, Tripoli=-28.2/20.0/68.7, Tromsø=-45.0/2.9/54.5, Tucson=-31.0/20.9/71.0, Tunis=-29.8/18.4/68.3, Ulaanbaatar=-50.6/-0.4/47.6, Upington=-27.6/20.4/70.6, Vaduz=-42.2/10.1/59.0, Valencia=-28.5/18.3/71.9, Valletta=-30.3/18.8/68.7, Vancouver=-40.3/10.4/63.5, Veracruz=-21.7/25.4/73.2, Vienna=-42.7/10.4/59.5, Vientiane=-23.7/25.9/73.1, Villahermosa=-20.9/27.1/79.3, Vilnius=-47.1/6.0/55.3, Virginia Beach=-34.2/15.8/69.8, Vladivostok=-43.8/4.9/54.0, Warsaw=-37.1/8.5/60.0, Washington, D.C.=-36.6/14.6/62.5, Wau=-22.2/27.8/76.1, Wellington=-37.5/12.9/64.0, Whitehorse=-49.8/-0.1/59.8, Wichita=-34.0/13.9/65.8, Willemstad=-29.4/28.0/78.5, Winnipeg=-47.4/3.0/55.2, Wrocław=-37.7/9.6/60.3, Xi'an=-37.1/14.1/62.4, Yakutsk=-61.5/-8.8/39.4, Yangon=-20.8/27.5/78.5, Yaoundé=-25.4/23.8/74.6, Yellowknife=-58.3/-4.3/44.8, Yerevan=-35.5/12.4/70.4, Yinchuan=-47.9/9.0/61.2, Zagreb=-41.8/10.7/60.5, Zanzibar City=-21.8/26.0/78.9, Zürich=-41.5/9.3/59.8, Ürümqi=-40.6/7.4/58.6, İzmir=-29.6/17.9/71.1}

real	0m0.767s
user	0m14.276s
sys	0m0.373s

$ ./prepare_thomaswue.sh 

Stop! Candidate version is not installed.

$ sdk install java 21.0.2-graal

 ./prepare_thomaswue.sh 

Using java version 21.0.2-graal in this shell.
Warning: The option '-H:-GenLoopSafepoints' is experimental and must be enabled via '-H:+UnlockExperimentalVMOptions' in the future.
Warning: Please re-evaluate whether any experimental option is required, and either remove or unlock it. The build output lists all active experimental options, including where they come from and possible alternatives. If you think an experimental option should be considered as stable, please file an issue.
========================================================================================================================
GraalVM Native Image: Generating 'CalculateAverage_thomaswue_image' (executable)...
========================================================================================================================
[1/8] Initializing...                                                                                    (1.5s @ 0.15GB)
 Java version: 21.0.2+13-LTS, vendor version: Oracle GraalVM 21.0.2+13.1
 Graal compiler: optimization level: 3, target machine: native, PGO: ML-inferred
 C compiler: gcc (linux, x86_64, 15.2.0)
 Garbage collector: Epsilon GC (max heap size: 80% of RAM)
 1 user-specific feature(s):
 - com.oracle.svm.thirdparty.gson.GsonFeature
------------------------------------------------------------------------------------------------------------------------
Build resources:
 - 9.25GB of memory (30.6% of 30.22GB system memory, determined at start)
 - 24 thread(s) (100.0% of 24 available processor(s), determined at start)
[2/8] Performing analysis...  [*****]                                                                    (2.4s @ 0.29GB)
    3,383 reachable types   (72.2% of    4,685 total)
    3,940 reachable fields  (49.5% of    7,963 total)
   17,139 reachable methods (46.2% of   37,098 total)
    1,075 types,   115 fields, and   685 methods registered for reflection
       58 types,    63 fields, and    52 methods registered for JNI access
       0 foreign downcalls registered
        4 native libraries: dl, pthread, rt, z
[3/8] Building universe...                                                                               (0.7s @ 0.36GB)
[4/8] Parsing methods...      [*]                                                                        (1.0s @ 0.43GB)
[5/8] Inlining methods...     [***]                                                                      (0.1s @ 0.45GB)
[6/8] Compiling methods...    [***]                                                                      (9.0s @ 0.48GB)
[7/8] Layouting methods...    [*]                                                                        (0.9s @ 0.74GB)
[8/8] Creating image...       [*
]                                                                        (0.0s @ 0.86GB)
------------------------------------------------------------------------------------------------------------------------
                       1.3s (7.5% of total time) in 218 GCs | Peak RSS: 1.89GB | CPU load: 16.63
------------------------------------------------------------------------------------------------------------------------
Produced artifacts:
 /home/folkol/code/labs/1brc/java-orig/target/svm_err_b_20251223T151454.430_pid6347.md (build_info)
========================================================================================================================
Failed generating 'CalculateAverage_thomaswue_image' after 16.5s.

The build process encountered an unexpected error:

> java.lang.RuntimeException: There was an error linking the native image: Linker command exited with 1

Based on the linker command output, possible reasons for this include:
1. It appears as though libz:.a is missing. Please install it.

Linker command executed:
/usr/bin/gcc -z noexecstack -Wl,--gc-sections -Wl,--version-script,/tmp/SVM-3461978241100526307/exported_symbols.list -Wl,-x -o /home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image CalculateAverage_thomaswue_image.o /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64/liblibchelper.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libnet.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libnio.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libjava.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libzip.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64/libjvm.a -Wl,--export-dynamic -v -L/tmp/SVM-3461978241100526307 -L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc -L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64 -lz -ldl -lpthread -lrt

Linker command output:
Using built-in specs.
COLLECT_GCC=/usr/bin/gcc
COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-linux-gnu/15/lto-wrapper
OFFLOAD_TARGET_NAMES=nvptx-none:amdgcn-amdhsa
OFFLOAD_TARGET_DEFAULT=1
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Ubuntu 15.2.0-4ubuntu4' --with-bugurl=file:///usr/share/doc/gcc-15/README.Bugs --enable-languages=c,ada,c++,go,d,fortran,objc,obj-c++,m2,rust,cobol,algol68 --prefix=/usr --with-gcc-major-version-only --program-suffix=-15 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/libexec --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-libstdcxx-backtrace --enable-gnu-unique-object --disable-vtable-verify --enable-plugin --enable-default-pie --with-system-zlib --enable-libphobos-checking=release --with-target-system-zlib=auto --enable-objc-gc=auto --enable-multiarch --disable-werror --enable-cet --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none=/build/gcc-15-deiAlw/gcc-15-15.2.0/debian/tmp-nvptx/usr,amdgcn-amdhsa=/build/gcc-15-deiAlw/gcc-15-15.2.0/debian/tmp-gcn/usr --enable-offload-defaulted --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu --with-build-config=bootstrap-lto-lean --enable-link-serialization=2
Thread model: posix
Supported LTO compression algorithms: zlib zstd
gcc version 15.2.0 (Ubuntu 15.2.0-4ubuntu4) 
COMPILER_PATH=/usr/libexec/gcc/x86_64-linux-gnu/15/:/usr/libexec/gcc/x86_64-linux-gnu/15/:/usr/libexec/gcc/x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/15/:/usr/lib/gcc/x86_64-linux-gnu/
LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu/15/:/usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/15/../../../../lib/:/lib/x86_64-linux-gnu/:/lib/../lib/:/usr/lib/x86_64-linux-gnu/:/usr/lib/../lib/:/usr/lib/gcc/x86_64-linux-gnu/15/../../../:/lib/:/usr/lib/
COLLECT_GCC_OPTIONS='-z' 'noexecstack' '-o' '/home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image' '-v' '-L/tmp/SVM-3461978241100526307' '-L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc' '-L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64' '-mtune=generic' '-march=x86-64' '-dumpdir' '/home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image.'
 /usr/libexec/gcc/x86_64-linux-gnu/15/collect2 -plugin /usr/libexec/gcc/x86_64-linux-gnu/15/liblto_plugin.so -plugin-opt=/usr/libexec/gcc/x86_64-linux-gnu/15/lto-wrapper -plugin-opt=-fresolution=/tmp/cci8KkGh.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu --as-needed -dynamic-linker /lib64/ld-linux-x86-64.so.2 -pie -z now -z relro -o /home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image -z noexecstack /usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu/Scrt1.o /usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/15/crtbeginS.o -L/tmp/SVM-3461978241100526307 -L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc -L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64 -L/usr/lib/gcc/x86_64-linux-gnu/15 -L/usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/15/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/15/../../.. -L/lib -L/usr/lib --gc-sections --version-script /tmp/SVM-3461978241100526307/exported_symbols.list -x CalculateAverage_thomaswue_image.o /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64/liblibchelper.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libnet.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libnio.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libjava.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libzip.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64/libjvm.a --export-dynamic -lz -ldl -lpthread -lrt -lgcc --push-state --as-needed -lgcc_s --pop-state -lc -lgcc --push-state --as-needed -lgcc_s --pop-state /usr/lib/gcc/x86_64-linux-gnu/15/crtendS.o /usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu/crtn.o
/usr/bin/ld: cannot find -lz: No such file or directory
collect2: error: ld returned 1 exit status

Please inspect the generated error report at:
/home/folkol/code/labs/1brc/java-orig/target/svm_err_b_20251223T151454.430_pid6347.md

If you are unable to resolve this problem, please file an issue with the error report at:
https://graalvm.org/support

$ sudo apt install zlib1g-dev

$ ./prepare_thomaswue.sh 

Using java version 21.0.2-graal in this shell.
Warning: The option '-H:-GenLoopSafepoints' is experimental and must be enabled via '-H:+UnlockExperimentalVMOptions' in the future.
Warning: Please re-evaluate whether any experimental option is required, and either remove or unlock it. The build output lists all active experimental options, including where they come from and possible alternatives. If you think an experimental option should be considered as stable, please file an issue.
========================================================================================================================
GraalVM Native Image: Generating 'CalculateAverage_thomaswue_image' (executable)...
========================================================================================================================
[1/8] Initializing...                                                                                    (1.4s @ 0.16GB)
 Java version: 21.0.2+13-LTS, vendor version: Oracle GraalVM 21.0.2+13.1
 Graal compiler: optimization level: 3, target machine: native, PGO: ML-inferred
 C compiler: gcc (linux, x86_64, 15.2.0)
 Garbage collector: Epsilon GC (max heap size: 80% of RAM)
 1 user-specific feature(s):
 - com.oracle.svm.thirdparty.gson.GsonFeature
------------------------------------------------------------------------------------------------------------------------
Build resources:
 - 9.18GB of memory (30.4% of 30.22GB system memory, determined at start)
 - 24 thread(s) (100.0% of 24 available processor(s), determined at start)
[2/8] Performing analysis...  [****]                                                                     (2.3s @ 0.31GB)
    3,383 reachable types   (72.2% of    4,685 total)
    3,940 reachable fields  (49.5% of    7,963 total)
   17,139 reachable methods (46.2% of   37,098 total)
    1,075 types,   115 fields, and   685 methods registered for reflection
       58 types,    63 fields, and    52 methods registered for JNI access
       0 foreign downcalls registered
        4 native libraries: dl, pthread, rt, z
[3/8] Building universe...                                                                               (0.7s @ 0.33GB)
[4/8] Parsing methods...      [*]                                                                        (0.9s @ 0.51GB)
[5/8] Inlining methods...     [***]                                                                      (0.1s @ 0.56GB)
[6/8] Compiling methods...    [***]                                                                      (8.9s @ 0.50GB)
[7/8] Layouting methods...    [*]                                                                        (0.9s @ 0.77GB)
[8/8] Creating image...       [*]                                                                        (0.6s @ 0.89GB)
  11.85MB (58.47%) for code area:     7,892 compilation units
   7.70MB (37.99%) for image heap:  106,852 objects and 47 resources
 734.72kB ( 3.54%) for other data
  20.27MB in total
------------------------------------------------------------------------------------------------------------------------
Top 10 origins of code area:                                Top 10 object types in image heap:
   9.03MB java.base                                            2.87MB byte[] for code metadata
   1.57MB svm.jar (Native Image)                               1.31MB byte[] for java.lang.String
 558.37kB com.oracle.svm.svm_enterprise                      780.19kB java.lang.String
 240.60kB java.logging                                       571.82kB java.lang.Class
  65.01kB jdk.proxy3                                         279.11kB byte[] for general heap data
  63.17kB jdk.proxy1                                         240.47kB java.util.HashMap$Node
  60.54kB jdk.internal.vm.compiler                           173.74kB byte[] for reflection metadata
  60.15kB jdk.internal.vm.ci                                 158.58kB com.oracle.svm.core.hub.DynamicHubCompanion
  57.33kB org.graalvm.nativeimage.base                       154.34kB byte[] for embedded resources
  55.16kB average-1.0.0-SNAPSHOT.jar                         145.88kB char[]
  66.33kB for 5 more packages                                  1.07MB for 885 more object types
                              Use '-H:+BuildReport' to create a report with more details.
------------------------------------------------------------------------------------------------------------------------
Security report:
 - Binary includes Java deserialization.
 - Use '--enable-sbom' to embed a Software Bill of Materials (SBOM) in the binary.
------------------------------------------------------------------------------------------------------------------------
Recommendations:
 PGO:  Use Profile-Guided Optimizations ('--pgo') for improved throughput.
 INIT: Adopt '--strict-image-heap' to prepare for the next GraalVM release.
 HEAP: Set max heap for improved and more predictable memory usage.
 QBM:  Use the quick build mode ('-Ob') to speed up builds during development.
------------------------------------------------------------------------------------------------------------------------
                       1.2s (7.1% of total time) in 189 GCs | Peak RSS: 2.80GB | CPU load: 16.97
------------------------------------------------------------------------------------------------------------------------
Produced artifacts:
 /home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image (executable)
========================================================================================================================
Finished generating 'CalculateAverage_thomaswue_image' in 16.1s.

$ time ./calculate_average_thomaswue.sh 
Picking up existing native image 'target/CalculateAverage_thomaswue_image', delete the file to select JVM mode.
{Abha=-33.8/18.0/71.1, Abidjan=-23.6/26.0/77.3, Abéché=-23.2/29.4/78.4, Accra=-24.3/26.4/79.3, Addis Ababa=-34.5/16.0/64.9, Adelaide=-30.2/17.3/71.5, Aden=-20.4/29.1/79.8, Ahvaz=-25.4/25.4/73.8, Albuquerque=-39.2/14.0/66.5, Alexandra=-47.2/11.0/63.2, Alexandria=-31.4/20.0/68.1, Algiers=-32.1/18.2/69.8, Alice Springs=-30.5/21.0/68.0, Almaty=-45.3/10.0/58.1, Amsterdam=-40.1/10.2/59.0, Anadyr=-62.8/-6.9/41.8, Anchorage=-45.2/2.8/50.0, Andorra la Vella=-38.7/9.8/63.8, Ankara=-35.6/12.0/61.5, Antananarivo=-38.7/17.9/66.7, Antsiranana=-26.5/25.2/75.0, Arkhangelsk=-48.3/1.3/50.9, Ashgabat=-31.6/17.1/70.0, Asmara=-32.9/15.6/67.9, Assab=-16.7/30.5/77.9, Astana=-44.6/3.5/55.2, Athens=-31.2/19.2/66.6, Atlanta=-34.2/17.0/64.3, Auckland=-40.5/15.2/63.7, Austin=-30.0/20.7/71.6, Baghdad=-26.6/22.8/73.0, Baguio=-34.7/19.5/73.4, Baku=-42.1/15.1/66.5, Baltimore=-38.4/13.1/61.2, Bamako=-22.5/27.8/75.8, Bangkok=-22.3/28.6/78.2, Bangui=-26.7/26.0/73.9, Banjul=-23.0/26.0/74.9, Barcelona=-32.1/18.2/67.3, Bata=-22.9/25.1/76.3, Batumi=-32.6/14.0/64.5, Beijing=-37.7/12.9/60.8, Beirut=-31.0/20.9/69.9, Belgrade=-41.2/12.5/60.6, Belize City=-23.2/26.7/74.2, Benghazi=-34.4/19.9/67.0, Bergen=-39.9/7.7/55.5, Berlin=-40.4/10.3/67.7, Bilbao=-35.5/14.7/63.6, Birao=-29.1/26.5/77.4, Bishkek=-38.0/11.3/60.3, Bissau=-28.3/27.0/76.4, Blantyre=-25.6/22.2/71.8, Bloemfontein=-37.0/15.6/64.2, Boise=-35.2/11.4/59.5, Bordeaux=-33.0/14.2/66.0, Bosaso=-17.8/30.0/80.3, Boston=-36.8/10.9/71.6, Bouaké=-25.7/26.0/75.6, Bratislava=-39.0/10.5/61.6, Brazzaville=-29.1/25.0/73.2, Bridgetown=-21.9/27.0/76.9, Brisbane=-30.6/21.4/70.6, Brussels=-38.1/10.5/60.0, Bucharest=-42.1/10.8/60.8, Budapest=-41.3/11.3/61.7, Bujumbura=-24.1/23.8/72.8, Bulawayo=-31.9/18.9/74.1, Burnie=-34.0/13.1/63.7, Busan=-36.7/15.0/66.3, Cabo San Lucas=-25.5/23.9/72.3, Cairns=-26.3/25.0/74.1, Cairo=-29.7/21.4/72.6, Calgary=-46.0/4.4/55.7, Canberra=-36.7/13.1/66.9, Cape Town=-31.8/16.2/67.1, Changsha=-34.8/17.4/68.1, Charlotte=-36.6/16.1/66.8, Chiang Mai=-29.7/25.8/72.6, Chicago=-39.6/9.8/62.2, Chihuahua=-30.7/18.6/66.7, Chittagong=-26.0/25.9/82.7, Chișinău=-38.7/10.2/55.8, Chongqing=-33.8/18.6/66.7, Christchurch=-38.4/12.2/61.7, City of San Marino=-37.4/11.8/57.4, Colombo=-23.4/27.4/79.1, Columbus=-35.9/11.7/73.2, Conakry=-23.3/26.4/74.6, Copenhagen=-39.3/9.1/60.7, Cotonou=-21.0/27.2/80.1, Cracow=-44.9/9.3/58.3, Da Lat=-32.6/17.9/65.6, Da Nang=-24.8/25.8/75.6, Dakar=-27.6/24.0/73.8, Dallas=-31.3/19.0/70.2, Damascus=-32.9/17.0/64.2, Dampier=-20.4/26.4/77.5, Dar es Salaam=-25.5/25.8/73.2, Darwin=-26.1/27.6/79.0, Denpasar=-23.6/23.7/74.5, Denver=-39.7/10.4/62.4, Detroit=-43.4/10.0/63.1, Dhaka=-22.1/25.9/78.3, Dikson=-64.9/-11.1/39.5, Dili=-22.8/26.6/78.2, Djibouti=-19.0/29.9/84.4, Dodoma=-25.3/22.7/76.2, Dolisie=-24.4/24.0/76.6, Douala=-21.8/26.7/79.3, Dubai=-20.2/26.9/74.2, Dublin=-45.0/9.8/56.9, Dunedin=-44.3/11.1/63.1, Durban=-28.1/20.6/72.6, Dushanbe=-35.9/14.7/63.6, Edinburgh=-43.6/9.3/64.0, Edmonton=-45.4/4.2/52.4, El Paso=-31.7/18.1/65.7, Entebbe=-32.0/21.0/72.1, Erbil=-27.9/19.5/67.4, Erzurum=-42.6/5.1/55.2, Fairbanks=-49.7/-2.3/49.8, Fianarantsoa=-32.9/17.9/66.1, Flores,  Petén=-23.7/26.4/78.9, Frankfurt=-40.1/10.6/58.2, Fresno=-33.9/17.9/66.0, Fukuoka=-33.0/17.0/68.8, Gaborone=-27.4/21.0/68.8, Gabès=-29.9/19.5/67.4, Gagnoa=-25.9/26.0/74.5, Gangtok=-32.0/15.2/65.4, Garissa=-22.6/29.3/77.9, Garoua=-23.0/28.3/80.1, George Town=-22.0/27.9/80.3, Ghanzi=-25.5/21.4/74.6, Gjoa Haven=-64.0/-14.4/36.1, Guadalajara=-28.5/20.9/70.1, Guangzhou=-26.9/22.4/70.8, Guatemala City=-32.0/20.4/70.9, Halifax=-40.7/7.5/55.2, Hamburg=-38.3/9.7/59.7, Hamilton=-37.7/13.8/62.7, Hanga Roa=-29.0/20.5/71.8, Hanoi=-28.9/23.6/75.7, Harare=-37.7/18.4/71.6, Harbin=-48.2/5.0/60.7, Hargeisa=-26.4/21.7/68.6, Hat Yai=-22.5/27.0/74.9, Havana=-23.4/25.2/77.2, Helsinki=-45.7/5.9/60.0, Heraklion=-40.2/18.9/65.3, Hiroshima=-36.1/16.3/65.6, Ho Chi Minh City=-24.4/27.4/76.3, Hobart=-39.3/12.7/62.3, Hong Kong=-24.8/23.3/73.4, Honiara=-27.1/26.5/76.9, Honolulu=-24.1/25.4/74.2, Houston=-28.6/20.8/77.1, Ifrane=-39.4/11.4/63.2, Indianapolis=-42.1/11.8/64.6, Iqaluit=-56.3/-9.3/41.8, Irkutsk=-50.8/1.0/49.9, Istanbul=-40.4/13.9/61.7, Jacksonville=-30.9/20.3/67.6, Jakarta=-21.4/26.7/74.5, Jayapura=-24.6/27.0/79.6, Jerusalem=-30.4/18.3/70.2, Johannesburg=-34.8/15.5/68.2, Jos=-27.0/22.8/74.9, Juba=-19.9/27.8/78.6, Kabul=-38.6/12.1/60.0, Kampala=-31.5/20.0/67.9, Kandi=-23.4/27.7/79.0, Kankan=-23.2/26.5/81.6, Kano=-27.1/26.4/74.4, Kansas City=-39.3/12.5/62.0, Karachi=-27.1/26.0/75.5, Karonga=-29.7/24.4/70.6, Kathmandu=-34.1/18.3/67.6, Khartoum=-26.2/29.9/77.9, Kingston=-24.3/27.4/81.1, Kinshasa=-22.3/25.3/75.8, Kolkata=-22.0/26.7/79.8, Kuala Lumpur=-22.4/27.3/78.1, Kumasi=-20.9/26.0/76.0, Kunming=-33.5/15.7/69.3, Kuopio=-46.6/3.4/55.9, Kuwait City=-27.2/25.7/75.4, Kyiv=-42.3/8.4/57.5, Kyoto=-32.9/15.8/66.4, La Ceiba=-22.4/26.2/80.0, La Paz=-29.1/23.7/77.9, Lagos=-23.3/26.8/76.5, Lahore=-30.8/24.3/74.6, Lake Havasu City=-27.0/23.7/70.0, Lake Tekapo=-45.1/8.7/56.8, Las Palmas de Gran Canaria=-31.1/21.2/72.2, Las Vegas=-28.6/20.3/69.4, Launceston=-40.0/13.1/65.1, Lhasa=-43.5/7.6/63.7, Libreville=-23.3/25.9/76.1, Lisbon=-34.0/17.5/64.7, Livingstone=-27.7/21.8/72.2, Ljubljana=-42.6/10.9/60.3, Lodwar=-20.6/29.3/76.7, Lomé=-26.5/26.9/76.1, London=-35.9/11.3/59.5, Los Angeles=-34.2/18.6/70.0, Louisville=-36.0/13.9/67.5, Luanda=-26.2/25.8/77.2, Lubumbashi=-27.2/20.8/66.3, Lusaka=-32.0/19.9/70.8, Luxembourg City=-40.8/9.3/61.1, Lviv=-38.6/7.8/59.3, Lyon=-35.0/12.5/57.7, Madrid=-33.2/15.0/63.1, Mahajanga=-26.0/26.3/79.1, Makassar=-22.0/26.7/75.4, Makurdi=-27.2/26.0/81.2, Malabo=-22.2/26.3/77.7, Malé=-20.6/28.0/81.6, Managua=-25.6/27.3/75.2, Manama=-24.6/26.5/74.7, Mandalay=-22.0/28.0/78.6, Mango=-19.7/28.1/80.6, Manila=-20.7/28.4/80.6, Maputo=-25.0/22.8/72.2, Marrakesh=-27.4/19.6/68.8, Marseille=-32.8/15.8/64.9, Maun=-30.5/22.4/73.0, Medan=-26.2/26.5/78.0, Mek'ele=-26.6/22.7/77.8, Melbourne=-46.0/15.1/71.8, Memphis=-35.3/17.2/68.3, Mexicali=-24.8/23.1/75.3, Mexico City=-34.7/17.5/66.8, Miami=-25.3/24.9/73.5, Milan=-34.7/13.0/63.5, Milwaukee=-46.4/8.9/58.4, Minneapolis=-42.0/7.8/56.5, Minsk=-42.8/6.7/55.9, Mogadishu=-27.5/27.1/75.5, Mombasa=-23.1/26.3/72.7, Monaco=-34.4/16.4/65.2, Moncton=-40.1/6.1/59.1, Monterrey=-28.5/22.3/75.7, Montreal=-43.3/6.8/58.5, Moscow=-45.0/5.8/53.6, Mumbai=-19.6/27.1/76.5, Murmansk=-53.3/0.6/50.6, Muscat=-23.0/28.0/80.4, Mzuzu=-32.4/17.7/66.4, N'Djamena=-21.2/28.3/74.8, Naha=-30.1/23.1/74.6, Nairobi=-32.1/17.8/65.2, Nakhon Ratchasima=-24.6/27.3/80.1, Napier=-34.5/14.6/60.2, Napoli=-37.7/15.9/66.2, Nashville=-34.2/15.4/62.5, Nassau=-29.1/24.6/75.7, Ndola=-27.9/20.3/69.4, New Delhi=-30.5/25.0/74.9, New Orleans=-33.1/20.7/77.8, New York City=-37.6/12.9/63.8, Ngaoundéré=-30.2/22.0/75.7, Niamey=-26.6/29.3/79.4, Nicosia=-27.7/19.7/68.8, Niigata=-35.1/13.9/65.4, Nouadhibou=-30.4/21.3/72.7, Nouakchott=-24.9/25.7/73.9, Novosibirsk=-49.9/1.7/54.6, Nuuk=-48.8/-1.4/49.9, Odesa=-38.7/10.7/64.3, Odienné=-24.8/26.0/76.7, Oklahoma City=-31.6/15.9/64.8, Omaha=-39.6/10.6/60.8, Oranjestad=-26.4/28.1/78.1, Oslo=-45.8/5.7/54.8, Ottawa=-42.3/6.6/58.7, Ouagadougou=-20.4/28.3/80.3, Ouahigouya=-18.9/28.6/77.8, Ouarzazate=-30.9/18.9/81.8, Oulu=-45.8/2.7/53.3, Palembang=-20.5/27.3/76.0, Palermo=-35.6/18.5/72.9, Palm Springs=-29.0/24.5/73.2, Palmerston North=-37.8/13.2/63.0, Panama City=-21.2/28.0/77.2, Parakou=-23.3/26.8/77.6, Paris=-41.0/12.3/61.6, Perth=-34.9/18.7/70.0, Petropavlovsk-Kamchatsky=-45.6/1.9/51.1, Philadelphia=-42.3/13.2/64.2, Phnom Penh=-23.5/28.3/80.6, Phoenix=-27.5/23.9/74.1, Pittsburgh=-41.1/10.8/66.7, Podgorica=-36.2/15.3/68.1, Pointe-Noire=-21.2/26.1/76.8, Pontianak=-19.2/27.7/79.8, Port Moresby=-24.0/26.9/74.9, Port Sudan=-19.1/28.4/78.2, Port Vila=-28.2/24.3/71.3, Port-Gentil=-22.6/26.0/81.2, Portland (OR)=-37.2/12.4/64.9, Porto=-34.6/15.7/65.3, Prague=-43.5/8.4/56.4, Praia=-25.1/24.4/73.9, Pretoria=-32.1/18.2/68.7, Pyongyang=-36.5/10.8/62.1, Rabat=-31.8/17.2/65.1, Rangpur=-24.0/24.4/71.3, Reggane=-24.1/28.3/78.0, Reykjavík=-44.0/4.3/54.8, Riga=-46.4/6.2/53.0, Riyadh=-26.5/26.0/75.3, Rome=-37.8/15.2/64.4, Roseau=-22.7/26.2/76.4, Rostov-on-Don=-38.2/9.9/58.8, Sacramento=-37.6/16.3/65.8, Saint Petersburg=-43.3/5.8/53.8, Saint-Pierre=-46.9/5.7/57.1, Salt Lake City=-36.3/11.6/62.2, San Antonio=-28.4/20.8/68.9, San Diego=-30.2/17.8/65.7, San Francisco=-36.1/14.6/63.3, San Jose=-33.5/16.4/66.0, San José=-28.2/22.6/81.0, San Juan=-22.4/27.2/79.3, San Salvador=-27.5/23.1/71.8, Sana'a=-28.6/20.0/70.6, Santo Domingo=-21.4/25.9/78.2, Sapporo=-39.8/8.9/61.5, Sarajevo=-36.3/10.1/59.0, Saskatoon=-45.5/3.3/52.1, Seattle=-34.9/11.3/60.8, Seoul=-34.6/12.5/59.5, Seville=-28.2/19.2/71.0, Shanghai=-37.9/16.7/65.4, Singapore=-24.3/27.0/75.6, Skopje=-37.1/12.4/65.1, Sochi=-41.5/14.2/64.4, Sofia=-38.3/10.6/58.1, Sokoto=-19.5/28.0/76.0, Split=-33.0/16.1/65.9, St. John's=-45.8/5.0/54.4, St. Louis=-38.4/13.9/61.6, Stockholm=-43.3/6.6/61.4, Surabaya=-22.7/27.1/80.4, Suva=-25.5/25.6/75.4, Suwałki=-40.5/7.2/55.1, Sydney=-34.9/17.7/69.5, Ségou=-22.3/28.0/75.5, Tabora=-26.9/23.0/74.5, Tabriz=-35.0/12.6/63.8, Taipei=-28.6/23.0/75.9, Tallinn=-43.8/6.4/56.7, Tamale=-21.5/27.9/78.9, Tamanrasset=-24.9/21.7/73.8, Tampa=-24.2/22.9/72.1, Tashkent=-34.1/14.8/68.4, Tauranga=-34.4/14.8/62.9, Tbilisi=-35.7/12.9/63.7, Tegucigalpa=-29.4/21.7/72.5, Tehran=-31.7/17.0/65.1, Tel Aviv=-32.2/20.0/67.5, Thessaloniki=-35.8/16.0/67.4, Thiès=-28.4/24.0/75.5, Tijuana=-31.2/17.8/71.6, Timbuktu=-20.7/28.0/75.4, Tirana=-34.9/15.2/66.1, Toamasina=-27.0/23.4/72.7, Tokyo=-33.2/15.4/61.9, Toliara=-26.0/24.1/78.0, Toluca=-39.8/12.4/67.9, Toronto=-40.4/9.4/62.2, Tripoli=-28.2/20.0/68.7, Tromsø=-45.0/2.9/54.5, Tucson=-31.0/20.9/71.0, Tunis=-29.8/18.4/68.3, Ulaanbaatar=-50.6/-0.4/47.6, Upington=-27.6/20.4/70.6, Vaduz=-42.2/10.1/59.0, Valencia=-28.5/18.3/71.9, Valletta=-30.3/18.8/68.7, Vancouver=-40.3/10.4/63.5, Veracruz=-21.7/25.4/73.2, Vienna=-42.7/10.4/59.5, Vientiane=-23.7/25.9/73.1, Villahermosa=-20.9/27.1/79.3, Vilnius=-47.1/6.0/55.3, Virginia Beach=-34.2/15.8/69.8, Vladivostok=-43.8/4.9/54.0, Warsaw=-37.1/8.5/60.0, Washington, D.C.=-36.6/14.6/62.5, Wau=-22.2/27.8/76.1, Wellington=-37.5/12.9/64.0, Whitehorse=-49.8/-0.1/59.8, Wichita=-34.0/13.9/65.8, Willemstad=-29.4/28.0/78.5, Winnipeg=-47.4/3.0/55.2, Wrocław=-37.7/9.6/60.3, Xi'an=-37.1/14.1/62.4, Yakutsk=-61.5/-8.8/39.4, Yangon=-20.8/27.5/78.5, Yaoundé=-25.4/23.8/74.6, Yellowknife=-58.3/-4.3/44.8, Yerevan=-35.5/12.4/70.4, Yinchuan=-47.9/9.0/61.2, Zagreb=-41.8/10.7/60.5, Zanzibar City=-21.8/26.0/78.9, Zürich=-41.5/9.3/59.8, Ürümqi=-40.6/7.4/58.6, İzmir=-29.6/17.9/71.1}

real	0m0.216s
user	0m0.001s
sys	0m0.003s

>> Trying latest graal as well for comparison

$ sdk install java 26.ea.13-graal

>> 15 min later... had to remove a lot of contributions that did not build with this ea(!) graal release. Changed graal version in the ./prepare script and changed compiler version in the pom.xml

No difference :)

(Tried 25 and 24 as well, no difference. But I had to use -H:+ForeignAPISupport with 24...)

## So, what does it do?

/**
 * The solution starts a child worker process for the actual work such that clean up of the memory mapping can occur
 * while the main process already returns with the result. The worker then memory maps the input file, creates a worker
 * thread per available core, and then processes segments of size {@link #SEGMENT_SIZE} at a time. The segments are
 * split into 3 parts and cursors for each of those parts are processing the segment simultaneously in the same thread.
 * Results are accumulated into {@link Result} objects and a tree map is used to sequentially accumulate the results in
 * the end.
 * Runs in 0.31 on an Intel i9-13900K while the reference implementation takes 120.37s.
 * Credit:
 *  Quan Anh Mai for branchless number parsing code
 *  Alfonso² Peterssen for suggesting memory mapping with unsafe and the subprocess idea
 *  Artsiom Korzun for showing the benefits of work stealing at 2MB segments instead of equal split between workers
 *  Jaromir Hamala for showing that avoiding the branch misprediction between <8 and 8-16 cases is a big win even if
 *  more work is performed
 *  Van Phu DO for demonstrating the lookup tables based on masks instead of bit shifting
 */
public class CalculateAverage_thomaswue {

Try with different core counts (0-7 are P cores)

$ for c in /sys/devices/system/cpu/cpu*/topology/cluster_cpus_list; do   echo "$c: $(cat $c)"; done | sort -V
/sys/devices/system/cpu/cpu0/topology/cluster_cpus_list: 0
/sys/devices/system/cpu/cpu1/topology/cluster_cpus_list: 1
/sys/devices/system/cpu/cpu2/topology/cluster_cpus_list: 2
/sys/devices/system/cpu/cpu3/topology/cluster_cpus_list: 3
/sys/devices/system/cpu/cpu4/topology/cluster_cpus_list: 4
/sys/devices/system/cpu/cpu5/topology/cluster_cpus_list: 5
/sys/devices/system/cpu/cpu6/topology/cluster_cpus_list: 6
/sys/devices/system/cpu/cpu7/topology/cluster_cpus_list: 7
/sys/devices/system/cpu/cpu8/topology/cluster_cpus_list: 8-11
/sys/devices/system/cpu/cpu9/topology/cluster_cpus_list: 8-11
/sys/devices/system/cpu/cpu10/topology/cluster_cpus_list: 8-11
/sys/devices/system/cpu/cpu11/topology/cluster_cpus_list: 8-11
/sys/devices/system/cpu/cpu12/topology/cluster_cpus_list: 12-15
/sys/devices/system/cpu/cpu13/topology/cluster_cpus_list: 12-15
/sys/devices/system/cpu/cpu14/topology/cluster_cpus_list: 12-15
/sys/devices/system/cpu/cpu15/topology/cluster_cpus_list: 12-15
/sys/devices/system/cpu/cpu16/topology/cluster_cpus_list: 16-19
/sys/devices/system/cpu/cpu17/topology/cluster_cpus_list: 16-19
/sys/devices/system/cpu/cpu18/topology/cluster_cpus_list: 16-19
/sys/devices/system/cpu/cpu19/topology/cluster_cpus_list: 16-19
/sys/devices/system/cpu/cpu20/topology/cluster_cpus_list: 20-23
/sys/devices/system/cpu/cpu21/topology/cluster_cpus_list: 20-23
/sys/devices/system/cpu/cpu22/topology/cluster_cpus_list: 20-23
/sys/devices/system/cpu/cpu23/topology/cluster_cpus_list: 20-23


$ git diff
diff --git a/calculate_average_thomaswue.sh b/calculate_average_thomaswue.sh
index 58c6701..caf97e5 100755
--- a/calculate_average_thomaswue.sh
+++ b/calculate_average_thomaswue.sh
@@ -21,6 +21,6 @@ if [ -f target/CalculateAverage_thomaswue_image ]; then
 else
     JAVA_OPTS="--enable-preview"
     echo "Chosing to run the app in JVM mode as no native image was found, use prepare_thomaswue.sh to generate." 1>&2
-    java $JAVA_OPTS --class-path target/average-1.0.0-SNAPSHOT.jar dev.morling.onebrc.CalculateAverage_thomaswue
+    java $JAVA_OPTS $NUM_PROCS --class-path target/average-1.0.0-SNAPSHOT.jar dev.morling.onebrc.CalculateAverage_thomaswue
 fi

$ for n in {1..40}; do { echo "n: $n" >&2; /usr/bin/time -f '%e' sudo systemd-run --quiet --scope -p CPUQuota=$((n * 100))% target/CalculateAverage_thomaswue_image >/dev/null; } ; done |& sed 's/n: //' | xargs -L2 | uplot bar -d ' ' -w 80
      ┌                                                                                ┐ 
    1 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 4.16   
    2 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 2.22                                      
    3 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■ 1.51                                                  
    4 ┤■■■■■■■■■■■■■■■■■■■■■ 1.16                                                        
    5 ┤■■■■■■■■■■■■■■■■■ 0.93                                                            
    6 ┤■■■■■■■■■■■■■■ 0.78                                                               
    7 ┤■■■■■■■■■■■■ 0.69                                                                 
    8 ┤■■■■■■■■■■■ 0.61                                                                  
    9 ┤■■■■■■■■■■ 0.55                                                                   
   10 ┤■■■■■■■■■ 0.5                                                                     
   11 ┤■■■■■■■■ 0.45                                                                     
   12 ┤■■■■■■■ 0.41                                                                      
   13 ┤■■■■■■■ 0.39                                                                      
   14 ┤■■■■■■ 0.36                                                                       
   15 ┤■■■■■■ 0.35                                                                       
   16 ┤■■■■■■ 0.32                                                                       
   17 ┤■■■■■ 0.3                                                                         
   18 ┤■■■■■ 0.28                                                                        
   19 ┤■■■■■ 0.28                                                                        
   20 ┤■■■■■ 0.27                                                                        
   21 ┤■■■■■ 0.26                                                                        
   22 ┤■■■■ 0.24                                                                         
   23 ┤■■■■ 0.23                                                                         
   24 ┤■■■■ 0.22                                                                         
   25 ┤■■■■ 0.24                                                                         
   26 ┤■■■■ 0.23                                                                         
   27 ┤■■■■ 0.23                                                                         
   28 ┤■■■■ 0.23                                                                         
   29 ┤■■■■ 0.23                                                                         
   30 ┤■■■■ 0.24                                                                         
   31 ┤■■■■ 0.23                                                                         
   32 ┤■■■■ 0.24                                                                         
   33 ┤■■■■ 0.24                                                                         
   34 ┤■■■■ 0.25                                                                         
   35 ┤■■■■ 0.23                                                                         
   36 ┤■■■■ 0.22                                                                         
   37 ┤■■■■ 0.25                                                                         
   38 ┤■■■■ 0.24                                                                         
   39 ┤■■■■ 0.23                                                                         
   40 ┤■■■■ 0.23                                                                         
      └           

Same, but without native image (cold-start jvm etc):

$ for n in {1..40}; do { echo "n: $n" >&2; /usr/bin/time -f '%e' sudo systemd-run --quiet --scope -p CPUQuota=$((n * 100))% /home/folkol/.sdkman/candidates/java/21.0.2-graal/bin/java --enable-preview --class-path target/average-1.0.0-SNAPSHOT.jar dev.morling.onebrc.CalculateAverage_thomaswue >/dev/null; } ; done |& sed 's/n: //' | xargs -L2 | uplot bar -d ' ' -w 80
      ┌                                                                                ┐ 
    1 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 14.39   
    2 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 8.72                                 
    3 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■ 5.03                                                   
    4 ┤■■■■■■■■■■■■■■■■■■ 3.61                                                           
    5 ┤■■■■■■■■■■■■■■■■ 3.19                                                             
    6 ┤■■■■■■■■■■■■■■ 2.75                                                               
    7 ┤■■■■■■■■■■■■■■ 2.73                                                               
    8 ┤■■■■■■■■■■■ 2.2                                                                   
    9 ┤■■■■■■■■■■■ 2.09                                                                  
   10 ┤■■■■■■■■■ 1.84                                                                    
   11 ┤■■■■■■■■■ 1.8                                                                     
   12 ┤■■■■■■■■ 1.62                                                                     
   13 ┤■■■■■■■ 1.38                                                                      
   14 ┤■■■■■■■ 1.35                                                                      
   15 ┤■■■■■■ 1.15                                                                       
   16 ┤■■■■■■ 1.24                                                                       
   17 ┤■■■■■■ 1.27                                                                       
   18 ┤■■■■■■ 1.14                                                                       
   19 ┤■■■■■ 1.02                                                                        
   20 ┤■■■■■■ 1.14                                                                       
   21 ┤■■■■■ 1.08                                                                        
   22 ┤■■■■■ 0.94                                                                        
   23 ┤■■■■■ 1.05                                                                        
   24 ┤■■■■■ 1.06                                                                        
   25 ┤■■■■■ 0.98                                                                        
   26 ┤■■■■■ 0.99                                                                        
   27 ┤■■■■■ 0.96                                                                        
   28 ┤■■■■ 0.88                                                                         
   29 ┤■■■■■ 0.91                                                                        
   30 ┤■■■■■ 0.92                                                                        
   31 ┤■■■■■ 0.94                                                                        
   32 ┤■■■■■ 0.97                                                                        
   33 ┤■■■■■ 0.94                                                                        
   34 ┤■■■■■ 0.97                                                                        
   35 ┤■■■■■ 0.95                                                                        
   36 ┤■■■■■ 0.94                                                                        
   37 ┤■■■■■ 1.02                                                                        
   38 ┤■■■■■ 0.97                                                                        
   39 ┤■■■■■ 0.99                                                                        
   40 ┤■■■■■ 1.03                                                                        
      └             

## Baseline Rust iteration

Single threaded, naive / straight forward unwrapful 'lines' scanner.

use std::collections::BTreeMap;
use std::io::BufRead;

struct Stats {
    min: f64,
    sum: f64,
    count: usize,
    max: f64,
}

impl Stats {
    fn update(&mut self, temp: f64) {
        self.min = self.min.min(temp);
        self.max = self.max.max(temp);
        self.sum += temp;
        self.count += 1;
    }
}

impl Default for Stats {
    fn default() -> Self {
        Self {
            min: f64::MAX,
            sum: 0.0,
            count: 0,
            max: f64::MIN,
        }
    }
}

fn main() {
    let file = std::fs::File::open("../java-orig/measurements.txt").unwrap();
    let reader = std::io::BufReader::new(file);
    let mut stats: BTreeMap<String, Stats> = Default::default();

    for line in reader.lines() {
        let line = line.unwrap();
        let (station, temp) = line.split_once(';').unwrap();
        let temp: f64 = temp.parse().unwrap();

        stats.entry(station.to_string()).or_default().update(temp);
    }

    print!("{{");
    let num_stations = stats.len();
    for (i, (station, stats)) in stats.iter().enumerate() {
        print!(
            "{station}={:.1}/{:.1}/{:.1}",
            stats.min,
            stats.sum / stats.count as f64,
            stats.max
        );
        if i != num_stations - 1 {
            print!(", ");
        }
    }
    println!("}}");
}

folkol@ubuntu:~/code/labs/1brc/onebrc$ time cargo run --release >output.txt
   Compiling onebrc v0.1.0 (/home/folkol/code/labs/1brc/onebrc)
    Finished `release` profile [optimized] target(s) in 0.12s
     Running `target/release/onebrc`

real	1m32.937s
user	1m32.094s
sys	0m0.946s
folkol@ubuntu:~/code/labs/1brc/onebrc$ git diff --no-index --word-diff output.txt ../expected.txt 
folkol@ubuntu:~/code/labs/1brc/onebrc$ 

Produces the same result at least.

## Where do we spend our time?

Add debug = true to profile.release in Cargo.toml

$ sudo sysctl -w kernel.perf_event_paranoid=1
kernel.perf_event_paranoid = 1
$ sudo sysctl -w kernel.kptr_restrict=0
kernel.kptr_restrict = 0

>> optionally: sudo cpupower frequency-set -g performance

https://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html

$ perf record -F 999 -g --call-graph dwarf ./target/release/onebrc
$ perf report --stdio
$ git clone https://github.com/brendangregg/FlameGraph
$ perf script | FlameGraph/stackcollapse-perf.pl > out.perf-folded
$ FlameGraph/flamegraph.pl ./out.perf-folded >perf.svg
$ open perf.svg 

### Partition the file

- find partition boundaries by scanning for newlines at total_size / num_partitions
- also add some threading scaffolding so that we can run this on multiple cores
- the join code will wait for threads in spawn-order, but let's go with this
- (The java code used mmaps, but I'll stick with .lines() for now)

folkol@ubuntu:~/code/labs/1brc/onebrc$ time ./target/release/onebrc 
{Abha=-33.8/18.0/71.1, Abidjan=-23.6/26.0/77.3, Abéché=-23.2/29.4/78.4, Accra=-24.3/26.4/79.3, Addis Ababa=-34.5/16.0/64.9, Adelaide=-30.2/17.3/71.5, Aden=-20.4/29.1/79.8, Ahvaz=-25.4/25.4/73.8, Albuquerque=-39.2/14.0/66.5, Alexandra=-47.2/11.0/63.2, Alexandria=-31.4/20.0/68.1, Algiers=-32.1/18.2/69.8, Alice Springs=-30.5/21.0/68.0, Almaty=-45.3/10.0/58.1, Amsterdam=-40.1/10.2/59.0, Anadyr=-62.8/-6.9/41.8, Anchorage=-45.2/2.8/50.0, Andorra la Vella=-38.7/9.8/63.8, Ankara=-35.6/12.0/61.5, Antananarivo=-38.7/17.9/66.7, Antsiranana=-26.5/25.2/75.0, Arkhangelsk=-48.3/1.3/50.9, Ashgabat=-31.6/17.1/70.0, Asmara=-32.9/15.6/67.9, Assab=-16.7/30.5/77.9, Astana=-44.6/3.5/55.2, Athens=-31.2/19.2/66.6, Atlanta=-34.2/17.0/64.3, Auckland=-40.5/15.2/63.7, Austin=-30.0/20.7/71.6, Baghdad=-26.6/22.8/73.0, Baguio=-34.7/19.5/73.4, Baku=-42.1/15.1/66.5, Baltimore=-38.4/13.1/61.2, Bamako=-22.5/27.8/75.8, Bangkok=-22.3/28.6/78.2, Bangui=-26.7/26.0/73.9, Banjul=-23.0/26.0/74.9, Barcelona=-32.1/18.2/67.3, Bata=-22.9/25.1/76.3, Batumi=-32.6/14.0/64.5, Beijing=-37.7/12.9/60.8, Beirut=-31.0/20.9/69.9, Belgrade=-41.2/12.5/60.6, Belize City=-23.2/26.7/74.2, Benghazi=-34.4/19.9/67.0, Bergen=-39.9/7.7/55.5, Berlin=-40.4/10.3/67.7, Bilbao=-35.5/14.7/63.6, Birao=-29.1/26.5/77.4, Bishkek=-38.0/11.3/60.3, Bissau=-28.3/27.0/76.4, Blantyre=-25.6/22.2/71.8, Bloemfontein=-37.0/15.6/64.2, Boise=-35.2/11.4/59.5, Bordeaux=-33.0/14.2/66.0, Bosaso=-17.8/30.0/80.3, Boston=-36.8/10.9/71.6, Bouaké=-25.7/26.0/75.6, Bratislava=-39.0/10.5/61.6, Brazzaville=-29.1/25.0/73.2, Bridgetown=-21.9/27.0/76.9, Brisbane=-30.6/21.4/70.6, Brussels=-38.1/10.5/60.0, Bucharest=-42.1/10.8/60.8, Budapest=-41.3/11.3/61.7, Bujumbura=-24.1/23.8/72.8, Bulawayo=-31.9/18.9/74.1, Burnie=-34.0/13.1/63.7, Busan=-36.7/15.0/66.3, Cabo San Lucas=-25.5/23.9/72.3, Cairns=-26.3/25.0/74.1, Cairo=-29.7/21.4/72.6, Calgary=-46.0/4.4/55.7, Canberra=-36.7/13.1/66.9, Cape Town=-31.8/16.2/67.1, Changsha=-34.8/17.4/68.1, Charlotte=-36.6/16.1/66.8, Chiang Mai=-29.7/25.8/72.6, Chicago=-39.6/9.8/62.2, Chihuahua=-30.7/18.6/66.7, Chittagong=-26.0/25.9/82.7, Chișinău=-38.7/10.2/55.8, Chongqing=-33.8/18.6/66.7, Christchurch=-38.4/12.2/61.7, City of San Marino=-37.4/11.8/57.4, Colombo=-23.4/27.4/79.1, Columbus=-35.9/11.7/73.2, Conakry=-23.3/26.4/74.6, Copenhagen=-39.3/9.1/60.7, Cotonou=-21.0/27.2/80.1, Cracow=-44.9/9.3/58.3, Da Lat=-32.6/17.9/65.6, Da Nang=-24.8/25.8/75.6, Dakar=-27.6/24.0/73.8, Dallas=-31.3/19.0/70.2, Damascus=-32.9/17.0/64.2, Dampier=-20.4/26.4/77.5, Dar es Salaam=-25.5/25.8/73.2, Darwin=-26.1/27.6/79.0, Denpasar=-23.6/23.7/74.5, Denver=-39.7/10.4/62.4, Detroit=-43.4/10.0/63.1, Dhaka=-22.1/25.9/78.3, Dikson=-64.9/-11.1/39.5, Dili=-22.8/26.6/78.2, Djibouti=-19.0/29.9/84.4, Dodoma=-25.3/22.7/76.2, Dolisie=-24.4/24.0/76.6, Douala=-21.8/26.7/79.3, Dubai=-20.2/26.9/74.2, Dublin=-45.0/9.8/56.9, Dunedin=-44.3/11.1/63.1, Durban=-28.1/20.6/72.6, Dushanbe=-35.9/14.7/63.6, Edinburgh=-43.6/9.3/64.0, Edmonton=-45.4/4.2/52.4, El Paso=-31.7/18.1/65.7, Entebbe=-32.0/21.0/72.1, Erbil=-27.9/19.5/67.4, Erzurum=-42.6/5.1/55.2, Fairbanks=-49.7/-2.3/49.8, Fianarantsoa=-32.9/17.9/66.1, Flores,  Petén=-23.7/26.4/78.9, Frankfurt=-40.1/10.6/58.2, Fresno=-33.9/17.9/66.0, Fukuoka=-33.0/17.0/68.8, Gaborone=-27.4/21.0/68.8, Gabès=-29.9/19.5/67.4, Gagnoa=-25.9/26.0/74.5, Gangtok=-32.0/15.2/65.4, Garissa=-22.6/29.3/77.9, Garoua=-23.0/28.3/80.1, George Town=-22.0/27.9/80.3, Ghanzi=-25.5/21.4/74.6, Gjoa Haven=-64.0/-14.4/36.1, Guadalajara=-28.5/20.9/70.1, Guangzhou=-26.9/22.4/70.8, Guatemala City=-32.0/20.4/70.9, Halifax=-40.7/7.5/55.2, Hamburg=-38.3/9.7/59.7, Hamilton=-37.7/13.8/62.7, Hanga Roa=-29.0/20.5/71.8, Hanoi=-28.9/23.6/75.7, Harare=-37.7/18.4/71.6, Harbin=-48.2/5.0/60.7, Hargeisa=-26.4/21.7/68.6, Hat Yai=-22.5/27.0/74.9, Havana=-23.4/25.2/77.2, Helsinki=-45.7/5.9/60.0, Heraklion=-40.2/18.9/65.3, Hiroshima=-36.1/16.3/65.6, Ho Chi Minh City=-24.4/27.4/76.3, Hobart=-39.3/12.7/62.3, Hong Kong=-24.8/23.3/73.4, Honiara=-27.1/26.5/76.9, Honolulu=-24.1/25.4/74.2, Houston=-28.6/20.8/77.1, Ifrane=-39.4/11.4/63.2, Indianapolis=-42.1/11.8/64.6, Iqaluit=-56.3/-9.3/41.8, Irkutsk=-50.8/1.0/49.9, Istanbul=-40.4/13.9/61.7, Jacksonville=-30.9/20.3/67.6, Jakarta=-21.4/26.7/74.5, Jayapura=-24.6/27.0/79.6, Jerusalem=-30.4/18.3/70.2, Johannesburg=-34.8/15.5/68.2, Jos=-27.0/22.8/74.9, Juba=-19.9/27.8/78.6, Kabul=-38.6/12.1/60.0, Kampala=-31.5/20.0/67.9, Kandi=-23.4/27.7/79.0, Kankan=-23.2/26.5/81.6, Kano=-27.1/26.4/74.4, Kansas City=-39.3/12.5/62.0, Karachi=-27.1/26.0/75.5, Karonga=-29.7/24.4/70.6, Kathmandu=-34.1/18.3/67.6, Khartoum=-26.2/29.9/77.9, Kingston=-24.3/27.4/81.1, Kinshasa=-22.3/25.3/75.8, Kolkata=-22.0/26.7/79.8, Kuala Lumpur=-22.4/27.3/78.1, Kumasi=-20.9/26.0/76.0, Kunming=-33.5/15.7/69.3, Kuopio=-46.6/3.4/55.9, Kuwait City=-27.2/25.7/75.4, Kyiv=-42.3/8.4/57.5, Kyoto=-32.9/15.8/66.4, La Ceiba=-22.4/26.2/80.0, La Paz=-29.1/23.7/77.9, Lagos=-23.3/26.8/76.5, Lahore=-30.8/24.3/74.6, Lake Havasu City=-27.0/23.7/70.0, Lake Tekapo=-45.1/8.7/56.8, Las Palmas de Gran Canaria=-31.1/21.2/72.2, Las Vegas=-28.6/20.3/69.4, Launceston=-40.0/13.1/65.1, Lhasa=-43.5/7.6/63.7, Libreville=-23.3/25.9/76.1, Lisbon=-34.0/17.5/64.7, Livingstone=-27.7/21.8/72.2, Ljubljana=-42.6/10.9/60.3, Lodwar=-20.6/29.3/76.7, Lomé=-26.5/26.9/76.1, London=-35.9/11.3/59.5, Los Angeles=-34.2/18.6/70.0, Louisville=-36.0/13.9/67.5, Luanda=-26.2/25.8/77.2, Lubumbashi=-27.2/20.8/66.3, Lusaka=-32.0/19.9/70.8, Luxembourg City=-40.8/9.3/61.1, Lviv=-38.6/7.8/59.3, Lyon=-35.0/12.5/57.7, Madrid=-33.2/15.0/63.1, Mahajanga=-26.0/26.3/79.1, Makassar=-22.0/26.7/75.4, Makurdi=-27.2/26.0/81.2, Malabo=-22.2/26.3/77.7, Malé=-20.6/28.0/81.6, Managua=-25.6/27.3/75.2, Manama=-24.6/26.5/74.7, Mandalay=-22.0/28.0/78.6, Mango=-19.7/28.1/80.6, Manila=-20.7/28.4/80.6, Maputo=-25.0/22.8/72.2, Marrakesh=-27.4/19.6/68.8, Marseille=-32.8/15.8/64.9, Maun=-30.5/22.4/73.0, Medan=-26.2/26.5/78.0, Mek'ele=-26.6/22.7/77.8, Melbourne=-46.0/15.1/71.8, Memphis=-35.3/17.2/68.3, Mexicali=-24.8/23.1/75.3, Mexico City=-34.7/17.5/66.8, Miami=-25.3/24.9/73.5, Milan=-34.7/13.0/63.5, Milwaukee=-46.4/8.9/58.4, Minneapolis=-42.0/7.8/56.5, Minsk=-42.8/6.7/55.9, Mogadishu=-27.5/27.1/75.5, Mombasa=-23.1/26.3/72.7, Monaco=-34.4/16.4/65.2, Moncton=-40.1/6.1/59.1, Monterrey=-28.5/22.3/75.7, Montreal=-43.3/6.8/58.5, Moscow=-45.0/5.8/53.6, Mumbai=-19.6/27.1/76.5, Murmansk=-53.3/0.6/50.6, Muscat=-23.0/28.0/80.4, Mzuzu=-32.4/17.7/66.4, N'Djamena=-21.2/28.3/74.8, Naha=-30.1/23.1/74.6, Nairobi=-32.1/17.8/65.2, Nakhon Ratchasima=-24.6/27.3/80.1, Napier=-34.5/14.6/60.2, Napoli=-37.7/15.9/66.2, Nashville=-34.2/15.4/62.5, Nassau=-29.1/24.6/75.7, Ndola=-27.9/20.3/69.4, New Delhi=-30.5/25.0/74.9, New Orleans=-33.1/20.7/77.8, New York City=-37.6/12.9/63.8, Ngaoundéré=-30.2/22.0/75.7, Niamey=-26.6/29.3/79.4, Nicosia=-27.7/19.7/68.8, Niigata=-35.1/13.9/65.4, Nouadhibou=-30.4/21.3/72.7, Nouakchott=-24.9/25.7/73.9, Novosibirsk=-49.9/1.7/54.6, Nuuk=-48.8/-1.4/49.9, Odesa=-38.7/10.7/64.3, Odienné=-24.8/26.0/76.7, Oklahoma City=-31.6/15.9/64.8, Omaha=-39.6/10.6/60.8, Oranjestad=-26.4/28.1/78.1, Oslo=-45.8/5.7/54.8, Ottawa=-42.3/6.6/58.7, Ouagadougou=-20.4/28.3/80.3, Ouahigouya=-18.9/28.6/77.8, Ouarzazate=-30.9/18.9/81.8, Oulu=-45.8/2.7/53.3, Palembang=-20.5/27.3/76.0, Palermo=-35.6/18.5/72.9, Palm Springs=-29.0/24.5/73.2, Palmerston North=-37.8/13.2/63.0, Panama City=-21.2/28.0/77.2, Parakou=-23.3/26.8/77.6, Paris=-41.0/12.3/61.6, Perth=-34.9/18.7/70.0, Petropavlovsk-Kamchatsky=-45.6/1.9/51.1, Philadelphia=-42.3/13.2/64.2, Phnom Penh=-23.5/28.3/80.6, Phoenix=-27.5/23.9/74.1, Pittsburgh=-41.1/10.8/66.7, Podgorica=-36.2/15.3/68.1, Pointe-Noire=-21.2/26.1/76.8, Pontianak=-19.2/27.7/79.8, Port Moresby=-24.0/26.9/74.9, Port Sudan=-19.1/28.4/78.2, Port Vila=-28.2/24.3/71.3, Port-Gentil=-22.6/26.0/81.2, Portland (OR)=-37.2/12.4/64.9, Porto=-34.6/15.7/65.3, Prague=-43.5/8.4/56.4, Praia=-25.1/24.4/73.9, Pretoria=-32.1/18.2/68.7, Pyongyang=-36.5/10.8/62.1, Rabat=-31.8/17.2/65.1, Rangpur=-24.0/24.4/71.3, Reggane=-24.1/28.3/78.0, Reykjavík=-44.0/4.3/54.8, Riga=-46.4/6.2/53.0, Riyadh=-26.5/26.0/75.3, Rome=-37.8/15.2/64.4, Roseau=-22.7/26.2/76.4, Rostov-on-Don=-38.2/9.9/58.8, Sacramento=-37.6/16.3/65.8, Saint Petersburg=-43.3/5.8/53.8, Saint-Pierre=-46.9/5.7/57.1, Salt Lake City=-36.3/11.6/62.2, San Antonio=-28.4/20.8/68.9, San Diego=-30.2/17.8/65.7, San Francisco=-36.1/14.6/63.3, San Jose=-33.5/16.4/66.0, San José=-28.2/22.6/81.0, San Juan=-22.4/27.2/79.3, San Salvador=-27.5/23.1/71.8, Sana'a=-28.6/20.0/70.6, Santo Domingo=-21.4/25.9/78.2, Sapporo=-39.8/8.9/61.5, Sarajevo=-36.3/10.1/59.0, Saskatoon=-45.5/3.3/52.1, Seattle=-34.9/11.3/60.8, Seoul=-34.6/12.5/59.5, Seville=-28.2/19.2/71.0, Shanghai=-37.9/16.7/65.4, Singapore=-24.3/27.0/75.6, Skopje=-37.1/12.4/65.1, Sochi=-41.5/14.2/64.4, Sofia=-38.3/10.6/58.1, Sokoto=-19.5/28.0/76.0, Split=-33.0/16.1/65.9, St. John's=-45.8/5.0/54.4, St. Louis=-38.4/13.9/61.6, Stockholm=-43.3/6.6/61.4, Surabaya=-22.7/27.1/80.4, Suva=-25.5/25.6/75.4, Suwałki=-40.5/7.2/55.1, Sydney=-34.9/17.7/69.5, Ségou=-22.3/28.0/75.5, Tabora=-26.9/23.0/74.5, Tabriz=-35.0/12.6/63.8, Taipei=-28.6/23.0/75.9, Tallinn=-43.8/6.4/56.7, Tamale=-21.5/27.9/78.9, Tamanrasset=-24.9/21.7/73.8, Tampa=-24.2/22.9/72.1, Tashkent=-34.1/14.8/68.4, Tauranga=-34.4/14.8/62.9, Tbilisi=-35.7/12.9/63.7, Tegucigalpa=-29.4/21.7/72.5, Tehran=-31.7/17.0/65.1, Tel Aviv=-32.2/20.0/67.5, Thessaloniki=-35.8/16.0/67.4, Thiès=-28.4/24.0/75.5, Tijuana=-31.2/17.8/71.6, Timbuktu=-20.7/28.0/75.4, Tirana=-34.9/15.2/66.1, Toamasina=-27.0/23.4/72.7, Tokyo=-33.2/15.4/61.9, Toliara=-26.0/24.1/78.0, Toluca=-39.8/12.4/67.9, Toronto=-40.4/9.4/62.2, Tripoli=-28.2/20.0/68.7, Tromsø=-45.0/2.9/54.5, Tucson=-31.0/20.9/71.0, Tunis=-29.8/18.4/68.3, Ulaanbaatar=-50.6/-0.4/47.6, Upington=-27.6/20.4/70.6, Vaduz=-42.2/10.1/59.0, Valencia=-28.5/18.3/71.9, Valletta=-30.3/18.8/68.7, Vancouver=-40.3/10.4/63.5, Veracruz=-21.7/25.4/73.2, Vienna=-42.7/10.4/59.5, Vientiane=-23.7/25.9/73.1, Villahermosa=-20.9/27.1/79.3, Vilnius=-47.1/6.0/55.3, Virginia Beach=-34.2/15.8/69.8, Vladivostok=-43.8/4.9/54.0, Warsaw=-37.1/8.5/60.0, Washington, D.C.=-36.6/14.6/62.5, Wau=-22.2/27.8/76.1, Wellington=-37.5/12.9/64.0, Whitehorse=-49.8/-0.1/59.8, Wichita=-34.0/13.9/65.8, Willemstad=-29.4/28.0/78.5, Winnipeg=-47.4/3.0/55.2, Wrocław=-37.7/9.6/60.3, Xi'an=-37.1/14.1/62.4, Yakutsk=-61.5/-8.8/39.4, Yangon=-20.8/27.5/78.5, Yaoundé=-25.4/23.8/74.6, Yellowknife=-58.3/-4.3/44.8, Yerevan=-35.5/12.4/70.4, Yinchuan=-47.9/9.0/61.2, Zagreb=-41.8/10.7/60.5, Zanzibar City=-21.8/26.0/78.9, Zürich=-41.5/9.3/59.8, Ürümqi=-40.6/7.4/58.6, İzmir=-29.6/17.9/71.1}

real	0m4.573s
user	1m41.831s
sys	0m1.116s


#### BTreeMap -> HashMap

We spend most of the time scanning the BTreeMap, so let's replace it with a HashMap in the threads and keep the BTreeMap in main for ordering.

Down to ~3 s:

$ git checkout 1f1d9e
Note: switching to '1f1d9e'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by switching back to a branch.

$ cargo build --release (and change so that we use the full measurements.txt)
$ cp ./target/release/onebrc onebrc_btreemap
$ git checkout -

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ./onebrc_btreemap target/release/onebrc
Benchmark 1: ./onebrc_btreemap
  Time (mean ± σ):      4.687 s ±  0.113 s    [User: 102.803 s, System: 1.109 s]
  Range (min … max):    4.524 s …  4.874 s    10 runs
 
Benchmark 2: target/release/onebrc
  Time (mean ± σ):      3.114 s ±  0.140 s    [User: 62.200 s, System: 1.130 s]
  Range (min … max):    2.945 s …  3.363 s    10 runs
 
Summary
  target/release/onebrc ran
    1.51 ± 0.08 times faster than ./onebrc_btreemap

##### How heavy is the BTreeMap in main?

Compare the BTreeMap solution with a HashMap + sort in main:

diff --git a/1brc/onebrc/src/main.rs b/1brc/onebrc/src/main.rs
index 445e17e..36f0cba 100644
--- a/1brc/onebrc/src/main.rs
+++ b/1brc/onebrc/src/main.rs
@@ -40,7 +40,7 @@ impl Default for Stats {
 fn main() {
     let file_path = "../java-orig/measurements.txt";
     // let file_path = "/tmp/measurements_smol.txt";
-    let mut stats: BTreeMap<String, Stats> = Default::default();
+    let mut stats: HashMap<String, Stats> = Default::default();
 
     let num_shards = thread::available_parallelism().unwrap().get();
     let file = File::open(file_path).unwrap();
@@ -99,16 +99,18 @@ fn handle_shard(mut file: &File, begin: u64, end: u64) -> HashMap<String, Stats>
     stats
 }
 
-fn merge(total: &mut BTreeMap<String, Stats>, partial: HashMap<String, Stats>) {
+fn merge(total: &mut HashMap<String, Stats>, partial: HashMap<String, Stats>) {
     for (station, stats) in &partial {
         total.entry(station.to_string()).or_default().merge(stats);
     }
 }
 
-fn print_report(stats: &mut BTreeMap<String, Stats>) {
+fn print_report(stats: &mut HashMap<String, Stats>) {
     print!("{{");
-    let num_stations = stats.len();
-    for (i, (station, stats)) in stats.iter().enumerate() {
+    let mut sorted_stations: Vec<_> = stats.iter().collect();
+    sorted_stations.sort_by_key(|(station, _)| *station);
+    let num_stations = sorted_stations.len();
+    for (i, (station, stats)) in sorted_stations.iter().enumerate() {
         print!(
             "{station}={:.1}/{:.1}/{:.1}",
             stats.min,

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ./onebrc_btreemap target/release/onebrc
Benchmark 1: ./onebrc_btreemap
  Time (mean ± σ):      3.115 s ±  0.160 s    [User: 61.405 s, System: 1.101 s]
  Range (min … max):    2.924 s …  3.434 s    10 runs
 
Benchmark 2: target/release/onebrc
  Time (mean ± σ):      3.166 s ±  0.127 s    [User: 63.405 s, System: 1.112 s]
  Range (min … max):    2.934 s …  3.357 s    10 runs
 
Summary
  ./onebrc_btreemap ran
    1.02 ± 0.07 times faster than target/release/onebrc

There is a measurable difference, I'll keep the BTreeMap for now -- but might revisit.

#### What do we spend our time on now?

With all threads (both performance and efficiency core)

Samples: 39K of event 'cpu_atom/cycles/P', Event count (approx.): 190938550000
  Children      Self  Command  Shared Object         Symbol
+   36.32%    11.13%  onebrc   onebrc                [.] onebrc::handle_shard
+   34.99%     0.00%  onebrc   [unknown]             [.] 0x0000000000001fff
+   22.82%    14.69%  onebrc   onebrc                [.] hashbrown::rustc_entry::<impl hashbrown::map::HashMap<K,V,S,A>>::rustc_entry
+   19.53%     0.00%  onebrc   onebrc                [.] hashbrown::raw::RawTable<T,A>::find (inlined)
+   19.53%     0.00%  onebrc   onebrc                [.] hashbrown::raw::RawTableInner::find_inner (inlined)
+   13.94%     0.00%  onebrc   onebrc                [.] core::str::<impl str>::parse (inlined)
+   12.96%     8.31%  onebrc   onebrc                [.] core::num::dec2flt::<impl core::str::traits::FromStr for f64>::from_str
+   12.95%     0.00%  onebrc   onebrc                [.] hashbrown::raw::RawTable<T,A>::find::{{closure}} (inlined)
+   12.30%     0.00%  onebrc   onebrc                [.] core::num::dec2flt::dec2flt (inlined)
+   11.44%    11.42%  onebrc   onebrc                [.] core::slice::memchr::memchr_aligned
+   11.43%     0.00%  onebrc   onebrc                [.] hashbrown::rustc_entry::<impl hashbrown::map::HashMap<K,V,S,A>>::rustc_entry::{{closure}} (inlined)
+   11.43%     0.00%  onebrc   onebrc                [.] <alloc::string::String as core::cmp::PartialEq>::eq (inlined)
+   11.43%     0.00%  onebrc   onebrc                [.] alloc::vec::partial_eq::<impl core::cmp::PartialEq<alloc::vec::Vec<U,A2>> for alloc::vec::Vec<T,A1>>::eq (inlined)
+   11.43%     0.00%  onebrc   onebrc                [.] core::slice::cmp::<impl core::cmp::PartialEq<[U]> for [T]>::eq (inlined)
+   11.43%     0.00%  onebrc   onebrc                [.] <[A] as core::slice::cmp::SlicePartialEq<B>>::equal (inlined)
+    9.73%     0.00%  onebrc   onebrc                [.] std::collections::hash::map::HashMap<K,V,S>::entry (inlined)
+    9.50%     7.00%  onebrc   onebrc                [.] std::io::append_to_string
+    9.16%     0.00%  onebrc   [unknown]             [.] 0x00000000000001fe
+    8.10%     8.08%  onebrc   onebrc                [.] core::hash::BuildHasher::hash_one
+    7.62%     0.00%  onebrc   onebrc                [.] core::slice::memchr::memchr_aligned::runtime (inlined)
+    7.24%     0.00%  onebrc   onebrc                [.] <std::hash::random::DefaultHasher as core::hash::Hasher>::finish (inlined)
+    7.24%     0.00%  onebrc   onebrc                [.] <core::hash::sip::SipHasher13 as core::hash::Hasher>::finish (inlined)
+    7.24%     0.00%  onebrc   onebrc                [.] <core::hash::sip::Hasher<S> as core::hash::Hasher>::finish (inlined)
+    7.15%     0.00%  onebrc   onebrc                [.] std::io::BufRead::read_line::{{closure}} (inlined)
+    7.15%     0.00%  onebrc   onebrc                [.] std::io::read_until (inlined)
+    6.67%     6.66%  onebrc   libc.so.6             [.] __memcmp_avx2_movbe
+    6.30%     3.59%  onebrc   onebrc                [.] alloc::raw_vec::RawVecInner<A>::finish_grow
+    5.80%     5.79%  onebrc   onebrc                [.] core::str::converts::from_utf8
+    5.18%     0.00%  onebrc   onebrc                [.] core::str::validations::run_utf8_validation (inlined)

Samples: 23K of event 'cpu_core/cycles/P', Event count (approx.): 121426438946
  Children      Self  Command  Shared Object      Symbol
+   33.88%    11.04%  onebrc   onebrc             [.] onebrc::handle_shard
+   31.36%     0.00%  onebrc   [unknown]          [.] 0x0000000000001fff
+   12.93%     8.65%  onebrc   onebrc             [.] hashbrown::rustc_entry::<impl hashbrown::map::HashMap<K,V,S,A>>::rustc_entry
+   12.15%     0.00%  onebrc   onebrc             [.] core::str::<impl str>::parse (inlined)
+   11.65%     4.79%  onebrc   onebrc             [.] core::num::dec2flt::<impl core::str::traits::FromStr for f64>::from_str
+   11.53%     8.67%  onebrc   onebrc             [.] std::io::append_to_string
+   10.21%     0.00%  onebrc   onebrc             [.] core::num::dec2flt::dec2flt (inlined)
+    9.23%     9.21%  onebrc   onebrc             [.] core::slice::memchr::memchr_aligned
+    8.85%     0.00%  onebrc   onebrc             [.] std::io::BufRead::read_line::{{closure}} (inlined)
+    8.85%     0.00%  onebrc   onebrc             [.] std::io::read_until (inlined)
+    8.66%     0.00%  onebrc   onebrc             [.] core::slice::memchr::memchr_aligned::runtime (inlined)
+    7.72%     4.70%  onebrc   onebrc             [.] alloc::raw_vec::RawVecInner<A>::finish_grow
+    7.63%     0.00%  onebrc   onebrc             [.] hashbrown::raw::RawTable<T,A>::find (inlined)
+    7.63%     0.00%  onebrc   onebrc             [.] hashbrown::raw::RawTableInner::find_inner (inlined)
+    7.55%     7.55%  onebrc   onebrc             [.] <core::hash::sip::Hasher<S> as core::hash::Hasher>::write
+    7.26%     0.00%  onebrc   onebrc             [.] std::collections::hash::map::HashMap<K,V,S>::entry (inlined)
+    7.17%     7.16%  onebrc   onebrc             [.] core::num::dec2flt::parse::parse_number
+    6.25%     0.00%  onebrc   [unknown]          [.] 0x00000000000001fe
+    6.20%     6.18%  onebrc   onebrc             [.] core::hash::BuildHasher::hash_one
+    5.61%     0.00%  onebrc   onebrc             [.] <T as alloc::string::ToString>::to_string (inlined)
+    5.61%     0.00%  onebrc   onebrc             [.] <str as alloc::string::SpecToString>::spec_to_string (inlined)
+    5.61%     0.00%  onebrc   onebrc             [.] <alloc::string::String as core::convert::From<&str>>::from (inlined)
+    5.61%     0.00%  onebrc   onebrc             [.] alloc::str::<impl alloc::borrow::ToOwned for str>::to_owned (inlined)
+    5.59%     0.00%  onebrc   onebrc             [.] core::slice::memchr::memchr_naive (inlined)
+    5.48%     5.48%  onebrc   onebrc             [.] core::str::converts::from_utf8
+    5.34%     0.00%  onebrc   onebrc             [.] alloc::slice::<impl alloc::borrow::ToOwned for [T]>::to_owned (inlined)
+    5.34%     0.00%  onebrc   onebrc             [.] alloc::slice::<impl [T]>::to_vec (inlined)
+    5.34%     0.00%  onebrc   onebrc             [.] alloc::slice::<impl [T]>::to_vec_in (inlined)
+    5.34%     0.00%  onebrc   onebrc             [.] <T as alloc::slice::<impl [T]>::to_vec_in::ConvertVec>::to_vec (inlined)
+    5.29%     0.00%  onebrc   onebrc             [.] core::num::dec2flt::parse::parse_partial_number (inlined)
+    5.24%     0.00%  onebrc   libc.so.6          [.] __GI___libc_malloc (inlined)
+    5.23%     5.23%  onebrc   libc.so.6          [.] malloc
+    5.13%     0.00%  onebrc   onebrc             [.] hashbrown::raw::RawTable<T,A>::find::{{closure}} (inlined)

 Performance counter stats for 'target/release/onebrc':

    62,805,535,309      task-clock                       #   21.188 CPUs utilized             
             2,321      context-switches                 #   36.955 /sec                      
                16      cpu-migrations                   #    0.255 /sec                      
               582      page-faults                      #    9.267 /sec                      
 1,101,952,938,030      cpu_atom/instructions/           #    3.67  insn per cycle              (33.52%)
 1,439,279,081,364      cpu_core/instructions/           #    4.34  insn per cycle              (33.76%)
   300,501,451,912      cpu_atom/cycles/                 #    4.785 GHz                         (33.52%)
   331,291,271,751      cpu_core/cycles/                 #    5.275 GHz                         (33.76%)
   224,317,942,723      cpu_atom/branches/               #    3.572 G/sec                       (33.55%)
   293,072,808,968      cpu_core/branches/               #    4.666 G/sec                       (33.76%)
     1,696,378,376      cpu_atom/branch-misses/          #    0.76% of all branches             (33.56%)
     2,619,244,843      cpu_core/branch-misses/          #    0.89% of all branches             (30.95%)
 #     22.6 %  tma_backend_bound        (33.58%)
 #      9.3 %  tma_backend_bound      
                                                  #     14.3 %  tma_bad_speculation    
                                                  #     27.4 %  tma_frontend_bound     
                                                  #     49.0 %  tma_retiring             (33.77%)
 #      0.0 %  tma_retiring             (33.59%)
 #     21.4 %  tma_bad_speculation    
                                                  #      0.0 %  tma_frontend_bound       (33.60%)
   225,864,578,513      cpu_atom/L1-dcache-loads/        #    3.596 G/sec                       (37.34%)
   291,781,734,038      cpu_core/L1-dcache-loads/        #    4.646 G/sec                       (33.77%)
       250,194,587      cpu_core/L1-dcache-load-misses/  #    0.09% of all L1-dcache accesses   (33.77%)
        41,497,786      cpu_atom/LLC-loads/              #  660.735 K/sec                       (33.61%)
       148,272,438      cpu_core/LLC-loads/              #    2.361 M/sec                       (33.77%)
         4,780,625      cpu_atom/LLC-load-misses/        #   11.52% of all LL-cache accesses    (33.59%)
        27,665,536      cpu_core/LLC-load-misses/        #   18.66% of all LL-cache accesses    (33.78%)
   396,481,349,192      cpu_atom/L1-icache-loads/        #    6.313 G/sec                       (33.58%)
       172,717,102      cpu_atom/L1-icache-load-misses/  #    0.04% of all L1-icache accesses   (33.56%)
        29,633,877      cpu_core/L1-icache-load-misses/                                         (33.78%)
   225,957,571,571      cpu_atom/dTLB-loads/             #    3.598 G/sec                       (33.55%)
   291,814,034,674      cpu_core/dTLB-loads/             #    4.646 G/sec                       (33.79%)
            43,543      cpu_atom/dTLB-load-misses/       #    0.00% of all dTLB cache accesses  (33.54%)
           299,958      cpu_core/dTLB-load-misses/       #    0.00% of all dTLB cache accesses  (33.79%)
            91,751      cpu_atom/iTLB-load-misses/                                              (29.80%)
        38,116,211      cpu_core/iTLB-load-misses/                                              (30.95%)

       2.964160906 seconds time elapsed

      61.684945000 seconds user
       1.120635000 seconds sys

ChatGPT:

ChatGPT said:

Your run shows good parallel scaling (~21 CPUs active) and high core efficiency (high IPC, very low branch and L1D miss rates), so the program is not dominated by scheduling, locking, or trivial inefficiencies. The main limits are microarchitectural: only ~50% of cycles retire useful work, with a large frontend bound component (instruction supply, code size/layout, ITLB pressure) and a secondary backend bound component driven partly by nontrivial LLC miss rates, especially on P-cores. Bad speculation is present but not dominant. The -r N flag matters because your counters are heavily multiplexed (~33%), so repeating runs and reporting mean ± variance is essential to trust ratios like IPC and TMA. Overall, further speedups are more likely to come from reducing instruction footprint and improving code locality (and secondarily data locality) than from tweaking branches or arithmetic.


#### Avoid allocations in .lines()

replace with byte slices

folkol@ubuntu:~/code/labs/1brc/onebrc$ git checkout src/main.rs
Updated 1 path from the index

folkol@ubuntu:~/code/labs/1brc/onebrc$ git diff src/main.rs
diff --git a/1brc/onebrc/src/main.rs b/1brc/onebrc/src/main.rs
index 445e17e..4988916 100644
--- a/1brc/onebrc/src/main.rs
+++ b/1brc/onebrc/src/main.rs
@@ -88,11 +88,22 @@ fn find_partitions(mut file: File, num_shards: usize) -> Vec<u64> {
 
 fn handle_shard(mut file: &File, begin: u64, end: u64) -> HashMap<String, Stats> {
     file.seek(SeekFrom::Start(begin)).unwrap();
-    let reader = std::io::BufReader::new(file.take(end - begin));
+    let mut reader = std::io::BufReader::new(file.take(end - begin));
     let mut stats: HashMap<String, Stats> = Default::default();
-    for line in reader.lines() {
-        let line = line.unwrap();
-        let (station, temp) = line.split_once(';').unwrap();
+    let mut buf = Vec::new();
+    loop {
+        buf.clear();
+        let bytes_read = reader.read_until(b'\n', &mut buf).unwrap();
+        if bytes_read == 0 {
+            break;
+        }
+        let line = if buf.last() == Some(&b'\n') {
+            &buf[..buf.len() - 1]
+        } else {
+            &buf[..]
+        };
+        let line_str = std::str::from_utf8(line).unwrap();
+        let (station, temp) = line_str.split_once(';').unwrap();
         let temp: f64 = temp.parse().unwrap();
         stats.entry(station.to_string()).or_default().process(temp);
     }


folkol@ubuntu:~/code/labs/1brc/onebrc$ cargo build --release
   Compiling onebrc v0.1.0 (/home/folkol/code/labs/1brc/onebrc)
    Finished `release` profile [optimized + debuginfo] target(s) in 0.20s
folkol@ubuntu:~/code/labs/1brc/onebrc$ ./target/release/onebrc >output.txt
folkol@ubuntu:~/code/labs/1brc/onebrc$ git diff --no-index --word-diff output.txt ../expected.txt 




#### Check how wc is counting newlines (it's very fast)

$ apt source gnu-coreutils
$ cd coreutils-9.5/
$ ./configure CC=clang-17 CFLAGS='-Ofast -march=native -mtune=native'
$ ./make src/wc
$ src/wc ../java-orig/measurements.txt






#### Implement things from the top java submission

https://github.com/gunnarmorling/1brc/blob/main/src/main/java/dev/morling/onebrc/CalculateAverage_thomaswue.java

##### Quan Anh Mai for branchless number parsing code

/// https://github.com/gunnarmorling/1brc/blob/db064194be375edc02d6dbcd21268ad40f7e2869/src/main/java/dev/morling/onebrc/CalculateAverage_thomaswue.java#L308
/// Port of the Java function `convertIntoNumber(int decimalSepPos, long numberWord)`.
///
/// Notes:
/// - Java `long` is signed 64-bit; Rust uses `i64`.
/// - Java `>>>` is an unsigned (logical) right shift; in Rust we do it on `u64`.
/// - Java shifts on `long` mask the shift amount to 0..63; Rust panics if you shift by >= 64.
///   This function assumes `decimal_sep_pos` is in a sane range (as in the original usage).
#[inline]
fn convert_into_number(decimal_sep_pos: i32, number_word: i64) -> i64 {
    let shift: i32 = 28 - decimal_sep_pos;
    let signed: i64 = ((!number_word) << 59) >> 63;
    let design_mask: i64 = ! (signed & 0xFF);
    let digits: i64 = ((number_word & design_mask) << shift) & 0x0F00_0F0F_00;
    let abs_value: i64 = ((((digits as u64).wrapping_mul(0x640A_0001u64)) >> 32) & 0x3FF) as i64;
    (abs_value ^ signed) - signed
}

$ cargo build --release
$ cp target/release/onebrc onebrc_standard_parsing


##### Alfonso² Peterssen for suggesting memory mapping with unsafe and the subprocess idea
##### Artsiom Korzun for showing the benefits of work stealing at 2MB segments instead of equal split between workers
##### Jaromir Hamala for showing that avoiding the branch misprediction between <8 and 8-16 cases is a big win even if
##### more work is performed
##### Van Phu DO for demonstrating the lookup tables based on masks instead of bit shifting


 
 
##### Later: implement things from this discussion https://github.com/gunnarmorling/1brc/discussions/138





#### mmap stress test

folkol@ubuntu:~/code/labs/1brc/onebrc$ sudo NUM_THREADS=24 perf stat -ddd ./target/release/mmap_baseline_touch_all_pages_multi_thread
Processing threads: 24
24

 Performance counter stats for './target/release/mmap_baseline_touch_all_pages_multi_thread':

       569,360,192      task-clock                       #    5.209 CPUs utilized             
                76      context-switches                 #  133.483 /sec                      
                 3      cpu-migrations                   #    5.269 /sec                      
           210,739      page-faults                      #  370.133 K/sec                     
     3,655,600,766      cpu_atom/instructions/           #    1.35  insn per cycle              (28.54%)
     6,334,622,694      cpu_core/instructions/           #    2.09  insn per cycle              (26.71%)
     2,701,062,245      cpu_atom/cycles/                 #    4.744 GHz                         (30.81%)
     3,037,469,284      cpu_core/cycles/                 #    5.335 GHz                         (26.69%)
       637,003,302      cpu_atom/branches/               #    1.119 G/sec                       (33.79%)
     1,118,826,126      cpu_core/branches/               #    1.965 G/sec                       (26.87%)
           650,909      cpu_atom/branch-misses/          #    0.10% of all branches             (36.79%)
           666,625      cpu_core/branch-misses/          #    0.06% of all branches             (25.89%)
 #     75.2 %  tma_backend_bound        (39.77%)
 #     63.3 %  tma_backend_bound      
                                                  #      2.0 %  tma_bad_speculation    
                                                  #      7.9 %  tma_frontend_bound     
                                                  #     26.7 %  tma_retiring             (28.20%)
 #      0.0 %  tma_retiring             (42.63%)
 #      2.6 %  tma_bad_speculation    
                                                  #      0.0 %  tma_frontend_bound       (44.20%)
       935,182,637      cpu_atom/L1-dcache-loads/        #    1.643 G/sec                       (47.71%)
     1,540,326,561      cpu_core/L1-dcache-loads/        #    2.705 G/sec                       (28.25%)
         6,566,365      cpu_core/L1-dcache-load-misses/  #    0.43% of all L1-dcache accesses   (28.34%)
         4,040,278      cpu_atom/LLC-loads/              #    7.096 M/sec                       (42.17%)
         5,009,033      cpu_core/LLC-loads/              #    8.798 M/sec                       (28.28%)
                30      cpu_atom/LLC-load-misses/        #    0.00% of all LL-cache accesses    (39.18%)
         3,778,904      cpu_core/LLC-load-misses/        #   75.44% of all LL-cache accesses    (28.25%)
       837,457,025      cpu_atom/L1-icache-loads/        #    1.471 G/sec                       (36.19%)
         2,663,760      cpu_atom/L1-icache-load-misses/  #    0.32% of all L1-icache accesses   (33.21%)
         1,215,144      cpu_core/L1-icache-load-misses/                                         (28.41%)
       942,071,435      cpu_atom/dTLB-loads/             #    1.655 G/sec                       (30.35%)
     1,541,090,243      cpu_core/dTLB-loads/             #    2.707 G/sec                       (28.25%)
         2,925,512      cpu_atom/dTLB-load-misses/       #    0.31% of all dTLB cache accesses  (28.78%)
        13,659,856      cpu_core/dTLB-load-misses/       #    0.89% of all dTLB cache accesses  (28.25%)
             6,145      cpu_atom/iTLB-load-misses/                                              (25.26%)
             2,318      cpu_core/iTLB-load-misses/                                              (24.33%)

       0.109300929 seconds time elapsed

       0.000761000 seconds user
       0.000000000 seconds sys


	ChatGPT:

	Below is a **line-by-line, mechanism-level explanation** of what your `perf stat -ddd` output is actually telling you for this program and why it matches your mental model.

	---

	## First: what your program *really does*

	Each thread executes:

	```rust
	partial += my_data[n * 4096] as usize;
	```

	So per page you do:

	* **1 byte load**
	* That load pulls **one 64-byte cache line**
	* No writes
	* No reuse
	* One virtual address per page

	This is a **page-table + TLB stress test**, *not* a bandwidth test.

	Total work:

	* Pages ≈ **3.67M**
	* Loads ≈ **3.67M**
	* Cache lines fetched ≈ **3.67M × 64B ≈ 235 MiB**

	---

	## Time & parallelism

	```
	0.109300929 seconds time elapsed
	task-clock: 569,360,192
	# 5.209 CPUs utilized
	```

	* 0.569s of total CPU time over 0.109s wall time
	* ⇒ ~5.2 cores actively executing on average
	* Not 24 cores because:

	  * short runtime
	  * limited parallelism in page-table walks
	  * memory serialization points

	This already explains the **saturation at ~0.11s**.

	---

	## Page faults (this is the key)

	```
	210,739 page-faults   # 370 K/sec
	```

	This is exactly what you observed earlier.

	**Interpretation:**

	* These are **minor faults**
	* No disk I/O
	* Kernel installs PTEs

	Why not 3.67M faults?

	Because Linux:

	* clusters PTE population
	* uses shared page-table structures
	* may use hugepage backing internally
	* only faults when a *present PTE is missing*, not per page access

	**Critical point:**

	> A minor fault is *not* “bringing data into RAM”.
	> It is **creating a mapping** to data already in RAM.

	---

	## Instructions & cycles (hybrid CPU)

	You’re on an **Intel hybrid CPU** (P-cores + E-cores), so perf splits stats:

	### Instructions

	```
	cpu_atom instructions: 3.65B  IPC 1.35
	cpu_core instructions: 6.33B  IPC 2.09
	```

	Total instructions ≈ **10B**.

	That seems high for “3.6M loads”, but:

	* Page faults enter the kernel
	* Page walks execute microcode
	* Scheduler, TLS, stack setup, etc.
	* perf includes **everything**, not just your loop

	IPC values are normal:

	* E-cores lower IPC
	* P-cores higher IPC

	---

	### Cycles

	```
	cpu_atom cycles: 2.70B  (~4.7 GHz)
	cpu_core cycles: 3.03B  (~5.3 GHz)
	```

	These GHz numbers are **derived**, not literal clocks.
	They come from `cycles / wall_time` and reflect turbo + accounting.

	---

	## Branches (mostly loop overhead)

	```
	branches: ~1.6B total
	branch-misses: ~1.3M
	miss rate: ~0.07%
	```

	Perfectly expected:

	* tight counted loops
	* predictable branches
	* no speculation trouble

	---

	## Top-Down Microarchitecture Analysis (TMA)

	```
	tma_backend_bound: ~70%
	tma_retiring: ~25%
	tma_frontend_bound: ~0–8%
	```

	This is the *most important performance diagnosis*.

	**Backend-bound** means:

	* CPU is waiting on **memory / page walks / TLB resolution**
	* Not frontend decode
	* Not speculation
	* Not ALU throughput

	This matches your workload *exactly*.

	---

	## L1 data cache

	```
	L1-dcache-loads:
	  atom: 935M
	  core: 1.54B
	L1-dcache-load-misses:
	  core: 6.5M (0.43%)
	```

	Observations:

	* You issued **~2.5B loads**, far more than 3.67M explicit loads.
	  Why?

	  * Page walks load page tables
	  * Kernel code loads data
	  * Speculative accesses

	* Very low L1 miss rate ⇒ page tables are hot

	---

	## LLC (Last Level Cache)

	```
	LLC-loads: ~9M total
	LLC-load-misses:
	  core: 3.78M (75%)
	```

	This is subtle but expected:

	* Each page touch causes:

	  * one data cache line (often hot)
	  * **several page-table cache lines**
	* Page-table entries are spread across memory
	* Hence many LLC misses

	But total LLC traffic is still tiny:

	* single-digit millions of cache lines
	* nowhere near DRAM bandwidth limits

	---

	## TLB behavior (this explains the scaling limit)

	```
	dTLB-loads:
	  atom: 942M
	  core: 1.54B

	dTLB-load-misses:
	  atom: 2.9M (0.31%)
	  core: 13.7M (0.89%)
	```

	This is the **heart of your benchmark**.

	What happens per page:

	1. Address not in TLB
	2. Hardware page walk
	3. Kernel may install PTE
	4. TLB filled
	5. Load retried

	Your workload:

	* **Millions of TLB misses**
	* **Serialized page walks**
	* Shared page-walk hardware
	* Limited parallelism

	This is why:

	* Performance improves with threads
	* Then saturates hard at ~5–6 cores
	* Even though you spawn 24 threads

	---

	## iTLB (irrelevant here)

	```
	iTLB misses: a few thousand
	```

	Instruction footprint is tiny. Ignore.

	---

	## Why this benchmark is *not* a lower bound for scanning

	Your benchmark:

	* touches **3.67M cache lines**
	* real scan touches **~229M cache lines** (14 GiB / 64B)

	So even with *zero computation*:

	```
	best_scan_time ≈ 14 GiB / memory_bandwidth
	```

	Typical:

	* 40–80 GB/s → **0.18–0.35s**
	* and that’s after pages are mapped

	Your **0.11s** number measures:

	> “How fast can Linux establish page mappings + TLB state?”

	Not:

	> “How fast can I scan this file?”

	---

	## Final conclusions

	1. Your interpretation is correct:

	   * Minor faults = page table work, not RAM copies
	   * They reoccur because each run is a new process

	2. The numbers are **entirely sane**

	   * Backend-bound
	   * TLB-dominated
	   * Page-walk-limited
	   * Scales until shared MMU resources saturate

	3. This benchmark **cannot** be used as a lower bound for scanning

	   * It is 50–60× lighter than a real scan

	If you want, next we can:

	* design a **combined fault + scan** benchmark that reflects a real pass
	* estimate the theoretical minimum scan time on *your exact CPU*
	* or show how `MAP_POPULATE`, THP, or hugepages change these numbers

##### Try hugepages

$ sudo sh -c 'echo advise > /sys/kernel/mm/transparent_hugepage/shmem_enabled'
$ sudo sh -c 'echo always > /sys/kernel/mm/transparent_hugepage/shmem_enabled'

Couldn't get it to use huge pages...

folkol@ubuntu:~$ grep -n "measurements.txt" -A60 /proc/$pid/smaps | egrep "KernelPageSize|MMUPageSize|ShmemPmdMapped|FilePmdMapped|Rss|Pss"
1433-KernelPageSize:        4 kB
1434-MMUPageSize:           4 kB
1435-Rss:            13472108 kB
1436-Pss:            13472108 kB
1437-Pss_Dirty:      13472108 kB
1447-ShmemPmdMapped:        0 kB
1448-FilePmdMapped:         0 kB
1452-SwapPss:               0 kB
1459-KernelPageSize:        4 kB
1460-MMUPageSize:           4 kB
1461-Rss:                 156 kB
1462-Pss:                   1 kB
1463-Pss_Dirty:             0 kB
1473-ShmemPmdMapped:        0 kB
1474-FilePmdMapped:         0 kB
1478-SwapPss:               0 kB
1485-KernelPageSize:        4 kB
1486-MMUPageSize:           4 kB
1487-Rss:                1312 kB
1488-Pss:                  11 kB
1489-Pss_Dirty:             0 kB

> Kernel page table docs: https://docs.kernel.org/mm/page_tables.html
- Page tables map virtual addresses as seen by the CPU into physical addresses as seen on the external memory bus.
- The physical address corresponding to the virtual address is often referenced by the underlying physical page frame. The page frame number or pfn is the physical address of the page (as seen on the external memory bus) divided by PAGE_SIZE.
-  



#### Baseline

The Java winner on single thread:

folkol@ubuntu:~/code/labs/1brc/onebrc$ time taskset -c 0 ../java-orig/target/CalculateAverage_thomaswue_image 
{Abha=-33.8/18.0/71.1, ...

real	0m4.125s
user	0m0.000s
sys	0m0.003s


folkol@ubuntu:~/code/labs/1brc/onebrc$ time taskset -c 0 target/release/scan_lines_baseline
1000000000

real	0m0.830s
user	0m0.535s
sys	0m0.294s



folkol@ubuntu:~/code/labs/1brc/onebrc$ time taskset -c 0-7 ../java-orig/target/CalculateAverage_thomaswue_image 
{Abha=-33.8/18.0/71.1, ...

real	0m0.581s
user	0m0.001s
sys	0m0.004s
folkol@ubuntu:~/code/labs/1brc/onebrc$ time taskset -c 0-7 target/release/scan_lines_baseline_multi_thread
1000000000

real	0m0.241s
user	0m1.067s
sys	0m0.348s




use memmap2::Mmap;
use std::fs::File;

/// Establish a baseline for how fast we can find the lines in the mmap'd file

fn main() {
    let file = File::open("../java-orig/measurements.txt").expect("failed to open file");
    let data = unsafe { Mmap::map(&file).expect("failed to map") };

    println!("{}", count_lines(&data));
}

fn count_lines(data: &[u8]) -> i64 {
    memchr::memchr_iter(b'\n', data).count() as i64
}

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/scan_lines_baseline{,_child_process}
Benchmark 1: target/release/scan_lines_baseline
  Time (mean ± σ):     824.3 ms ±  12.1 ms    [User: 549.8 ms, System: 274.2 ms]
  Range (min … max):   807.1 ms … 847.5 ms    10 runs
 
Benchmark 2: target/release/scan_lines_baseline_child_process
  Time (mean ± σ):     752.2 ms ±  10.0 ms    [User: 0.6 ms, System: 0.9 ms]
  Range (min … max):   732.1 ms … 761.4 ms    10 runs
 
Summary
  target/release/scan_lines_baseline_child_process ran
    1.10 ± 0.02 times faster than target/release/scan_lines_baseline


Multi thread and child processs:

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/scan_lines_baseline_multi_thread{,_child_process}
Benchmark 1: target/release/scan_lines_baseline_multi_thread
  Time (mean ± σ):     231.0 ms ±   1.8 ms    [User: 3262.2 ms, System: 422.7 ms]
  Range (min … max):   229.8 ms … 236.0 ms    13 runs
 
Benchmark 2: target/release/scan_lines_baseline_multi_thread_child_process
  Time (mean ± σ):     165.7 ms ±   1.8 ms    [User: 0.6 ms, System: 0.3 ms]
  Range (min … max):   159.6 ms … 167.4 ms    18 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Summary
  target/release/scan_lines_baseline_multi_thread_child_process ran
    1.39 ± 0.02 times faster than target/release/scan_lines_baseline_multi_thread



Sanity-check against the Java solution:

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/scan_lines_baseline_multi_thread_child_process ../java-orig/target/CalculateAverage_thomaswue_image 
Benchmark 1: target/release/scan_lines_baseline_multi_thread_child_process
  Time (mean ± σ):     165.6 ms ±   1.8 ms    [User: 0.5 ms, System: 0.4 ms]
  Range (min … max):   158.8 ms … 167.4 ms    18 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 2: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):     216.0 ms ±   3.0 ms    [User: 0.5 ms, System: 2.5 ms]
  Range (min … max):   212.4 ms … 222.0 ms    13 runs
 
Summary
  target/release/scan_lines_baseline_multi_thread_child_process ran
    1.30 ± 0.02 times faster than ../java-orig/target/CalculateAverage_thomaswue_image






folkol@ubuntu:~/code/labs/1brc/onebrc$ time taskset -c 0-23 ../java-orig/target/CalculateAverage_thomaswue_image 
{Abha=-33.8/18.0/71.1, ...

real	0m0.207s
user	0m0.000s
sys	0m0.004s
folkol@ubuntu:~/code/labs/1brc/onebrc$ time taskset -c 0-23 target/release/scan_lines_baseline_multi_thread
1000000000

real	0m0.227s
user	0m3.219s
sys	0m0.431s



What is going on?

After some digging I found out that wait for munmapof the large file... Which is single threaded :)
https://en.wikipedia.org/wiki/Amdahl%27s_law

Implement the "Subprocess trick"...

folkol@ubuntu:~/code/labs/1brc/onebrc$ time taskset -c 0-23 ../java-orig/target/CalculateAverage_thomaswue_image 
{Abha=-33.8/18.0/71.1, ...

real	0m0.207s
user	0m0.001s
sys	0m0.003s
folkol@ubuntu:~/code/labs/1brc/onebrc$ time taskset -c 0-23 target/release/scan_lines_baseline_multi_thread_child_process
1000000000

real	0m0.159s
user	0m0.000s
sys	0m0.001s


There we go:

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/scan_lines_baseline_multi_thread_child_process ../java-orig/target/CalculateAverage_thomaswue_image 
Benchmark 1: target/release/scan_lines_baseline_multi_thread_child_process
  Time (mean ± σ):     165.8 ms ±   1.7 ms    [User: 0.4 ms, System: 0.5 ms]
  Range (min … max):   159.4 ms … 167.4 ms    18 runs
 
Benchmark 2: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):     215.8 ms ±   4.9 ms    [User: 0.8 ms, System: 2.3 ms]
  Range (min … max):   212.3 ms … 227.5 ms    14 runs
 
Summary
  target/release/scan_lines_baseline_multi_thread_child_process ran
    1.30 ± 0.03 times faster than ../java-orig/target/CalculateAverage_thomaswue_image


But we don't have too much time doing the actual work before we become slower than the Java solution...

##### Naive split, causes us to wait for straggling E-cores... change to dynamic work stealing

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/scan_lines_baseline_multi_thread_child_process{,_threads_dynamic_work_stealing}
Benchmark 1: target/release/scan_lines_baseline_multi_thread_child_process
  Time (mean ± σ):     164.9 ms ±   1.9 ms    [User: 0.4 ms, System: 0.5 ms]
  Range (min … max):   159.1 ms … 166.6 ms    18 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 2: target/release/scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing
  Time (mean ± σ):     163.9 ms ±   2.4 ms    [User: 0.5 ms, System: 0.4 ms]
  Range (min … max):   160.4 ms … 167.5 ms    18 runs
 
Summary
  target/release/scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing ran
    1.01 ± 0.02 times faster than target/release/scan_lines_baseline_multi_thread_child_process


Some different chunk sizes:

1 << n

folkol@ubuntu:~/code/labs/1brc/onebrc$ time cargo -q run --release --bin scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing && time perf stat -ddd target/release/scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing 

...
4:  31.4
5:  15.9
6:  8.3
7:  4.1
8:  2.7
9:  2.2
10: 2.0
11: 2.1
12: 1.9
13: 1.5
14: 0.7
15: 0.3
16: 0.17
17: 0.16
18: 0.16
19: 0.16
20: 0.16
21: 0.16
22: 0.16
23: 0.164
24: 0.17
25: 0.165
26: 0.165
27: 0.166
28: 0.166
29: 0.176
30: 0.171
31: 0.2
32: 0.314
33: 0.5
34: 0.748
35: 0.737
36: 0.750
37: 0.747
38: 0.734

	ChatGPT:
	One-sentence mental model

	Chunk size controls the tradeoff between coordination overhead (too small) and parallel slack (too large); the flat region is where memory bandwidth is the only limit.

	What you measured is exactly how a well-designed parallel scan should behave.

folkol@ubuntu:~/code/labs/1brc/onebrc$ sudo turbostat --Summary --interval 0.005 -- target/release/scan_lines_baseline_multi_thread_child_process_threads


folkol@ubuntu:~/code/labs/1brc/onebrc$ sudo turbostat --interval 0.005 --quiet --show CPU,Busy%,CPU%c1,CPU%c6,CPU%c7 \
  -- target/release/scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing
total threads: 24
1000000000
0.162173 sec
CPU	Busy%	CPU%c1	CPU%c6	CPU%c7
-	96.94	2.04	0.82	0.17
0	97.98	1.90	0.00	0.11
1	97.84	1.20	0.12	0.81
8	97.56	0.00	2.40	0.00
9	98.08	1.90	0.01	0.00
10	98.00	1.99	0.00	0.00
11	97.90	0.37	1.70	0.00
12	97.63	2.08	0.28	0.00
13	98.16	1.83	0.00	0.00
14	98.46	1.14	0.38	0.00
15	97.96	0.41	1.61	0.00
2	97.98	1.37	0.00	0.63
3	97.00	2.38	0.60	0.00
4	95.82	3.10	0.36	0.66
5	95.77	2.99	0.22	0.95
16	95.47	0.00	4.49	0.00
17	95.98	1.94	2.05	0.00
18	95.69	1.94	2.32	0.00
19	95.92	1.96	2.07	0.00
20	95.93	4.05	0.00	0.00
21	95.93	4.05	0.00	0.00
22	99.02	0.98	0.00	0.00
23	95.76	4.22	0.00	0.00
6	95.37	2.71	1.00	0.86
7	95.56	4.25	0.14	0.00
folkol@ubuntu:~/code/labs/1brc/onebrc$ sudo turbostat --interval 0.005 --quiet --show CPU,Busy%,CPU%c1,CPU%c6,CPU%c7   -- target/release/scan_lines_baseline_multi_thread_child_process_threads
total threads: 24
1000000000
0.161977 sec
CPU	Busy%	CPU%c1	CPU%c6	CPU%c7
-	87.50	4.03	8.12	0.26
0	96.57	0.19	1.20	1.97
1	95.98	0.69	1.66	1.63
8	74.67	0.28	24.81	0.00
9	92.88	1.80	5.23	0.00
10	71.40	27.33	1.15	0.00
11	93.28	0.21	6.46	0.00
12	71.33	0.00	28.53	0.00
13	93.92	0.06	5.93	0.00
14	94.13	0.02	5.80	0.00
15	94.29	0.54	5.11	0.00
2	96.45	1.07	1.61	0.81
3	97.58	1.20	0.44	0.73
4	96.52	2.82	0.00	0.64
5	95.83	1.39	2.17	0.53
16	71.35	0.00	28.50	0.00
17	72.12	17.40	10.36	0.00
18	93.17	1.74	5.03	0.00
19	72.53	21.69	5.62	0.00
20	93.97	0.00	5.98	0.00
21	74.48	1.00	24.39	0.00
22	72.81	10.28	16.74	0.00
23	92.35	0.79	6.80	0.00
6	96.81	2.57	0.55	0.00
7	95.54	3.55	0.86	0.00


	ChatGPT:
	One-sentence conclusion

	Dynamic work stealing improved performance entirely by eliminating heterogeneous-core tail latency, keeping all cores in C0 until completion.

	This is as clear-cut as performance analysis gets.


##### Align work chunks to newlines

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 10 target/release/scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing{,_newline_aligned}
Benchmark 1: target/release/scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing
  Time (mean ± σ):     163.2 ms ±   1.6 ms    [User: 0.5 ms, System: 0.4 ms]
  Range (min … max):   161.1 ms … 167.1 ms    18 runs
 
Benchmark 2: target/release/scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing_newline_aligned
  Time (mean ± σ):     162.7 ms ±   2.4 ms    [User: 0.4 ms, System: 0.5 ms]
  Range (min … max):   159.8 ms … 167.9 ms    18 runs
 
Summary
  target/release/scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing_newline_aligned ran
    1.00 ± 0.02 times faster than target/release/scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing



#### First actual implemetation (candidate_1)

- take scan_lines_baseline_multi_thread_child_process_threads_dynamic_work_stealing_newline_aligned.rs and add naive implementation

folkol@ubuntu:~/code/labs/1brc/onebrc$ cargo run --release --bin candidate_1 >output.txt
warning: unused manifest key: profile.release.embed-bitcode
   Compiling onebrc v0.1.0 (/home/folkol/code/labs/1brc/onebrc)
    Finished `release` profile [optimized + debuginfo] target(s) in 1.93s
     Running `target/release/candidate_1`
total threads: 24
folkol@ubuntu:~/code/labs/1brc/onebrc$ diff output.txt ../expected.txt 
folkol@ubuntu:~/code/labs/1brc/onebrc$ time target/release/candidate_1 
total threads: 24
{Abha=-33.8/18.0/71.1, ...

real	0m1.950s
user	0m0.000s
sys	0m0.001s

So, where do we spend our time?

Samples: 15K of event 'cpu_core/cycles/P', Event count (approx.): 81622559943
  Children      Self  Command      Shared Object      Symbol
-   79.51%    32.47%  candidate_1  candidate_1        [.] std::sys::backtrace::__rust_begin_short_backtrace                                                                                                                                                         ▒
     std::sys::backtrace::__rust_begin_short_backtrace                                                                                                                                                                                                              ◆
   - candidate_1::total_lines::{{closure}}::{{closure}} (inlined)                                                                                                                                                                                                   ▒
      + 79.44% candidate_1::chunk_statistics (inlined)                                                                                                                                                                                                              ▒
-   79.51%     0.00%  candidate_1  candidate_1        [.] candidate_1::total_lines::{{closure}}::{{closure}} (inlined)                                                                                                                                              ▒
   - candidate_1::total_lines::{{closure}}::{{closure}} (inlined)                                                                                                                                                                                                   ▒
      + 79.44% candidate_1::chunk_statistics (inlined)                                                                                                                                                                                                              ▒
-   79.44%     0.00%  candidate_1  candidate_1        [.] candidate_1::chunk_statistics (inlined)                                                                                                                                                                   ▒
   - candidate_1::chunk_statistics (inlined)                                                                                                                                                                                                                        ▒
      + 28.38% std::collections::hash::map::HashMap<K,V,S>::entry (inlined)                                                                                                                                                                                         ▒
      + 22.14% core::str::<impl str>::parse (inlined)                                                                                                                                                                                                               ▒
      + 10.26% memchr::memchr::memrchr (inlined)                                                                                                                                                                                                                    ▒
      + 6.62% <memchr::memchr::Memchr as core::iter::traits::iterator::Iterator>::next (inlined)                                                                                                                                                                    ▒
      + 3.99% alloc::slice::<impl [T]>::to_vec (inlined)                                                                                                                                                                                                            ▒
        1.02% core::str::<impl str>::from_utf8 (inlined)                                                                                                                                                                                                            ▒
      + 0.62% core::slice::index::<impl core::ops::index::Index<I> for [T]>::index (inlined)                                                                                                                                                                        ▒
        0.62% core::result::Result<T,E>::unwrap (inlined)                                                                                                                                                                                                           ▒
        0.54% core::f64::<impl f64>::max (inlined)                                                                                                                                                                                                                  ▒
-   28.38%     0.00%  candidate_1  candidate_1        [.] std::collections::hash::map::HashMap<K,V,S>::entry (inlined)                                                                                                                                              ▒
     std::collections::hash::map::HashMap<K,V,S>::entry (inlined)                                                                                                                                                                                                   ▒
   - hashbrown::rustc_entry::<impl hashbrown::map::HashMap<K,V,S,A>>::rustc_entry (inlined)                                                                                                                                                                         ▒
      + 14.31% hashbrown::raw::RawTable<T,A>::find (inlined)                                                                                                                                                                                                        ▒
      + 9.49% hashbrown::map::make_hash (inlined)                                                                                                                                                                                                                   ▒
      + 4.58% core::ptr::drop_in_place<alloc::string::String> (inlined)   


HashMap-stuff and string parsing

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 10 ../java-orig/target/CalculateAverage_thomaswue_image target/release/candidate_1
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):     215.0 ms ±   3.4 ms    [User: 0.6 ms, System: 2.4 ms]
  Range (min … max):   211.9 ms … 223.7 ms    14 runs
 
Benchmark 2: target/release/candidate_1
  Time (mean ± σ):      2.077 s ±  0.060 s    [User: 0.000 s, System: 0.001 s]
  Range (min … max):    1.985 s …  2.177 s    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image ran
    9.66 ± 0.32 times faster than target/release/candidate_1


folkol@ubuntu:~/code/labs/1brc/onebrc$ perf stat -ddd target/release/candidate_1
total threads: 24
{Abha=-33.8/18.0/71.1, ...

 Performance counter stats for 'target/release/candidate_1':

    47,074,248,147      task-clock                       #   23.899 CPUs utilized             
             1,860      context-switches                 #   39.512 /sec                      
                13      cpu-migrations                   #    0.276 /sec                      
           211,224      page-faults                      #    4.487 K/sec                     
   710,151,072,891      cpu_atom/instructions/           #    3.16  insn per cycle              (35.21%)
   950,015,173,149      cpu_core/instructions/           #    3.86  insn per cycle              (30.70%)
   224,950,681,453      cpu_atom/cycles/                 #    4.779 GHz                         (35.21%)
   246,074,112,889      cpu_core/cycles/                 #    5.227 GHz                         (30.71%)
   136,544,023,908      cpu_atom/branches/               #    2.901 G/sec                       (35.23%)
   182,800,980,792      cpu_core/branches/               #    3.883 G/sec                       (30.71%)
     1,890,890,382      cpu_atom/branch-misses/          #    1.38% of all branches             (35.26%)
     2,641,223,377      cpu_core/branch-misses/          #    1.44% of all branches             (28.15%)
 #     21.3 %  tma_backend_bound        (35.29%)
 #     13.6 %  tma_backend_bound      
                                                  #     23.9 %  tma_bad_speculation    
                                                  #     19.5 %  tma_frontend_bound     
                                                  #     43.0 %  tma_retiring             (30.71%)
 #      0.0 %  tma_retiring             (35.33%)
 #     29.4 %  tma_bad_speculation    
                                                  #      0.0 %  tma_frontend_bound       (35.36%)
   120,507,204,131      cpu_atom/L1-dcache-loads/        #    2.560 G/sec                       (39.36%)
   156,674,247,257      cpu_core/L1-dcache-loads/        #    3.328 G/sec                       (30.71%)
        46,282,173      cpu_core/L1-dcache-load-misses/  #    0.03% of all L1-dcache accesses   (30.71%)
         1,666,845      cpu_atom/LLC-loads/              #   35.409 K/sec                       (35.44%)
         3,403,148      cpu_core/LLC-loads/              #   72.293 K/sec                       (30.71%)
                67      cpu_atom/LLC-load-misses/        #    0.00% of all LL-cache accesses    (35.41%)
           596,465      cpu_core/LLC-load-misses/        #   17.53% of all LL-cache accesses    (30.71%)
   274,637,563,570      cpu_atom/L1-icache-loads/        #    5.834 G/sec                       (35.38%)
        52,397,152      cpu_atom/L1-icache-load-misses/  #    0.02% of all L1-icache accesses   (35.35%)
        24,683,778      cpu_core/L1-icache-load-misses/                                         (30.72%)
   120,566,070,314      cpu_atom/dTLB-loads/             #    2.561 G/sec                       (35.31%)
   156,694,673,826      cpu_core/dTLB-loads/             #    3.329 G/sec                       (30.71%)
           251,808      cpu_atom/dTLB-load-misses/       #    0.00% of all dTLB cache accesses  (35.28%)
         1,014,581      cpu_core/dTLB-load-misses/       #    0.00% of all dTLB cache accesses  (30.71%)
            29,527      cpu_atom/iTLB-load-misses/                                              (31.31%)
        16,902,219      cpu_core/iTLB-load-misses/                                              (28.13%)

       1.969694769 seconds time elapsed

       0.000000000 seconds user
       0.001218000 seconds sys

$ perf script | ./FlameGraph/stackcollapse-perf.pl | ./FlameGraph/flamegraph.pl --width 3000 >flame.svg
Filtering for events of type: cpu_core/cycles/P

[[ flame graph ]]


#### Candidate 2, ahash

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{1,2}
Benchmark 1: target/release/candidate_1
  Time (mean ± σ):      2.011 s ±  0.033 s    [User: 0.001 s, System: 0.000 s]
  Range (min … max):    1.960 s …  2.057 s    10 runs
 
Benchmark 2: target/release/candidate_2
  Time (mean ± σ):      1.969 s ±  0.050 s    [User: 0.001 s, System: 0.000 s]
  Range (min … max):    1.896 s …  2.049 s    10 runs
 
Summary
  target/release/candidate_2 ran
    1.02 ± 0.03 times faster than target/release/candidate_1



#### Candidate 3, xxhash

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 2 target/release/candidate_{1,3}
Benchmark 1: target/release/candidate_1
  Time (mean ± σ):      2.161 s ±  0.086 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    2.026 s …  2.328 s    10 runs
 
Benchmark 2: target/release/candidate_3
  Time (mean ± σ):      2.357 s ±  0.027 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    2.305 s …  2.399 s    10 runs
 
Summary
  target/release/candidate_1 ran
    1.09 ± 0.04 times faster than target/release/candidate_3


#### Candidate 4, ChatGPT-port java stuff

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 2 target/release/candidate_{1,4}
Benchmark 1: target/release/candidate_1
  Time (mean ± σ):      2.061 s ±  0.066 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    1.962 s …  2.210 s    10 runs
 
Benchmark 2: target/release/candidate_4
  Time (mean ± σ):      1.451 s ±  0.034 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    1.414 s …  1.536 s    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Summary
  target/release/candidate_4 ran
    1.42 ± 0.06 times faster than target/release/candidate_1


#### Candidate 5, get rid of the "special" byte slice comparison

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 2 target/release/candidate_{4,5}
Benchmark 1: target/release/candidate_4
  Time (mean ± σ):      1.432 s ±  0.029 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    1.402 s …  1.480 s    10 runs
 
Benchmark 2: target/release/candidate_5
  Time (mean ± σ):      1.421 s ±  0.031 s    [User: 0.001 s, System: 0.000 s]
  Range (min … max):    1.378 s …  1.491 s    10 runs
 
Summary
  target/release/candidate_5 ran
    1.01 ± 0.03 times faster than target/release/candidate_4

A bit faster...


Forgot RUSTFLAGS...

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_5 ./candidate_5_flags 
Benchmark 1: target/release/candidate_5
  Time (mean ± σ):      1.379 s ±  0.023 s    [User: 0.001 s, System: 0.000 s]
  Range (min … max):    1.320 s …  1.402 s    10 runs
 
Benchmark 2: ./candidate_5_flags
  Time (mean ± σ):      1.298 s ±  0.034 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    1.274 s …  1.379 s    10 runs
 
Summary
  ./candidate_5_flags ran
    1.06 ± 0.03 times faster than target/release/candidate_5


#### Tweak settings + GPO

rustup component add llvm-tools-preview
LLVM_PROFDATA="$(rustc --print sysroot)/lib/rustlib/$(rustc -vV | sed -n 's/^host: //p')/bin/llvm-profdata"
rm -rf /tmp/pgo-data
RUSTFLAGS="-Cprofile-generate=/tmp/pgo-data -Ctarget-cpu=native" \
  cargo build --release --bin candidate_5 --target x86_64-unknown-linux-gnu
./target/x86_64-unknown-linux-gnu/release/candidate_5 
./target/x86_64-unknown-linux-gnu/release/candidate_5 
./target/x86_64-unknown-linux-gnu/release/candidate_5

"$LLVM_PROFDATA" merge -o /tmp/pgo-data/merged.profdata /tmp/pgo-data
RUSTFLAGS="-Cprofile-use=/tmp/pgo-data/merged.profdata -Cllvm-args=-pgo-warn-missing-function -Ctarget-cpu=native" \
  cargo build --release --bin candidate_5 --target x86_64-unknown-linux-gnu


... or

cargo install cargo-pgo
rustup component add llvm-tools-preview
cargo pgo info
cargo pgo instrument build -- --bin candidate_5
/target/*/release/candidate_5 <args1>
# (Alternative: cargo pgo run instruments + runs in one go.) 
cargo pgo optimize build -- --bin candidate_7


##### results

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_5 target/x86_64-unknown-linux-gnu/release/candidate_5
Benchmark 1: target/release/candidate_5
  Time (mean ± σ):      1.368 s ±  0.023 s    [User: 0.000 s, System: 0.001 s]
  Range (min … max):    1.317 s …  1.402 s    10 runs
 
Benchmark 2: target/x86_64-unknown-linux-gnu/release/candidate_5
  Time (mean ± σ):      1.258 s ±  0.014 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    1.244 s …  1.279 s    10 runs
 
Summary
  target/x86_64-unknown-linux-gnu/release/candidate_5 ran
    1.09 ± 0.02 times faster than target/release/candidate_5


##### candidate_6, fixed tenths parsing

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{5,6}
Benchmark 1: target/release/candidate_5
  Time (mean ± σ):      1.223 s ±  0.036 s    [User: 0.000 s, System: 0.001 s]
  Range (min … max):    1.178 s …  1.288 s    10 runs
 
Benchmark 2: target/release/candidate_6
  Time (mean ± σ):     834.9 ms ±  19.2 ms    [User: 0.5 ms, System: 0.6 ms]
  Range (min … max):   814.3 ms … 869.8 ms    10 runs
 
Summary
  target/release/candidate_6 ran
    1.46 ± 0.05 times faster than target/release/candidate_5

##### candidate_7, better parsing

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{6,7}
Benchmark 1: target/release/candidate_6
  Time (mean ± σ):     832.0 ms ±  38.9 ms    [User: 0.4 ms, System: 0.7 ms]
  Range (min … max):   797.9 ms … 906.8 ms    10 runs
 
Benchmark 2: target/release/candidate_7
  Time (mean ± σ):     807.2 ms ±  21.8 ms    [User: 0.4 ms, System: 0.7 ms]
  Range (min … max):   774.6 ms … 840.4 ms    10 runs
 
Summary
  target/release/candidate_7 ran
    1.03 ± 0.06 times faster than target/release/candidate_6



folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_7 target/x86_64-unknown-linux-gnu/release/candidate_7
Benchmark 1: target/release/candidate_7
  Time (mean ± σ):     809.1 ms ±  18.4 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   770.5 ms … 835.1 ms    10 runs
 
Benchmark 2: target/x86_64-unknown-linux-gnu/release/candidate_7
  Time (mean ± σ):     866.0 ms ±  18.9 ms    [User: 0.7 ms, System: 0.4 ms]
  Range (min … max):   837.2 ms … 888.1 ms    10 runs
 
Summary
  target/release/candidate_7 ran
    1.07 ± 0.03 times faster than target/x86_64-unknown-linux-gnu/release/candidate_7



##### Candidate 8, replace scanner with port of the java one

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{7,8}
Benchmark 1: target/release/candidate_7
  Time (mean ± σ):     815.1 ms ±  25.5 ms    [User: 0.4 ms, System: 0.7 ms]
  Range (min … max):   773.5 ms … 864.1 ms    10 runs
 
Benchmark 2: target/release/candidate_8
  Time (mean ± σ):     777.5 ms ±  13.6 ms    [User: 0.7 ms, System: 0.3 ms]
  Range (min … max):   756.8 ms … 796.4 ms    10 runs
 
Summary
  target/release/candidate_8 ran
    1.05 ± 0.04 times faster than target/release/candidate_7

##### Candidate 9, multi-scanners

Seems slower:

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{9,8}
Benchmark 1: target/release/candidate_9
  Time (mean ± σ):     811.8 ms ±  17.7 ms    [User: 0.5 ms, System: 0.6 ms]
  Range (min … max):   773.1 ms … 838.2 ms    10 runs
 
Benchmark 2: target/release/candidate_8
  Time (mean ± σ):     777.1 ms ±  16.2 ms    [User: 0.4 ms, System: 0.5 ms]
  Range (min … max):   760.5 ms … 810.4 ms    10 runs
 
Summary
  target/release/candidate_8 ran
    1.04 ± 0.03 times faster than target/release/candidate_9


##### Candidate 10

Some ChatGPT hallucinations


#### Recap, which one is fastest?

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ../java-orig/target/CalculateAverage_thomaswue_image target/release/candidate_{1..10}

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ../java-orig/target/CalculateAverage_thomaswue_image target/release/candidate_{1..10}
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):     213.2 ms ±   2.3 ms    [User: 0.5 ms, System: 2.5 ms]
  Range (min … max):   207.9 ms … 217.1 ms    14 runs
 
Benchmark 2: target/release/candidate_1
  Time (mean ± σ):      1.916 s ±  0.051 s    [User: 0.001 s, System: 0.000 s]
  Range (min … max):    1.811 s …  1.993 s    10 runs
 
Benchmark 3: target/release/candidate_2
  Time (mean ± σ):      1.832 s ±  0.038 s    [User: 0.001 s, System: 0.000 s]
  Range (min … max):    1.784 s …  1.901 s    10 runs
 
Benchmark 4: target/release/candidate_3
  Time (mean ± σ):      2.136 s ±  0.044 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    2.067 s …  2.200 s    10 runs
 
Benchmark 5: target/release/candidate_4
  Time (mean ± σ):      1.343 s ±  0.046 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    1.289 s …  1.409 s    10 runs
 
Benchmark 6: target/release/candidate_5
  Time (mean ± σ):      1.301 s ±  0.021 s    [User: 0.000 s, System: 0.001 s]
  Range (min … max):    1.275 s …  1.329 s    10 runs
 
Benchmark 7: target/release/candidate_6
  Time (mean ± σ):     884.0 ms ±  18.3 ms    [User: 0.4 ms, System: 0.8 ms]
  Range (min … max):   858.0 ms … 919.8 ms    10 runs
 
Benchmark 8: target/release/candidate_7
  Time (mean ± σ):     851.4 ms ±  19.3 ms    [User: 0.6 ms, System: 0.5 ms]
  Range (min … max):   831.6 ms … 884.8 ms    10 runs
 
Benchmark 9: target/release/candidate_8
  Time (mean ± σ):     811.5 ms ±  14.1 ms    [User: 0.4 ms, System: 0.7 ms]
  Range (min … max):   795.9 ms … 842.1 ms    10 runs
 
Benchmark 10: target/release/candidate_9
  Time (mean ± σ):     844.5 ms ±  13.3 ms    [User: 0.5 ms, System: 0.6 ms]
  Range (min … max):   820.5 ms … 863.8 ms    10 runs
 
Benchmark 11: target/release/candidate_10
  Time (mean ± σ):      1.062 s ±  0.001 s    [User: 0.001 s, System: 0.000 s]
  Range (min … max):    1.060 s …  1.064 s    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image ran
    3.81 ± 0.08 times faster than target/release/candidate_8
    3.96 ± 0.08 times faster than target/release/candidate_9
    3.99 ± 0.10 times faster than target/release/candidate_7
    4.15 ± 0.10 times faster than target/release/candidate_6
    4.98 ± 0.05 times faster than target/release/candidate_10
    6.10 ± 0.12 times faster than target/release/candidate_5
    6.30 ± 0.22 times faster than target/release/candidate_4
    8.59 ± 0.20 times faster than target/release/candidate_2
    8.99 ± 0.26 times faster than target/release/candidate_1
   10.02 ± 0.23 times faster than target/release/candidate_3

8 is a bit faster than 7, but 7 is still 'kinda sane' safe rust code... Let's build on this.


##### Candiate 11, take 7 + get rid of xxhash

folkol@ubuntu:~/code/labs/1brc/onebrc$ sudo perf stat -ddd target/release/candidate_7
[sudo: authenticate] Password: 
total threads: 24
{Abha=-33.8/18.0/71.1, Abidjan=-23.6/26.0/77.3, Abéché=-23.2/29.4/78.4, Accra=-24.3/26.4/79.3, Addis Ababa=-34.5/16.0/64.9, Adelaide=-30.2/17.3/71.5, Aden=-20.4/29.1/79.8, Ahvaz=-25.4/25.4/73.8, Albuquerque=-39.2/14.0/66.5, Alexandra=-47.2/11.0/63.2, Alexandria=-31.4/20.0/68.1, Algiers=-32.1/18.2/69.8, Alice Springs=-30.5/21.0/68.0, Almaty=-45.3/10.0/58.1, Amsterdam=-40.1/10.2/59.0, Anadyr=-62.8/-6.9/41.8, Anchorage=-45.2/2.8/50.0, Andorra la Vella=-38.7/9.8/63.8, Ankara=-35.6/12.0/61.5, Antananarivo=-38.7/17.9/66.7, Antsiranana=-26.5/25.2/75.0, Arkhangelsk=-48.3/1.3/50.9, Ashgabat=-31.6/17.1/70.0, Asmara=-32.9/15.6/67.9, Assab=-16.7/30.5/77.9, Astana=-44.6/3.5/55.2, Athens=-31.2/19.2/66.6, Atlanta=-34.2/17.0/64.3, Auckland=-40.5/15.2/63.7, Austin=-30.0/20.7/71.6, Baghdad=-26.6/22.8/73.0, Baguio=-34.7/19.5/73.4, Baku=-42.1/15.1/66.5, Baltimore=-38.4/13.1/61.2, Bamako=-22.5/27.8/75.8, Bangkok=-22.3/28.6/78.2, Bangui=-26.7/26.0/73.9, Banjul=-23.0/26.0/74.9, Barcelona=-32.1/18.2/67.3, Bata=-22.9/25.1/76.3, Batumi=-32.6/14.0/64.5, Beijing=-37.7/12.9/60.8, Beirut=-31.0/20.9/69.9, Belgrade=-41.2/12.5/60.6, Belize City=-23.2/26.7/74.2, Benghazi=-34.4/19.9/67.0, Bergen=-39.9/7.7/55.5, Berlin=-40.4/10.3/67.7, Bilbao=-35.5/14.7/63.6, Birao=-29.1/26.5/77.4, Bishkek=-38.0/11.3/60.3, Bissau=-28.3/27.0/76.4, Blantyre=-25.6/22.2/71.8, Bloemfontein=-37.0/15.6/64.2, Boise=-35.2/11.4/59.5, Bordeaux=-33.0/14.2/66.0, Bosaso=-17.8/30.0/80.3, Boston=-36.8/10.9/71.6, Bouaké=-25.7/26.0/75.6, Bratislava=-39.0/10.5/61.6, Brazzaville=-29.1/25.0/73.2, Bridgetown=-21.9/27.0/76.9, Brisbane=-30.6/21.4/70.6, Brussels=-38.1/10.5/60.0, Bucharest=-42.1/10.8/60.8, Budapest=-41.3/11.3/61.7, Bujumbura=-24.1/23.8/72.8, Bulawayo=-31.9/18.9/74.1, Burnie=-34.0/13.1/63.7, Busan=-36.7/15.0/66.3, Cabo San Lucas=-25.5/23.9/72.3, Cairns=-26.3/25.0/74.1, Cairo=-29.7/21.4/72.6, Calgary=-46.0/4.4/55.7, Canberra=-36.7/13.1/66.9, Cape Town=-31.8/16.2/67.1, Changsha=-34.8/17.4/68.1, Charlotte=-36.6/16.1/66.8, Chiang Mai=-29.7/25.8/72.6, Chicago=-39.6/9.8/62.2, Chihuahua=-30.7/18.6/66.7, Chittagong=-26.0/25.9/82.7, Chișinău=-38.7/10.2/55.8, Chongqing=-33.8/18.6/66.7, Christchurch=-38.4/12.2/61.7, City of San Marino=-37.4/11.8/57.4, Colombo=-23.4/27.4/79.1, Columbus=-35.9/11.7/73.2, Conakry=-23.3/26.4/74.6, Copenhagen=-39.3/9.1/60.7, Cotonou=-21.0/27.2/80.1, Cracow=-44.9/9.3/58.3, Da Lat=-32.6/17.9/65.6, Da Nang=-24.8/25.8/75.6, Dakar=-27.6/24.0/73.8, Dallas=-31.3/19.0/70.2, Damascus=-32.9/17.0/64.2, Dampier=-20.4/26.4/77.5, Dar es Salaam=-25.5/25.8/73.2, Darwin=-26.1/27.6/79.0, Denpasar=-23.6/23.7/74.5, Denver=-39.7/10.4/62.4, Detroit=-43.4/10.0/63.1, Dhaka=-22.1/25.9/78.3, Dikson=-64.9/-11.1/39.5, Dili=-22.8/26.6/78.2, Djibouti=-19.0/29.9/84.4, Dodoma=-25.3/22.7/76.2, Dolisie=-24.4/24.0/76.6, Douala=-21.8/26.7/79.3, Dubai=-20.2/26.9/74.2, Dublin=-45.0/9.8/56.9, Dunedin=-44.3/11.1/63.1, Durban=-28.1/20.6/72.6, Dushanbe=-35.9/14.7/63.6, Edinburgh=-43.6/9.3/64.0, Edmonton=-45.4/4.2/52.4, El Paso=-31.7/18.1/65.7, Entebbe=-32.0/21.0/72.1, Erbil=-27.9/19.5/67.4, Erzurum=-42.6/5.1/55.2, Fairbanks=-49.7/-2.3/49.8, Fianarantsoa=-32.9/17.9/66.1, Flores,  Petén=-23.7/26.4/78.9, Frankfurt=-40.1/10.6/58.2, Fresno=-33.9/17.9/66.0, Fukuoka=-33.0/17.0/68.8, Gaborone=-27.4/21.0/68.8, Gabès=-29.9/19.5/67.4, Gagnoa=-25.9/26.0/74.5, Gangtok=-32.0/15.2/65.4, Garissa=-22.6/29.3/77.9, Garoua=-23.0/28.3/80.1, George Town=-22.0/27.9/80.3, Ghanzi=-25.5/21.4/74.6, Gjoa Haven=-64.0/-14.4/36.1, Guadalajara=-28.5/20.9/70.1, Guangzhou=-26.9/22.4/70.8, Guatemala City=-32.0/20.4/70.9, Halifax=-40.7/7.5/55.2, Hamburg=-38.3/9.7/59.7, Hamilton=-37.7/13.8/62.7, Hanga Roa=-29.0/20.5/71.8, Hanoi=-28.9/23.6/75.7, Harare=-37.7/18.4/71.6, Harbin=-48.2/5.0/60.7, Hargeisa=-26.4/21.7/68.6, Hat Yai=-22.5/27.0/74.9, Havana=-23.4/25.2/77.2, Helsinki=-45.7/5.9/60.0, Heraklion=-40.2/18.9/65.3, Hiroshima=-36.1/16.3/65.6, Ho Chi Minh City=-24.4/27.4/76.3, Hobart=-39.3/12.7/62.3, Hong Kong=-24.8/23.3/73.4, Honiara=-27.1/26.5/76.9, Honolulu=-24.1/25.4/74.2, Houston=-28.6/20.8/77.1, Ifrane=-39.4/11.4/63.2, Indianapolis=-42.1/11.8/64.6, Iqaluit=-56.3/-9.3/41.8, Irkutsk=-50.8/1.0/49.9, Istanbul=-40.4/13.9/61.7, Jacksonville=-30.9/20.3/67.6, Jakarta=-21.4/26.7/74.5, Jayapura=-24.6/27.0/79.6, Jerusalem=-30.4/18.3/70.2, Johannesburg=-34.8/15.5/68.2, Jos=-27.0/22.8/74.9, Juba=-19.9/27.8/78.6, Kabul=-38.6/12.1/60.0, Kampala=-31.5/20.0/67.9, Kandi=-23.4/27.7/79.0, Kankan=-23.2/26.5/81.6, Kano=-27.1/26.4/74.4, Kansas City=-39.3/12.5/62.0, Karachi=-27.1/26.0/75.5, Karonga=-29.7/24.4/70.6, Kathmandu=-34.1/18.3/67.6, Khartoum=-26.2/29.9/77.9, Kingston=-24.3/27.4/81.1, Kinshasa=-22.3/25.3/75.8, Kolkata=-22.0/26.7/79.8, Kuala Lumpur=-22.4/27.3/78.1, Kumasi=-20.9/26.0/76.0, Kunming=-33.5/15.7/69.3, Kuopio=-46.6/3.4/55.9, Kuwait City=-27.2/25.7/75.4, Kyiv=-42.3/8.4/57.5, Kyoto=-32.9/15.8/66.4, La Ceiba=-22.4/26.2/80.0, La Paz=-29.1/23.7/77.9, Lagos=-23.3/26.8/76.5, Lahore=-30.8/24.3/74.6, Lake Havasu City=-27.0/23.7/70.0, Lake Tekapo=-45.1/8.7/56.8, Las Palmas de Gran Canaria=-31.1/21.2/72.2, Las Vegas=-28.6/20.3/69.4, Launceston=-40.0/13.1/65.1, Lhasa=-43.5/7.6/63.7, Libreville=-23.3/25.9/76.1, Lisbon=-34.0/17.5/64.7, Livingstone=-27.7/21.8/72.2, Ljubljana=-42.6/10.9/60.3, Lodwar=-20.6/29.3/76.7, Lomé=-26.5/26.9/76.1, London=-35.9/11.3/59.5, Los Angeles=-34.2/18.6/70.0, Louisville=-36.0/13.9/67.5, Luanda=-26.2/25.8/77.2, Lubumbashi=-27.2/20.8/66.3, Lusaka=-32.0/19.9/70.8, Luxembourg City=-40.8/9.3/61.1, Lviv=-38.6/7.8/59.3, Lyon=-35.0/12.5/57.7, Madrid=-33.2/15.0/63.1, Mahajanga=-26.0/26.3/79.1, Makassar=-22.0/26.7/75.4, Makurdi=-27.2/26.0/81.2, Malabo=-22.2/26.3/77.7, Malé=-20.6/28.0/81.6, Managua=-25.6/27.3/75.2, Manama=-24.6/26.5/74.7, Mandalay=-22.0/28.0/78.6, Mango=-19.7/28.1/80.6, Manila=-20.7/28.4/80.6, Maputo=-25.0/22.8/72.2, Marrakesh=-27.4/19.6/68.8, Marseille=-32.8/15.8/64.9, Maun=-30.5/22.4/73.0, Medan=-26.2/26.5/78.0, Mek'ele=-26.6/22.7/77.8, Melbourne=-46.0/15.1/71.8, Memphis=-35.3/17.2/68.3, Mexicali=-24.8/23.1/75.3, Mexico City=-34.7/17.5/66.8, Miami=-25.3/24.9/73.5, Milan=-34.7/13.0/63.5, Milwaukee=-46.4/8.9/58.4, Minneapolis=-42.0/7.8/56.5, Minsk=-42.8/6.7/55.9, Mogadishu=-27.5/27.1/75.5, Mombasa=-23.1/26.3/72.7, Monaco=-34.4/16.4/65.2, Moncton=-40.1/6.1/59.1, Monterrey=-28.5/22.3/75.7, Montreal=-43.3/6.8/58.5, Moscow=-45.0/5.8/53.6, Mumbai=-19.6/27.1/76.5, Murmansk=-53.3/0.6/50.6, Muscat=-23.0/28.0/80.4, Mzuzu=-32.4/17.7/66.4, N'Djamena=-21.2/28.3/74.8, Naha=-30.1/23.1/74.6, Nairobi=-32.1/17.8/65.2, Nakhon Ratchasima=-24.6/27.3/80.1, Napier=-34.5/14.6/60.2, Napoli=-37.7/15.9/66.2, Nashville=-34.2/15.4/62.5, Nassau=-29.1/24.6/75.7, Ndola=-27.9/20.3/69.4, New Delhi=-30.5/25.0/74.9, New Orleans=-33.1/20.7/77.8, New York City=-37.6/12.9/63.8, Ngaoundéré=-30.2/22.0/75.7, Niamey=-26.6/29.3/79.4, Nicosia=-27.7/19.7/68.8, Niigata=-35.1/13.9/65.4, Nouadhibou=-30.4/21.3/72.7, Nouakchott=-24.9/25.7/73.9, Novosibirsk=-49.9/1.7/54.6, Nuuk=-48.8/-1.4/49.9, Odesa=-38.7/10.7/64.3, Odienné=-24.8/26.0/76.7, Oklahoma City=-31.6/15.9/64.8, Omaha=-39.6/10.6/60.8, Oranjestad=-26.4/28.1/78.1, Oslo=-45.8/5.7/54.8, Ottawa=-42.3/6.6/58.7, Ouagadougou=-20.4/28.3/80.3, Ouahigouya=-18.9/28.6/77.8, Ouarzazate=-30.9/18.9/81.8, Oulu=-45.8/2.7/53.3, Palembang=-20.5/27.3/76.0, Palermo=-35.6/18.5/72.9, Palm Springs=-29.0/24.5/73.2, Palmerston North=-37.8/13.2/63.0, Panama City=-21.2/28.0/77.2, Parakou=-23.3/26.8/77.6, Paris=-41.0/12.3/61.6, Perth=-34.9/18.7/70.0, Petropavlovsk-Kamchatsky=-45.6/1.9/51.1, Philadelphia=-42.3/13.2/64.2, Phnom Penh=-23.5/28.3/80.6, Phoenix=-27.5/23.9/74.1, Pittsburgh=-41.1/10.8/66.7, Podgorica=-36.2/15.3/68.1, Pointe-Noire=-21.2/26.1/76.8, Pontianak=-19.2/27.7/79.8, Port Moresby=-24.0/26.9/74.9, Port Sudan=-19.1/28.4/78.2, Port Vila=-28.2/24.3/71.3, Port-Gentil=-22.6/26.0/81.2, Portland (OR)=-37.2/12.4/64.9, Porto=-34.6/15.7/65.3, Prague=-43.5/8.4/56.4, Praia=-25.1/24.4/73.9, Pretoria=-32.1/18.2/68.7, Pyongyang=-36.5/10.8/62.1, Rabat=-31.8/17.2/65.1, Rangpur=-24.0/24.4/71.3, Reggane=-24.1/28.3/78.0, Reykjavík=-44.0/4.3/54.8, Riga=-46.4/6.2/53.0, Riyadh=-26.5/26.0/75.3, Rome=-37.8/15.2/64.4, Roseau=-22.7/26.2/76.4, Rostov-on-Don=-38.2/9.9/58.8, Sacramento=-37.6/16.3/65.8, Saint Petersburg=-43.3/5.8/53.8, Saint-Pierre=-46.9/5.7/57.1, Salt Lake City=-36.3/11.6/62.2, San Antonio=-28.4/20.8/68.9, San Diego=-30.2/17.8/65.7, San Francisco=-36.1/14.6/63.3, San Jose=-33.5/16.4/66.0, San José=-28.2/22.6/81.0, San Juan=-22.4/27.2/79.3, San Salvador=-27.5/23.1/71.8, Sana'a=-28.6/20.0/70.6, Santo Domingo=-21.4/25.9/78.2, Sapporo=-39.8/8.9/61.5, Sarajevo=-36.3/10.1/59.0, Saskatoon=-45.5/3.3/52.1, Seattle=-34.9/11.3/60.8, Seoul=-34.6/12.5/59.5, Seville=-28.2/19.2/71.0, Shanghai=-37.9/16.7/65.4, Singapore=-24.3/27.0/75.6, Skopje=-37.1/12.4/65.1, Sochi=-41.5/14.2/64.4, Sofia=-38.3/10.6/58.1, Sokoto=-19.5/28.0/76.0, Split=-33.0/16.1/65.9, St. John's=-45.8/5.0/54.4, St. Louis=-38.4/13.9/61.6, Stockholm=-43.3/6.6/61.4, Surabaya=-22.7/27.1/80.4, Suva=-25.5/25.6/75.4, Suwałki=-40.5/7.2/55.1, Sydney=-34.9/17.7/69.5, Ségou=-22.3/28.0/75.5, Tabora=-26.9/23.0/74.5, Tabriz=-35.0/12.6/63.8, Taipei=-28.6/23.0/75.9, Tallinn=-43.8/6.4/56.7, Tamale=-21.5/27.9/78.9, Tamanrasset=-24.9/21.7/73.8, Tampa=-24.2/22.9/72.1, Tashkent=-34.1/14.8/68.4, Tauranga=-34.4/14.8/62.9, Tbilisi=-35.7/12.9/63.7, Tegucigalpa=-29.4/21.7/72.5, Tehran=-31.7/17.0/65.1, Tel Aviv=-32.2/20.0/67.5, Thessaloniki=-35.8/16.0/67.4, Thiès=-28.4/24.0/75.5, Tijuana=-31.2/17.8/71.6, Timbuktu=-20.7/28.0/75.4, Tirana=-34.9/15.2/66.1, Toamasina=-27.0/23.4/72.7, Tokyo=-33.2/15.4/61.9, Toliara=-26.0/24.1/78.0, Toluca=-39.8/12.4/67.9, Toronto=-40.4/9.4/62.2, Tripoli=-28.2/20.0/68.7, Tromsø=-45.0/2.9/54.5, Tucson=-31.0/20.9/71.0, Tunis=-29.8/18.4/68.3, Ulaanbaatar=-50.6/-0.4/47.6, Upington=-27.6/20.4/70.6, Vaduz=-42.2/10.1/59.0, Valencia=-28.5/18.3/71.9, Valletta=-30.3/18.8/68.7, Vancouver=-40.3/10.4/63.5, Veracruz=-21.7/25.4/73.2, Vienna=-42.7/10.4/59.5, Vientiane=-23.7/25.9/73.1, Villahermosa=-20.9/27.1/79.3, Vilnius=-47.1/6.0/55.3, Virginia Beach=-34.2/15.8/69.8, Vladivostok=-43.8/4.9/54.0, Warsaw=-37.1/8.5/60.0, Washington, D.C.=-36.6/14.6/62.5, Wau=-22.2/27.8/76.1, Wellington=-37.5/12.9/64.0, Whitehorse=-49.8/-0.1/59.8, Wichita=-34.0/13.9/65.8, Willemstad=-29.4/28.0/78.5, Winnipeg=-47.4/3.0/55.2, Wrocław=-37.7/9.6/60.3, Xi'an=-37.1/14.1/62.4, Yakutsk=-61.5/-8.8/39.4, Yangon=-20.8/27.5/78.5, Yaoundé=-25.4/23.8/74.6, Yellowknife=-58.3/-4.3/44.8, Yerevan=-35.5/12.4/70.4, Yinchuan=-47.9/9.0/61.2, Zagreb=-41.8/10.7/60.5, Zanzibar City=-21.8/26.0/78.9, Zürich=-41.5/9.3/59.8, Ürümqi=-40.6/7.4/58.6, İzmir=-29.6/17.9/71.1}

 Performance counter stats for 'target/release/candidate_7':

    18,766,988,967      task-clock                       #   23.855 CPUs utilized             
               862      context-switches                 #   45.932 /sec                      
                13      cpu-migrations                   #    0.693 /sec                      
           211,560      page-faults                      #   11.273 K/sec                     
   250,723,865,620      cpu_atom/instructions/           #    2.85  insn per cycle              (35.27%)
   322,405,120,876      cpu_core/instructions/           #    3.25  insn per cycle              (30.73%)
    87,929,881,202      cpu_atom/cycles/                 #    4.685 GHz                         (35.29%)
    99,275,381,422      cpu_core/cycles/                 #    5.290 GHz                         (30.75%)
    47,036,491,078      cpu_atom/branches/               #    2.506 G/sec                       (35.32%)
    60,498,507,418      cpu_core/branches/               #    3.224 G/sec                       (30.77%)
       720,358,660      cpu_atom/branch-misses/          #    1.53% of all branches             (35.32%)
       980,743,398      cpu_core/branch-misses/          #    1.62% of all branches             (28.22%)
 #     26.1 %  tma_backend_bound        (35.31%)
 #     26.8 %  tma_backend_bound      
                                                  #     27.7 %  tma_bad_speculation    
                                                  #      8.9 %  tma_frontend_bound     
                                                  #     36.6 %  tma_retiring             (30.78%)
 #      0.0 %  tma_retiring             (35.31%)
 #     32.0 %  tma_bad_speculation    
                                                  #      0.0 %  tma_frontend_bound       (35.31%)
    54,266,484,392      cpu_atom/L1-dcache-loads/        #    2.892 G/sec                       (39.23%)
    66,626,010,765      cpu_core/L1-dcache-loads/        #    3.550 G/sec                       (30.78%)
        90,408,299      cpu_core/L1-dcache-load-misses/  #    0.14% of all L1-dcache accesses   (30.78%)
         1,908,739      cpu_atom/LLC-loads/              #  101.707 K/sec                       (35.30%)
         5,344,483      cpu_core/LLC-loads/              #  284.781 K/sec                       (30.78%)
               192      cpu_atom/LLC-load-misses/        #    0.01% of all LL-cache accesses    (35.27%)
         3,212,480      cpu_core/LLC-load-misses/        #   60.11% of all LL-cache accesses    (30.78%)
    84,434,507,639      cpu_atom/L1-icache-loads/        #    4.499 G/sec                       (35.27%)
        26,630,533      cpu_atom/L1-icache-load-misses/  #    0.03% of all L1-icache accesses   (35.28%)
         6,853,464      cpu_core/L1-icache-load-misses/                                         (30.78%)
    54,301,889,399      cpu_atom/dTLB-loads/             #    2.893 G/sec                       (35.27%)
    66,643,258,519      cpu_core/dTLB-loads/             #    3.551 G/sec                       (30.78%)
           247,512      cpu_atom/dTLB-load-misses/       #    0.00% of all dTLB cache accesses  (35.27%)
         1,414,934      cpu_core/dTLB-load-misses/       #    0.00% of all dTLB cache accesses  (30.77%)
            18,408      cpu_atom/iTLB-load-misses/                                              (31.35%)
        12,566,040      cpu_core/iTLB-load-misses/                                              (28.15%)

       0.786694586 seconds time elapsed

       0.000995000 seconds user
       0.000000000 seconds sys

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{7,11}
Benchmark 1: target/release/candidate_7
  Time (mean ± σ):     811.5 ms ±  16.8 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   790.7 ms … 852.2 ms    10 runs
 
Benchmark 2: target/release/candidate_11
  Time (mean ± σ):     855.7 ms ±  18.8 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   836.1 ms … 894.2 ms    10 runs
 
Summary
  target/release/candidate_7 ran
    1.05 ± 0.03 times faster than target/release/candidate_11


##### Candidate 12, new attempt of fast hash

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{7,12}
Benchmark 1: target/release/candidate_7
  Time (mean ± σ):     813.1 ms ±  27.2 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   768.3 ms … 851.5 ms    10 runs
 
Benchmark 2: target/release/candidate_12
  Time (mean ± σ):     673.7 ms ±  10.7 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   657.9 ms … 689.9 ms    10 runs
 
Summary
  target/release/candidate_12 ran
    1.21 ± 0.04 times faster than target/release/candidate_7

New fastest!



##### Candidate 13, implement resize so that we can start with smaller tables

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{12,13}
Benchmark 1: target/release/candidate_12
  Time (mean ± σ):     666.2 ms ±  10.0 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   649.5 ms … 682.7 ms    10 runs
 
Benchmark 2: target/release/candidate_13
  Time (mean ± σ):     775.8 ms ±  25.7 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   756.1 ms … 834.6 ms    10 runs
 
  Warning: The first benchmarking run for this command was significantly slower than the rest (834.6 ms). This could be caused by (filesystem) caches that were not filled until after the first run. You should consider using the '--warmup' option to fill those caches before the actual benchmark. Alternatively, use the '--prepare' option to clear the caches before each timing run.
 
Summary
  target/release/candidate_12 ran
    1.16 ± 0.04 times faster than target/release/candidate_13


Slower, back to 12



#### Candidate 14, remove some bounds checks

BArely faster:

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{12,14}
Benchmark 1: target/release/candidate_12
  Time (mean ± σ):     670.9 ms ±  13.5 ms    [User: 0.4 ms, System: 0.6 ms]
  Range (min … max):   656.6 ms … 698.3 ms    10 runs
 
Benchmark 2: target/release/candidate_14
  Time (mean ± σ):     659.9 ms ±   9.3 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   652.0 ms … 680.2 ms    10 runs
 
Summary
  target/release/candidate_14 ran
    1.02 ± 0.02 times faster than target/release/candidate_12


##### Candidate 15, tried lower load factor

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_{14,15}
Benchmark 1: target/release/candidate_14
  Time (mean ± σ):     649.6 ms ±  12.6 ms    [User: 0.3 ms, System: 0.7 ms]
  Range (min … max):   621.3 ms … 670.2 ms    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 2: target/release/candidate_15
  Time (mean ± σ):     670.2 ms ±  43.9 ms    [User: 0.4 ms, System: 0.8 ms]
  Range (min … max):   643.8 ms … 789.9 ms    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Summary
  target/release/candidate_14 ran
    1.03 ± 0.07 times faster than target/release/candidate_15


#### Candidate 16, better scanning + parsing

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ./target/release/candidate_1{4,6}
Benchmark 1: ./target/release/candidate_14
  Time (mean ± σ):     648.5 ms ±  14.1 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   622.2 ms … 675.2 ms    10 runs
 
Benchmark 2: ./target/release/candidate_16
  Time (mean ± σ):     558.3 ms ±  18.1 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   536.0 ms … 581.3 ms    10 runs
 
Summary
  ./target/release/candidate_16 ran
    1.16 ± 0.05 times faster than ./target/release/candidate_14



##### Candidate 17, less copying of data in get_or_insert

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ./target/release/candidate_1{6,7}
Benchmark 1: ./target/release/candidate_16
  Time (mean ± σ):     550.8 ms ±  12.7 ms    [User: 0.5 ms, System: 0.4 ms]
  Range (min … max):   533.6 ms … 582.2 ms    10 runs
 
Benchmark 2: ./target/release/candidate_17
  Time (mean ± σ):     542.1 ms ±  15.5 ms    [User: 0.6 ms, System: 0.5 ms]
  Range (min … max):   526.0 ms … 565.8 ms    10 runs
 
Summary
  ./target/release/candidate_17 ran
    1.02 ± 0.04 times faster than ./target/release/candidate_16


##### Candidate 18, branchless parsing + less copying

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ../java-orig/target/CalculateAverage_thomaswue_image ./target/release/candidate_{17,18}
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):     213.1 ms ±   3.0 ms    [User: 0.7 ms, System: 2.1 ms]
  Range (min … max):   208.4 ms … 219.8 ms    14 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 2: ./target/release/candidate_17
  Time (mean ± σ):     543.0 ms ±  13.1 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   525.3 ms … 565.6 ms    10 runs
 
Benchmark 3: ./target/release/candidate_18
  Time (mean ± σ):     518.2 ms ±  13.0 ms    [User: 0.6 ms, System: 0.3 ms]
  Range (min … max):   503.5 ms … 541.7 ms    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image ran
    2.43 ± 0.07 times faster than ./target/release/candidate_18
    2.55 ± 0.07 times faster than ./target/release/candidate_17



##### Candidate 19

Single-pass for both delimiters

slower


##### Candidate 20

Updated scanner 

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ./target/release/candidate_{18,20}
Benchmark 1: ./target/release/candidate_18
  Time (mean ± σ):     523.0 ms ±  15.0 ms    [User: 0.4 ms, System: 0.7 ms]
  Range (min … max):   502.4 ms … 546.9 ms    10 runs
 
Benchmark 2: ./target/release/candidate_20
  Time (mean ± σ):     514.4 ms ±  10.9 ms    [User: 0.5 ms, System: 0.5 ms]
  Range (min … max):   500.6 ms … 536.2 ms    10 runs
 
Summary
  ./target/release/candidate_20 ran
    1.02 ± 0.04 times faster than ./target/release/candidate_18


#### Candidate 21, trying 3 cursors again

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ./target/release/candidate_{20,21}
Benchmark 1: ./target/release/candidate_20
  Time (mean ± σ):     515.0 ms ±  15.8 ms    [User: 0.4 ms, System: 0.5 ms]
  Range (min … max):   495.6 ms … 540.2 ms    10 runs
 
Benchmark 2: ./target/release/candidate_21
  Time (mean ± σ):     498.5 ms ±   5.7 ms    [User: 0.5 ms, System: 0.7 ms]
  Range (min … max):   491.2 ms … 508.8 ms    10 runs
 
Summary
  ./target/release/candidate_21 ran
    1.03 ± 0.03 times faster than ./target/release/candidate_20



#### Candidate 22, better NameTable (Fingerprint in slot to avoid checking entries)


folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ../java-orig/target/CalculateAverage_thomaswue_image ./target/release/candidate_{21,22}
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):     214.2 ms ±   2.6 ms    [User: 0.9 ms, System: 2.0 ms]
  Range (min … max):   208.0 ms … 217.1 ms    14 runs
 
Benchmark 2: ./target/release/candidate_21
  Time (mean ± σ):     499.2 ms ±   8.6 ms    [User: 0.4 ms, System: 0.6 ms]
  Range (min … max):   484.6 ms … 520.1 ms    10 runs
 
  Warning: The first benchmarking run for this command was significantly slower than the rest (520.1 ms). This could be caused by (filesystem) caches that were not filled until after the first run. You should consider using the '--warmup' option to fill those caches before the actual benchmark. Alternatively, use the '--prepare' option to clear the caches before each timing run.
 
Benchmark 3: ./target/release/candidate_22
  Time (mean ± σ):     519.2 ms ±   8.9 ms    [User: 0.4 ms, System: 0.7 ms]
  Range (min … max):   504.2 ms … 534.1 ms    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image ran
    2.33 ± 0.05 times faster than ./target/release/candidate_21


Slower...



##### pgo test

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine target/release/candidate_21 target/x86_64-unknown-linux-gnu/release/candidate_21
Benchmark 1: target/release/candidate_21
  Time (mean ± σ):     493.9 ms ±  13.2 ms    [User: 0.6 ms, System: 0.5 ms]
  Range (min … max):   478.0 ms … 520.9 ms    10 runs
 
Benchmark 2: target/x86_64-unknown-linux-gnu/release/candidate_21
  Time (mean ± σ):     524.2 ms ±   9.0 ms    [User: 0.6 ms, System: 0.5 ms]
  Range (min … max):   515.2 ms … 539.1 ms    10 runs
 
Summary
  target/release/candidate_21 ran
    1.06 ± 0.03 times faster than target/x86_64-unknown-linux-gnu/release/candidate_21


Not faster.

##### Candidate recap

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine ../java-orig/target/CalculateAverage_thomaswue_image target/release/candidate_{1..22}
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):     214.6 ms ±   2.4 ms    [User: 1.1 ms, System: 1.8 ms]
  Range (min … max):   211.9 ms … 219.2 ms    13 runs
 
Benchmark 2: target/release/candidate_1
  Time (mean ± σ):      1.907 s ±  0.038 s    [User: 0.000 s, System: 0.001 s]
  Range (min … max):    1.853 s …  1.964 s    10 runs
 
Benchmark 3: target/release/candidate_2
  Time (mean ± σ):      1.853 s ±  0.086 s    [User: 0.000 s, System: 0.001 s]
  Range (min … max):    1.732 s …  2.012 s    10 runs
 
Benchmark 4: target/release/candidate_3
  Time (mean ± σ):      2.077 s ±  0.031 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    2.051 s …  2.120 s    10 runs
 
Benchmark 5: target/release/candidate_4
  Time (mean ± σ):      1.304 s ±  0.032 s    [User: 0.001 s, System: 0.000 s]
  Range (min … max):    1.268 s …  1.376 s    10 runs
 
Benchmark 6: target/release/candidate_5
  Time (mean ± σ):      1.288 s ±  0.026 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    1.246 s …  1.333 s    10 runs
 
Benchmark 7: target/release/candidate_6
  Time (mean ± σ):     878.1 ms ±  14.5 ms    [User: 0.4 ms, System: 0.7 ms]
  Range (min … max):   859.0 ms … 905.9 ms    10 runs
 
Benchmark 8: target/release/candidate_7
  Time (mean ± σ):     846.4 ms ±  16.0 ms    [User: 0.4 ms, System: 0.8 ms]
  Range (min … max):   831.9 ms … 879.2 ms    10 runs
 
Benchmark 9: target/release/candidate_8
  Time (mean ± σ):     812.4 ms ±  17.2 ms    [User: 0.5 ms, System: 0.7 ms]
  Range (min … max):   795.5 ms … 842.0 ms    10 runs
 
Benchmark 10: target/release/candidate_9
  Time (mean ± σ):     849.9 ms ±  20.2 ms    [User: 0.6 ms, System: 0.5 ms]
  Range (min … max):   822.5 ms … 877.6 ms    10 runs
 
Benchmark 11: target/release/candidate_10
  Time (mean ± σ):      1.063 s ±  0.001 s    [User: 0.001 s, System: 0.000 s]
  Range (min … max):    1.062 s …  1.065 s    10 runs
 
Benchmark 12: target/release/candidate_11
  Time (mean ± σ):     866.6 ms ±  30.9 ms    [User: 0.4 ms, System: 0.6 ms]
  Range (min … max):   830.2 ms … 912.2 ms    10 runs
 
Benchmark 13: target/release/candidate_12
  Time (mean ± σ):     673.2 ms ±  22.1 ms    [User: 0.5 ms, System: 0.6 ms]
  Range (min … max):   642.9 ms … 709.1 ms    10 runs
 
Benchmark 14: target/release/candidate_13
  Time (mean ± σ):     712.4 ms ±  15.6 ms    [User: 0.4 ms, System: 0.8 ms]
  Range (min … max):   698.4 ms … 746.4 ms    10 runs
 
Benchmark 15: target/release/candidate_14
  Time (mean ± σ):     699.7 ms ±  13.4 ms    [User: 0.5 ms, System: 0.8 ms]
  Range (min … max):   677.3 ms … 718.0 ms    10 runs
 
Benchmark 16: target/release/candidate_15
  Time (mean ± σ):     698.4 ms ±  19.7 ms    [User: 0.4 ms, System: 0.8 ms]
  Range (min … max):   678.3 ms … 739.6 ms    10 runs
 
Benchmark 17: target/release/candidate_16
  Time (mean ± σ):     579.7 ms ±  11.6 ms    [User: 0.6 ms, System: 0.7 ms]
  Range (min … max):   570.4 ms … 605.3 ms    10 runs
 
Benchmark 18: target/release/candidate_17
  Time (mean ± σ):     574.8 ms ±  17.5 ms    [User: 0.6 ms, System: 0.5 ms]
  Range (min … max):   557.3 ms … 615.7 ms    10 runs
 
Benchmark 19: target/release/candidate_18
  Time (mean ± σ):     551.8 ms ±  13.4 ms    [User: 0.6 ms, System: 0.6 ms]
  Range (min … max):   535.8 ms … 571.4 ms    10 runs
 
Benchmark 20: target/release/candidate_19
  Time (mean ± σ):     575.6 ms ±  16.5 ms    [User: 0.4 ms, System: 0.8 ms]
  Range (min … max):   554.4 ms … 613.3 ms    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 21: target/release/candidate_20
  Time (mean ± σ):     571.1 ms ±  12.3 ms    [User: 0.5 ms, System: 0.7 ms]
  Range (min … max):   557.2 ms … 593.0 ms    10 runs
 
Benchmark 22: target/release/candidate_21
  Time (mean ± σ):     529.7 ms ±   8.4 ms    [User: 0.4 ms, System: 0.7 ms]
  Range (min … max):   519.2 ms … 548.6 ms    10 runs
 
Benchmark 23: target/release/candidate_22
  Time (mean ± σ):     545.6 ms ±  12.6 ms    [User: 0.5 ms, System: 0.7 ms]
  Range (min … max):   531.5 ms … 563.2 ms    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image ran
    2.47 ± 0.05 times faster than target/release/candidate_21
    2.54 ± 0.07 times faster than target/release/candidate_22
    2.57 ± 0.07 times faster than target/release/candidate_18
    2.66 ± 0.06 times faster than target/release/candidate_20
    2.68 ± 0.09 times faster than target/release/candidate_17
    2.68 ± 0.08 times faster than target/release/candidate_19
    2.70 ± 0.06 times faster than target/release/candidate_16
    3.14 ± 0.11 times faster than target/release/candidate_12
    3.26 ± 0.10 times faster than target/release/candidate_15
    3.26 ± 0.07 times faster than target/release/candidate_14
    3.32 ± 0.08 times faster than target/release/candidate_13
    3.79 ± 0.09 times faster than target/release/candidate_8
    3.94 ± 0.09 times faster than target/release/candidate_7
    3.96 ± 0.10 times faster than target/release/candidate_9
    4.04 ± 0.15 times faster than target/release/candidate_11
    4.09 ± 0.08 times faster than target/release/candidate_6
    4.96 ± 0.06 times faster than target/release/candidate_10
    6.00 ± 0.14 times faster than target/release/candidate_5
    6.08 ± 0.16 times faster than target/release/candidate_4
    8.64 ± 0.41 times faster than target/release/candidate_2
    8.89 ± 0.20 times faster than target/release/candidate_1
    9.68 ± 0.18 times faster than target/release/candidate_3



##### Try direct port of thomaswue java solution

- using slice with offsets instead of pointers... maybe
- using memchr instead of manual loop for 'next newline', criterion says they are equivalent
- 





#### TODO: when we have a final working program, rewrite it with rayon / ahash and see where it takes us




##### Experiment with artisonkorzun

- 1 scanner instead of 3

folkol@ubuntu:~/code/labs/1brc/java-orig$ hyperfine --warmup 10 target/CalculateAverage_artsiomkorzun_image*
Benchmark 1: target/CalculateAverage_artsiomkorzun_image
  Time (mean ± σ):     218.4 ms ±   1.1 ms    [User: 0.4 ms, System: 2.5 ms]
  Range (min … max):   216.8 ms … 220.2 ms    13 runs
 
Benchmark 2: target/CalculateAverage_artsiomkorzun_image_one_scanner
  Time (mean ± σ):     217.8 ms ±   1.2 ms    [User: 0.6 ms, System: 2.3 ms]
  Range (min … max):   216.0 ms … 220.4 ms    13 runs
 
Summary
  target/CalculateAverage_artsiomkorzun_image_one_scanner ran
    1.00 ± 0.01 times faster than target/CalculateAverage_artsiomkorzun_image

No difference on my computer. (Maybe because of no hardware threads?)


##### Ported thomaswue to rust

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 5 ../java-orig/target/CalculateAverage_{thomaswue,artsiomkorzun}_image target/release/thomaswue_ported
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):     215.1 ms ±   2.6 ms    [User: 0.3 ms, System: 2.5 ms]
  Range (min … max):   211.8 ms … 221.7 ms    14 runs
 
Benchmark 2: ../java-orig/target/CalculateAverage_artsiomkorzun_image
  Time (mean ± σ):     221.6 ms ±   1.5 ms    [User: 0.8 ms, System: 2.0 ms]
  Range (min … max):   219.5 ms … 225.7 ms    13 runs
 
Benchmark 3: target/release/thomaswue_ported
  Time (mean ± σ):     509.6 ms ±   5.3 ms    [User: 9616.2 ms, System: 407.8 ms]
  Range (min … max):   505.9 ms … 524.3 ms    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image ran
    1.03 ± 0.01 times faster than ../java-orig/target/CalculateAverage_artsiomkorzun_image
    2.37 ± 0.04 times faster than target/release/thomaswue_ported


###### Robot-guided investiation plan

You need to stop guessing and **measure where the extra 300 ms comes from**. The good news: with your code style, the slowdown is almost always one of:

1. **loads** (safe slice→array copies vs Java Unsafe)
2. **bounds checks / method call overhead** in the inner loop
3. **missed inlining / missed vector-ish optimizations**
4. **hash table layout / Option<Result> costs** (extra branches + pointer chasing)

Here’s a concrete investigation plan + the most likely fix.

---

## 1) First: locate the hotspot in Rust (not Java)

Run:

```bash
perf record -F 999 -g --call-graph dwarf target/release/thomaswue_ported
perf report
```

What you’re looking for in the top frames:

* `Scanner::get_u64_at` / `get_long_at`
* `find_delimiter`
* your collision-compare loop
* any `core::slice` / `copy_nonoverlapping` / `try_into` / `from_le_bytes`
* any `Option` handling / `unwrap` / bounds-check helpers

If your report shows **`get_u64_at` or slice copy** dominating, you’ve basically found the 2×.

---

## 2) The #1 usual culprit: safe 8-byte loads copy + bounds checks

Java version is effectively:

* `*(long*)(base + pos)` (unsafe, unaligned ok on x86)
* minimal checks

Your safe Rust commonly ends up doing:

* bounds checks
* slice creation
* `try_into()` (copy)
* `from_le_bytes` (more work than a raw load)

Even if LLVM optimizes *some* of it, it often doesn’t become “one load”.

### Fix: make `get_u64_at` a raw unaligned load (fast path) + padded tail (slow path)

```rust
#[inline(always)]
fn get_u64_at(&self, pos: usize) -> u64 {
    let len = self.data.len();

    // Fast path: enough bytes -> one unaligned load
    if pos + 8 <= len {
        unsafe {
            let p = self.data.as_ptr().add(pos) as *const u64;
            u64::from_le(p.read_unaligned())
        }
    } else {
        // Tail: pad with 0
        let mut tmp = [0u8; 8];
        let avail = len.saturating_sub(pos);
        if avail != 0 {
            tmp[..avail].copy_from_slice(&self.data[pos..]);
        }
        u64::from_le_bytes(tmp)
    }
}
```

This is the single change that most often takes a Rust port from “2× slower” to “close”.

If you already did something like this earlier in your fastest version, that’s why it matches.

---

## 3) Next likely culprit: extra bounds checks in the inner compare loop

Your collision loop does two loads per iteration:

```rust
scanner.get_u64_at(existing.name_address + i)
scanner.get_u64_at(name_address + i)
```

Each call can redo bounds logic, and LLVM might not hoist checks because:

* `pos` is not obviously in-range
* method calls obscure relationships
* tail-padding semantics prevent simple “trust me” assumptions

### Fix: use raw pointers *inside* the known-safe region

You know these reads never go out of bounds if you ensured a sentinel / safe padding strategy (Java relied on it).

Pattern:

```rust
#[inline(always)]
unsafe fn read_u64_unchecked(base: *const u8, pos: usize) -> u64 {
    u64::from_le((base.add(pos) as *const u64).read_unaligned())
}
```

Then in the hot loop, pass `base = scanner.data.as_ptr()` once, and do unchecked loads. Keep one bounds-checked path for the last page / file end if you must.

(If you don’t have sentinel bytes at end-of-file, keep your “super-slow path” for the end region and make the fast path unchecked.)

---

## 4) Ensure inlining actually happens

Put `#[inline(always)]` on:

* `Scanner::pos()`, `Scanner::add()`
* `Scanner::get_u64_at()`
* `find_delimiter`
* `scan_number`
* `convert_into_number_i16`
* `hash_to_index`

Then rebuild with the “make LLVM’s life easy” flags:

```toml
# Cargo.toml
[profile.release]
lto = "fat"
codegen-units = 1
panic = "abort"
opt-level = 3
debug = 1          # keep symbols for perf, doesn’t hurt much
```

And run with `RUSTFLAGS="-C target-cpu=native"`.

---

## 5) Compare instruction count, not just time

This tells you immediately if Rust is doing more work per byte:

```bash
perf stat -d target/release/thomaswue_ported
perf stat -d ../java-orig/target/CalculateAverage_thomaswue_image
```

Key comparisons:

* `instructions` (Rust usually higher if loads aren’t a single instruction)
* `branches` and `branch-misses`
* `L1-dcache-load-misses` (if your hash table layout is worse)

If Rust has ~2× instructions, it’s almost certainly your load/compare machinery, not “Rust overhead”.

---

## 6) One more sneaky difference: your padded-tail semantics can pessimize everything

If your `get_u64_at` supports tail padding **everywhere**, LLVM can’t assume “in-bounds” and may keep checks. Java’s `Unsafe.getLong` simply reads; correctness is achieved by ensuring safe mapped padding / avoiding end-of-file area.

So: keep **two APIs**:

* `get_u64_unchecked(pos)` for fast path (requires padding / safe region)
* `get_u64_at(pos)` safe for the end region

And make the algorithm choose based on `pos < file_end - 120` like you already do.

---

## What I’d do first (highest ROI)

1. `perf report` on Rust → confirm top symbol(s)
2. switch `get_u64_at` to `read_unaligned` fast path
3. re-run hyperfine

If you paste the top ~15 lines of `perf report` for the Rust binary (the table with Self%), I’ll tell you exactly which of the above is biting you and what change will move the needle most.


##### speed up my hot loop

- use unsafe to get rid of bounds checks (when we are not near the end of the mmap area)
- reduce the size of the hash table so we don't miss cache as much when probing

Minor differences -- but faster


##### Next steps

Compare with one thread:

folkol@ubuntu:~/code/labs/1brc/onebrc$ taskset -c 0 hyperfine --warmup 2   '../java-orig/target/CalculateAverage_thomaswue_image'   'target/release/thomaswue_ported'
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):      4.226 s ±  0.023 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    4.199 s …  4.275 s    10 runs
 
Benchmark 2: target/release/thomaswue_ported
  Time (mean ± σ):      8.926 s ±  0.013 s    [User: 8.635 s, System: 0.281 s]
  Range (min … max):    8.905 s …  8.948 s    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image ran
    2.11 ± 0.01 times faster than target/release/thomaswue_ported


After fixing parent spawn bug:

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 3   '../java-orig/target/CalculateAverage_thomaswue_image --worker'   'target/release/thomaswue_ported --worker'
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image --worker
  Time (mean ± σ):     288.5 ms ±   2.2 ms    [User: 4556.4 ms, System: 351.5 ms]
  Range (min … max):   286.7 ms … 294.3 ms    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 2: target/release/thomaswue_ported --worker
  Time (mean ± σ):     443.8 ms ±   4.6 ms    [User: 8213.0 ms, System: 337.9 ms]
  Range (min … max):   439.3 ms … 455.6 ms    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image --worker ran
    1.54 ± 0.02 times faster than target/release/thomaswue_ported --worker


folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 3   '../java-orig/target/CalculateAverage_thomaswue_image'   'target/release/thomaswue_ported'
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):     214.4 ms ±   2.6 ms    [User: 0.5 ms, System: 2.3 ms]
  Range (min … max):   211.9 ms … 220.3 ms    14 runs
 
Benchmark 2: target/release/thomaswue_ported
  Time (mean ± σ):     372.9 ms ±  13.3 ms    [User: 0.5 ms, System: 0.4 ms]
  Range (min … max):   361.2 ms … 403.6 ms    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image ran
    1.74 ± 0.07 times faster than target/release/thomaswue_ported


folkol@ubuntu:~/code/labs/1brc/onebrc$ NUM_THREADS=1 hyperfine --warmup 3   '../java-orig/target/CalculateAverage_thomaswue_image'   'target/release/thomaswue_ported'
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image
  Time (mean ± σ):      4.165 s ±  0.097 s    [User: 0.001 s, System: 0.002 s]
  Range (min … max):    3.941 s …  4.269 s    10 runs
 
Benchmark 2: target/release/thomaswue_ported
  Time (mean ± σ):      8.525 s ±  0.040 s    [User: 0.001 s, System: 0.001 s]
  Range (min … max):    8.440 s …  8.558 s    10 runs
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image ran
    2.05 ± 0.05 times faster than target/release/thomaswue_ported



folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine '../java-orig/target/CalculateAverage_thomaswue_image --worker' 'target/release/thomaswue_ported --worker'
Benchmark 1: ../java-orig/target/CalculateAverage_thomaswue_image --worker
  Time (mean ± σ):     289.9 ms ±   3.1 ms    [User: 4542.2 ms, System: 351.8 ms]
  Range (min … max):   287.2 ms … 294.9 ms    10 runs
 
Benchmark 2: target/release/thomaswue_ported --worker
  Time (mean ± σ):     426.6 ms ±   9.3 ms    [User: 7678.7 ms, System: 349.4 ms]
  Range (min … max):   422.6 ms … 452.9 ms    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Summary
  ../java-orig/target/CalculateAverage_thomaswue_image --worker ran
    1.47 ± 0.04 times faster than target/release/thomaswue_ported --worker



##### Experiment: split record into name and stats to get better locality

Slight improvement, still ~60 ms off.


##### Experiment: register spilling?

cargo asm -r --bin thomaswue_ported thomaswue_ported::find_result_unsafe_idx
cargo asm -r --bin thomaswue_ported thomaswue_ported::scan_number_unsafe
cargo asm -r --bin thomaswue_ported thomaswue_ported::Result::record

(or objdump -d --demangle target/release/thomaswue_ported | less)

2) What “spilling” looks like in assembly

You’re looking for stack traffic in the hot loop body:

stores to stack:

mov [rsp+0x..], r..

vmovdqu [rsp+0x..], ymm.. (if SIMD)

loads from stack:

mov r.., [rsp+0x..]

lots of push/pop inside the hot loop

A few stack stores in the function prologue/epilogue (saving callee-saved regs) is normal. Spilling is when you see stack loads/stores repeatedly in the loop body.

Rule of thumb: if the inner loop contains [rsp+...] memory operands that aren’t just once at entry/exit, you have spilling.

RUSTFLAGS="-C opt-level=3 -C debuginfo=1 -C codegen-units=1 -C lto=fat -C llvm-args=-print-after=greedy" \
  cargo build -r --bin thomaswue_ported 2> /tmp/regalloc.txt

rg -n "spill|spills|reload" /tmp/regalloc.txt | head


perf stat -e \
  mem_inst_retired.all_loads,mem_inst_retired.all_stores, \
  cpu_core/cycles/,cpu_core/instructions/ \
  target/release/thomaswue_ported --worker >/dev/null


5) If you do find spilling, how to fix it (targeted)

For your codebase, spilling usually comes from:

too many live temporaries inside find_result_unsafe_idx

holding &mut references too long (aliasing)

inlining large helpers + metrics counters

mixed “slow path” code making live ranges long

Fix patterns:

split find_result_unsafe_idx into 2–3 smaller functions (fast path / slow scan / probe loop)

shorten live ranges with scopes:

let idx = { ... }; // let temporaries die here


avoid keeping hash, cmp_w1, cmp_w2, name_length, mask, etc. live across the probe loop if you can recompute cheaply or move them into a struct

But don’t do any of that until you’ve confirmed spills in asm.

---

cargo build --release --bin thomaswue_ported

folkol@ubuntu:~/code/labs/1brc/onebrc$ cargo asm --version
cargo-asm 0.1.16


folkol@ubuntu:~/code/labs/1brc/onebrc$ cargo uninstall cargo-asm
    Removing /home/folkol/.cargo/bin/cargo-asm
    Removing /home/folkol/.cargo/bin/cargo-llvm-ir
folkol@ubuntu:~/code/labs/1brc/onebrc$ cargo install cargo-show-asm


#### Try build std from source

rustup toolchain install nightly
rustup component add rust-src --toolchain nightly
cargo +nightly build -Z build-std=std,panic_abort --release --bin thomaswue_ported

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 2 './stable --worker' 'target/release/thomaswue_ported --worker'
Benchmark 1: ./stable --worker
  Time (mean ± σ):     429.1 ms ±   0.8 ms    [User: 7789.5 ms, System: 348.5 ms]
  Range (min … max):   427.8 ms … 430.4 ms    10 runs
 
Benchmark 2: target/release/thomaswue_ported --worker
  Time (mean ± σ):     449.8 ms ±   0.8 ms    [User: 8296.4 ms, System: 341.0 ms]
  Range (min … max):   448.5 ms … 451.3 ms    10 runs
 
Summary
  ./stable --worker ran
    1.05 ± 0.00 times faster than target/release/thomaswue_ported --worker

Slower! :)


#### Where do we get LCC misses?

folkol@ubuntu:~/code/labs/1brc/onebrc$ perf record -h -F 9999 -g --call-graph dwarf -e LLC-load-misses ./stable --worker >/dev/null

folkol@ubuntu:~/code/labs/1brc/onebrc$ perf report --sort overhead --stdio
# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 22K of event 'cpu_core/LLC-load-misses/'
# Event count (approx.): 367317
#
#     Self
# ........
#
   100.00%
            |          
            |--94.29%--std::sys::backtrace::__rust_begin_short_backtrace
            |          thomaswue_ported::main::{{closure}}::{{closure}} (inlined)
            |          thomaswue_ported::parse_loop (inlined)
            |          |          
            |          |--80.82%--thomaswue_ported::find_result_unsafe_idx (inlined)
            |          |          |          
            |          |          |--13.10%--thomaswue_ported::hash_to_index (inlined)
            |          |          |          
            |          |          |--5.72%--thomaswue_ported::key_get_mut (inlined)
            |          |          |          core::slice::<impl [T]>::get_unchecked_mut (inlined)
            |          |          |          <usize as core::slice::index::SliceIndex<[T]>>::get_unchecked_mut (inlined)
            |          |          |          
            |          |           --0.66%--thomaswue_ported::find_delimiter (inlined)
            |          |          
            |          |--5.54%--thomaswue_ported::StationStats::record (inlined)
            |          |          
            |          |--2.79%--thomaswue_ported::Scanner::get_u64_at_unsafe (inlined)
            |          |          core::ptr::const_ptr::<impl *const T>::read_unaligned (inlined)
            |          |          core::ptr::read_unaligned (inlined)
            |          |          core::ptr::copy_nonoverlapping (inlined)
            |          |          |          
            |          |           --2.74%--asm_exc_page_fault
            |          |                     |          
            |          |                      --2.71%--exc_page_fault
            |          |                                do_user_addr_fault
            |          |                                |          
            |          |                                 --2.69%--handle_mm_fault
            |          |                                           |          
            |          |                                            --2.68%--__handle_mm_fault
            |          |                                                      |          
            |          |                                                       --2.68%--handle_pte_fault
            |          |                                                                 do_fault
            |          |                                                                 do_read_fault
            |          |                                                                 filemap_map_pages
            |          |                                                                 |          
            |          |                                                                  --2.49%--next_uptodate_folio
            |          |          
            |          |--1.00%--thomaswue_ported::Scanner::get_u64_unsafe (inlined)
            |          |          thomaswue_ported::Scanner::get_u64_at_unsafe (inlined)
            |          |          core::ptr::const_ptr::<impl *const T>::read_unaligned (inlined)
            |          |          core::ptr::read_unaligned (inlined)
            |          |          core::ptr::copy_nonoverlapping (inlined)
            |          |          |          
            |          |           --1.00%--asm_exc_page_fault
            |          |                     |          
            |          |                      --0.99%--exc_page_fault
            |          |                                do_user_addr_fault
            |          |                                |          
            |          |                                 --0.98%--handle_mm_fault
            |          |                                           __handle_mm_fault
            |          |                                           |          
            |          |                                            --0.98%--handle_pte_fault
            |          |                                                      do_fault
            |          |                                                      do_read_fault
            |          |                                                      filemap_map_pages
            |          |                                                      |          
            |          |                                                       --0.94%--next_uptodate_folio
            |          |          
            |          |--0.84%--thomaswue_ported::scan_number_unsafe (inlined)
            |          |          
            |           --0.64%--thomaswue_ported::Scanner::has_next_safe (inlined)
            |          
            |--2.97%--0x6968570a362e3330
            |          memchr::arch::x86_64::memchr::memchr_raw::find_avx2
            |          memchr::arch::x86_64::avx2::memchr::One::find_raw (inlined)
            |          memchr::arch::x86_64::avx2::memchr::One::find_raw_avx2 (inlined)
            |          memchr::arch::generic::memchr::One<V>::find_raw (inlined)
            |          memchr::arch::generic::memchr::One<V>::search_chunk (inlined)
            |          memchr::vector::x86avx2::<impl memchr::vector::Vector for core::core_arch::x86::__m256i>::movemask (inlined)
            |          core::core_arch::x86::avx2::_mm256_movemask_epi8 (inlined)
            |          |          
            |           --2.97%--asm_exc_page_fault
            |                     exc_page_fault
            |                     do_user_addr_fault
            |                     |          
            |                      --2.96%--handle_mm_fault
            |                                __handle_mm_fault
            |                                handle_pte_fault
            |                                do_fault
            |                                do_read_fault
            |                                |          
            |                                 --2.66%--filemap_map_pages
            |                                           |          
            |                                            --2.53%--next_uptodate_folio
            |                                                      |          
            |                                                       --0.53%--xas_find
            |          
             --2.54%--std::sys::backtrace::__rust_begin_short_backtrace
                       core::ops::function::FnOnce::call_once (inlined)
                       thomaswue_ported::main
                       |          
                        --2.43%--core::ptr::drop_in_place<memmap2::Mmap> (inlined)
                                  core::ptr::drop_in_place<memmap2::os::MmapInner> (inlined)
                                  __GI_munmap (inlined)
                                  entry_SYSCALL_64_after_hwframe
                                  do_syscall_64
                                  x64_sys_call
                                  __x64_sys_munmap
                                  __vm_munmap
                                  do_vmi_munmap
                                  do_vmi_align_munmap
                                  vms_complete_munmap_vmas
                                  vms_clear_ptes
                                  unmap_vmas
                                  unmap_single_vma.isra.0
                                  unmap_page_range
                                  zap_pmd_range.isra.0
                                  zap_pte_range
                                  |          
                                   --2.30%--zap_present_ptes.constprop.0



#
# (Cannot load tips.txt file, please install perf!)
#

Only user space misses:

folkol@ubuntu:~/code/labs/1brc/onebrc$ perf record -F 9999 -g --call-graph dwarf -e LLC-load-misses:u target/release/thomaswue_ported --worker >/dev/null

folkol@ubuntu:~/code/labs/1brc/onebrc$ perf report --sort overhead --stdio
# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 24K of event 'cpu_core/LLC-load-misses/'
# Event count (approx.): 325562
#
#     Self
# ........
#
   100.00%
            |          
             --99.96%--std::sys::backtrace::__rust_begin_short_backtrace
                       thomaswue_ported::main::{{closure}}::{{closure}} (inlined)
                       thomaswue_ported::parse_loop (inlined)
                       |          
                       |--89.74%--thomaswue_ported::find_result_unsafe_idx (inlined)
                       |          |          
                       |          |--13.05%--thomaswue_ported::hash_to_index (inlined)
                       |          |          
                       |          |--6.14%--thomaswue_ported::key_get_mut (inlined)
                       |          |          core::slice::<impl [T]>::get_unchecked_mut (inlined)
                       |          |          <usize as core::slice::index::SliceIndex<[T]>>::get_unchecked_mut (inlined)
                       |          |          
                       |           --0.67%--thomaswue_ported::find_delimiter (inlined)
                       |          
                       |--6.42%--thomaswue_ported::StationStats::record (inlined)
                       |          
                       |--0.51%--thomaswue_ported::scan_number_unsafe (inlined)
                       |          
                        --0.50%--thomaswue_ported::Scanner::has_next_safe (inlined)



#
# (Cannot load tips.txt file, please install perf!)
#


#### Reduce size of StationStat (currently 24 = two cache lines)


- count usize -> u32
- switched places on count and sum

Minor difference


#### Pin threads

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 2 './baseline --worker' 'target/release/thomaswue_ported --worker'
Benchmark 1: ./baseline --worker
  Time (mean ± σ):     427.4 ms ±   4.3 ms    [User: 7708.6 ms, System: 345.9 ms]
  Range (min … max):   424.9 ms … 439.2 ms    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 2: target/release/thomaswue_ported --worker
  Time (mean ± σ):     427.6 ms ±   1.2 ms    [User: 7707.6 ms, System: 352.1 ms]
  Range (min … max):   426.2 ms … 430.3 ms    10 runs
 
Summary
  ./baseline --worker ran
    1.00 ± 0.01 times faster than target/release/thomaswue_ported --worker


Did not help with speed, but maybe a bit fewer LLC misses.



#### Experiment with java single cursor

folkol@ubuntu:~/code/labs/1brc/java-orig$ hyperfine --warmup 2 './single_cursor --worker' 'target/CalculateAverage_thomaswue_image --worker'
Benchmark 1: ./single_cursor --worker
  Time (mean ± σ):     468.7 ms ±   9.1 ms    [User: 8735.4 ms, System: 350.1 ms]
  Range (min … max):   463.3 ms … 493.5 ms    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 2: target/CalculateAverage_thomaswue_image --worker
  Time (mean ± σ):     290.5 ms ±   2.7 ms    [User: 4558.5 ms, System: 354.3 ms]
  Range (min … max):   289.0 ms … 297.9 ms    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Summary
  target/CalculateAverage_thomaswue_image --worker ran
    1.61 ± 0.03 times faster than ./single_cursor --worker


Eerily similar to my performance...


#### New experiement: multicursors

folkol@ubuntu:~/code/labs/1brc/onebrc$ hyperfine --warmup 2 './baseline --worker' 'target/release/thomaswue_ported --worker'
Benchmark 1: ./baseline --worker
  Time (mean ± σ):     427.8 ms ±   1.8 ms    [User: 7699.2 ms, System: 360.2 ms]
  Range (min … max):   425.6 ms … 431.6 ms    10 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 2: target/release/thomaswue_ported --worker
  Time (mean ± σ):     317.3 ms ±   2.2 ms    [User: 5036.1 ms, System: 364.8 ms]
  Range (min … max):   312.4 ms … 319.7 ms    10 runs
 
Summary
  target/release/thomaswue_ported --worker ran
    1.35 ± 0.01 times faster than ./baseline --worker

Now we're talking!


