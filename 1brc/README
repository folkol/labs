# Fooling around with https://github.com/gunnarmorling/1brc

## Linux Performance Tools (Brendan Gregg)

https://www.youtube.com/watch?v=FJW8nGV4jxY

### Methodologies

Objectives
- Recognize the Streetlight Anti-Method
- Perform the Workload Characterization Method
- Perform the USE Method
- Learn how to start with the questions before using the tools
- Be aware of other methodologies

"program is slow, what does it do?"

- top / iostat / iotop / netstat / ss / dstat / sar / vmstat / strace

- methodologies should have a starting point, a process, and an ending point (checklist, then done)

#### Anti-Methods

Streetlight Anti-Method
- "Start where the light is best" (I'm used to top so I start with top)

Drunk Man Anti-Method:
- "Tune things at random until the problem goes away", doesn't help much / whack-a-mole

Blame Someone Else Anti-Method
- Find a system or environment that you are not responsible for and ask them

#### Actual Methodologies

Problem Statement Method
- What makes you think that there is a performance problem?
- Has this system ever performend well?
- What has changed recently? (Software? Hardware? Load?)
- Can the performance degradation be expressed in latency or run time?
- Does the problem affect other people or applications (or is it just you)?
- What is the environment? Software, hardware, instance types? Versions? Configuration?

Workload Characterization Method
- Who is causing the load? PID, UID, IP addr, ...
- Why is the load called? code pth, stack trace
- What is the load? IOPS, tput, type, r/w
- How is the load changing over time?

The USE Method
- For every resource, check:
	- Utilization
	- Saturation
	- Errors
- Definitions:
	- Utilization: busy time
	- Saturation: queue length or queued time
	- Errors: easy to interpret (objective)
- Helps if you have a functional (block) diagram of your system / software / environment, showing all resources

Start with the questions, then find the tools

- Examples (hardware): CPU interconnect / CPU / DRAM / Power / Fan / I/O Bridge / I/O Controller / Network Controller / Ports
- Every component in your data path can be the problem
- `Linux USE Method Example` posted online by Brendan Gregg

Off-CPU Analysis
- "when does my program step off of the CPU, and why?"
- Thread State Transition Diagram
- anon. major fault

CPU Profile Method
- CPU Profile
- Flamegraph

RTFM Method (How to understand performance tools and metrics?)
- Man pages
- Books
- Web search
- Co-workers
- Prior talk slides/video (like this one!)
- Support services
- Source code
- Experimentation
- Social

#### Tools

Objectives
- Perform the USE Method for resource utilization
- Perform the Workload Characterization method for disks, network
- Perform the CPU Profile Method using flame graphs
- Have exposure to various observability tools:
	- Basic: vmstat, iostat, mpstat, ps, top, ...
	- Intermediate: tcpdump, netstat, nicstat, pidstat, sar, ...
	- Advanced: ss, slaptop, perf_events, ...
- Perform Active Benchmarking
- Understand tuning risks
- Perform Static Performance Tuning

Command Line Tools
- Useful to study even if you don't use them directly, vmstat etcc

Tool Types
- Observability (watch activity, safe)
	- Basic
		- uptime, top, ps, vmstat, iostat, mpstat (multi-proc stats), free
		- Debug latency:
			- top: high system time, high idle and wait io
			- vmstat: moderate system time, wait io and idle time
			- vmstat: plenty free, no swapping
			- iostat: disks are pretty busy
			- sar: network seems idle
	- Intermediate
		- strace, tcpdump, netstat, nicstat, pidstat, swapon, lsof, sar
		- Debug "slow" app:
			- vmstat: lots of use time and system time, no swap
			- mpstat: same
			- pidstat: lab003
			- iostat: not disks
			- sar: no network
			- strace: spams read on fd 3, requesting 0 bytes (in a loop)
- Benchmarking ( 
	- UnixBench, lmbench, sysbench, perf bench
	- dd, hdparm, fio
	- ab, wrk, jmeter, openssl
	- ping, hping3, iperf, ttcp, traceroute, mtr, pchar
	- "Active Benchmarking (Method)": run the actual workload, use observability to measure
- Tuning
	- sysctl, /sys
	- app config / nice / renice/ taskset / ulimit / chcpu / tune2gs / ionice / hdparm / blockdev / ethtool / tc / ip / route / stap / kpatch
	- Tuning Method: Question -> Hypothesis -> Prediction -> Test -> Analysis
- Static
	- Static Performance Tuning (no workload): CPU types + flags, CPU Frequency Scaling / storage devices / file system capacity / route table
	- /proc/cpuinfo, /sys/devices/system/cpu/cpu0/cpufreq/{scaling_availale_frequencies,scaling_governor}
	- /proc/scsi/scsi, netstat -rn, ip route get xx.yy.zz.ww
	- dmesg / ifconfig -a / df -h / mdadm --misd -D /dev/md0, smartctl, numactl -s, lspci, lsmod, crontab -l, service --status-all

- Profiling
	- perf ( record -F 99 -ag -- ... ) (99 for avoiding sampling lock steps, so maybe even better to use a prime?)
	- perf repot (stack traces)
	- flamegraph -- merge stack traces ( perf script | ./stackcollapse-perf.pl | ./flamegraph.pl > perf.svg )
	- high CPU Usage by not attributed to a PID might be because of many short-lived processes
	- perf_events workflow: perf list, perf stat, perf record, perf report or perf script -> stackcollapse -> flamegraph
	- perf event mixed mode (see JVM stack trace + java stack traces + kernel stack traces)

- Tracing
	- tracepoints (kernel trace points)
	- kprobes etc
	- choosing a tracer, some companices standardize. Brendan's suggestion is to use what's in the kernel to begin with
	- ./funccount -i 1 'bio_*'  <-- summarize kernel functions starting with bio_
	- ./funcgraph -Htp 5363 vfs_read <--- tracing vfs_read and children
	- perf_events have different event sources, some from hardware and some from software
	- perf record -e block:block_rq_complete -a sleep 10 ...
	- eBPF (program that run on perf events in the kernel, JITed)

##### Namedropping other things
- tiptop, "top" for PMCs (might need some love in the cloud, maybe perfmon2 lib integration? PMCs are not always enabled in the guest.)
- rdmsr (read model specific registers), usually enabled in guests
- github.com/brendangregg/msr-cloud-tools
- 



## System

System:
  CPU: Intel Core Ultra 9 285K (Arrow Lake-S), 24 cores / 24 threads
       Hybrid architecture (P-cores + E-cores), SMT disabled
  Cache:
    L1d/L1i: private per P-core (≈38 KiB L1d, 64 KiB L1i)
    L2: 12 instances (private on P-cores, shared on E-core clusters), total 40 MiB
    L3: 36 MiB shared (single instance)
  NUMA: single node
  Memory: <fill from free -h / dmidecode>

Memory:
  Capacity: 32 GB
  Configuration: 2 × 16 GB DDR5 DIMMs
  Channels: Dual-channel
  Speed: DDR5-6400 (configured)
  Rank: Single-rank
  Voltage: 1.4 V
  Manufacturer: Corsair
  Part number: CMK32GX5M2B6400C32
  ECC: No
  Slots populated: DIMMA2, DIMMB2 (2 of 4)

Memory profile: XMP enabled (DDR5-6400)

## Installing Java

$ curl -s "https://get.sdkman.io" | bash
$ sdk install java 21.0.5-tem
$ javac --version
javac 21.0.5

## Prepare the data

$ git clone https://github.com/gunnarmorling/1brc.git java-orig

>> The tests in the official challenge were ran from a RAM disk

$ sudo mkdir /media/measurements
$ mount -t tmpfs -o size=16G tmpfs /media/measurements

$ ln -fs /media/measurements/measurements.txt measurements.txt 

$ time ./create_measurements.sh 1000000000
Wrote 50,000,000 measurements in 5534 ms
Wrote 100,000,000 measurements in 12735 ms
Wrote 150,000,000 measurements in 19899 ms
Wrote 200,000,000 measurements in 27111 ms
Wrote 250,000,000 measurements in 34291 ms
Wrote 300,000,000 measurements in 41568 ms
Wrote 350,000,000 measurements in 48735 ms
Wrote 400,000,000 measurements in 55947 ms
Wrote 450,000,000 measurements in 63162 ms
Wrote 500,000,000 measurements in 70353 ms
Wrote 550,000,000 measurements in 77554 ms
Wrote 600,000,000 measurements in 84747 ms
Wrote 650,000,000 measurements in 91935 ms
Wrote 700,000,000 measurements in 99113 ms
Wrote 750,000,000 measurements in 106295 ms
Wrote 800,000,000 measurements in 113494 ms
Wrote 850,000,000 measurements in 120687 ms
Wrote 900,000,000 measurements in 127898 ms
Wrote 950,000,000 measurements in 135105 ms
Created file with 1,000,000,000 measurements in 142302 ms

real	2m22.348s
user	2m20.210s
sys	0m2.697s

$ time wc -l measurements.txt 
1000000000 measurements.txt

real	0m0.913s
user	0m0.085s
sys	0m0.828s

folkol@ubuntu:~/code/labs/1brc/java-orig$ time ./calculate_average_baseline.sh 
#
# A fatal error has been detected by the Java Runtime Environment:
#
#  SIGSEGV (0xb) at pc=0x00007360243b9fea, pid=94484, tid=94485
#
# JRE version: OpenJDK Runtime Environment Temurin-21.0.5+11 (21.0.5+11) (build 21.0.5+11-LTS)
# Java VM: OpenJDK 64-Bit Server VM Temurin-21.0.5+11 (21.0.5+11-LTS, mixed mode, sharing, tiered, compressed oops, compressed class ptrs, g1 gc, linux-amd64)
# Problematic frame:
# J 261 c2 java.util.HashMap.computeIfAbsent(Ljava/lang/Object;Ljava/util/function/Function;)Ljava/lang/Object; java.base@21.0.5 (330 bytes) @ 0x00007360243b9fea [0x00007360243b9d80+0x000000000000026a]
#
# Core dump will be written. Default location: Core dumps may be processed with "/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -F%F -- %E" (or dumping to /home/folkol/code/labs/1brc/java-orig/core.94484)
#
# An error report file with more information is saved as:
# /home/folkol/code/labs/1brc/java-orig/hs_err_pid94484.log
[7.927s][warning][os] Loading hsdis library failed
#
# If you would like to submit a bug report, please visit:
#   https://github.com/adoptium/adoptium-support/issues
#
Aborted (core dumped)

real	0m9.027s
user	0m8.010s
sys	0m0.370s

$ sdk install java 21.0.9-tem

$ crashed again...

$ third time is a charm! :)

$ /usr/bin/time -v time ./calculate_average_baseline.sh 
{Abha=-33.8/18.0/71.1, Abidjan=-23.6/26.0/77.3, Abéché=-23.2/29.4/78.4, Accra=-24.3/26.4/79.3, Addis Ababa=-34.5/16.0/64.9, Adelaide=-30.2/17.3/71.5, Aden=-20.4/29.1/79.8, Ahvaz=-25.4/25.4/73.8, Albuquerque=-39.2/14.0/66.5, Alexandra=-47.2/11.0/63.2, Alexandria=-31.4/20.0/68.1, Algiers=-32.1/18.2/69.8, Alice Springs=-30.5/21.0/68.0, Almaty=-45.3/10.0/58.1, Amsterdam=-40.1/10.2/59.0, Anadyr=-62.8/-6.9/41.8, Anchorage=-45.2/2.8/50.0, Andorra la Vella=-38.7/9.8/63.8, Ankara=-35.6/12.0/61.5, Antananarivo=-38.7/17.9/66.7, Antsiranana=-26.5/25.2/75.0, Arkhangelsk=-48.3/1.3/50.9, Ashgabat=-31.6/17.1/70.0, Asmara=-32.9/15.6/67.9, Assab=-16.7/30.5/77.9, Astana=-44.6/3.5/55.2, Athens=-31.2/19.2/66.6, Atlanta=-34.2/17.0/64.3, Auckland=-40.5/15.2/63.7, Austin=-30.0/20.7/71.6, Baghdad=-26.6/22.8/73.0, Baguio=-34.7/19.5/73.4, Baku=-42.1/15.1/66.5, Baltimore=-38.4/13.1/61.2, Bamako=-22.5/27.8/75.8, Bangkok=-22.3/28.6/78.2, Bangui=-26.7/26.0/73.9, Banjul=-23.0/26.0/74.9, Barcelona=-32.1/18.2/67.3, Bata=-22.9/25.1/76.3, Batumi=-32.6/14.0/64.5, Beijing=-37.7/12.9/60.8, Beirut=-31.0/20.9/69.9, Belgrade=-41.2/12.5/60.6, Belize City=-23.2/26.7/74.2, Benghazi=-34.4/19.9/67.0, Bergen=-39.9/7.7/55.5, Berlin=-40.4/10.3/67.7, Bilbao=-35.5/14.7/63.6, Birao=-29.1/26.5/77.4, Bishkek=-38.0/11.3/60.3, Bissau=-28.3/27.0/76.4, Blantyre=-25.6/22.2/71.8, Bloemfontein=-37.0/15.6/64.2, Boise=-35.2/11.4/59.5, Bordeaux=-33.0/14.2/66.0, Bosaso=-17.8/30.0/80.3, Boston=-36.8/10.9/71.6, Bouaké=-25.7/26.0/75.6, Bratislava=-39.0/10.5/61.6, Brazzaville=-29.1/25.0/73.2, Bridgetown=-21.9/27.0/76.9, Brisbane=-30.6/21.4/70.6, Brussels=-38.1/10.5/60.0, Bucharest=-42.1/10.8/60.8, Budapest=-41.3/11.3/61.7, Bujumbura=-24.1/23.8/72.8, Bulawayo=-31.9/18.9/74.1, Burnie=-34.0/13.1/63.7, Busan=-36.7/15.0/66.3, Cabo San Lucas=-25.5/23.9/72.3, Cairns=-26.3/25.0/74.1, Cairo=-29.7/21.4/72.6, Calgary=-46.0/4.4/55.7, Canberra=-36.7/13.1/66.9, Cape Town=-31.8/16.2/67.1, Changsha=-34.8/17.4/68.1, Charlotte=-36.6/16.1/66.8, Chiang Mai=-29.7/25.8/72.6, Chicago=-39.6/9.8/62.2, Chihuahua=-30.7/18.6/66.7, Chittagong=-26.0/25.9/82.7, Chișinău=-38.7/10.2/55.8, Chongqing=-33.8/18.6/66.7, Christchurch=-38.4/12.2/61.7, City of San Marino=-37.4/11.8/57.4, Colombo=-23.4/27.4/79.1, Columbus=-35.9/11.7/73.2, Conakry=-23.3/26.4/74.6, Copenhagen=-39.3/9.1/60.7, Cotonou=-21.0/27.2/80.1, Cracow=-44.9/9.3/58.3, Da Lat=-32.6/17.9/65.6, Da Nang=-24.8/25.8/75.6, Dakar=-27.6/24.0/73.8, Dallas=-31.3/19.0/70.2, Damascus=-32.9/17.0/64.2, Dampier=-20.4/26.4/77.5, Dar es Salaam=-25.5/25.8/73.2, Darwin=-26.1/27.6/79.0, Denpasar=-23.6/23.7/74.5, Denver=-39.7/10.4/62.4, Detroit=-43.4/10.0/63.1, Dhaka=-22.1/25.9/78.3, Dikson=-64.9/-11.1/39.5, Dili=-22.8/26.6/78.2, Djibouti=-19.0/29.9/84.4, Dodoma=-25.3/22.7/76.2, Dolisie=-24.4/24.0/76.6, Douala=-21.8/26.7/79.3, Dubai=-20.2/26.9/74.2, Dublin=-45.0/9.8/56.9, Dunedin=-44.3/11.1/63.1, Durban=-28.1/20.6/72.6, Dushanbe=-35.9/14.7/63.6, Edinburgh=-43.6/9.3/64.0, Edmonton=-45.4/4.2/52.4, El Paso=-31.7/18.1/65.7, Entebbe=-32.0/21.0/72.1, Erbil=-27.9/19.5/67.4, Erzurum=-42.6/5.1/55.2, Fairbanks=-49.7/-2.3/49.8, Fianarantsoa=-32.9/17.9/66.1, Flores,  Petén=-23.7/26.4/78.9, Frankfurt=-40.1/10.6/58.2, Fresno=-33.9/17.9/66.0, Fukuoka=-33.0/17.0/68.8, Gaborone=-27.4/21.0/68.8, Gabès=-29.9/19.5/67.4, Gagnoa=-25.9/26.0/74.5, Gangtok=-32.0/15.2/65.4, Garissa=-22.6/29.3/77.9, Garoua=-23.0/28.3/80.1, George Town=-22.0/27.9/80.3, Ghanzi=-25.5/21.4/74.6, Gjoa Haven=-64.0/-14.4/36.1, Guadalajara=-28.5/20.9/70.1, Guangzhou=-26.9/22.4/70.8, Guatemala City=-32.0/20.4/70.9, Halifax=-40.7/7.5/55.2, Hamburg=-38.3/9.7/59.7, Hamilton=-37.7/13.8/62.7, Hanga Roa=-29.0/20.5/71.8, Hanoi=-28.9/23.6/75.7, Harare=-37.7/18.4/71.6, Harbin=-48.2/5.0/60.7, Hargeisa=-26.4/21.7/68.6, Hat Yai=-22.5/27.0/74.9, Havana=-23.4/25.2/77.2, Helsinki=-45.7/5.9/60.0, Heraklion=-40.2/18.9/65.3, Hiroshima=-36.1/16.3/65.6, Ho Chi Minh City=-24.4/27.4/76.3, Hobart=-39.3/12.7/62.3, Hong Kong=-24.8/23.3/73.4, Honiara=-27.1/26.5/76.9, Honolulu=-24.1/25.4/74.2, Houston=-28.6/20.8/77.1, Ifrane=-39.4/11.4/63.2, Indianapolis=-42.1/11.8/64.6, Iqaluit=-56.3/-9.3/41.8, Irkutsk=-50.8/1.0/49.9, Istanbul=-40.4/13.9/61.7, Jacksonville=-30.9/20.3/67.6, Jakarta=-21.4/26.7/74.5, Jayapura=-24.6/27.0/79.6, Jerusalem=-30.4/18.3/70.2, Johannesburg=-34.8/15.5/68.2, Jos=-27.0/22.8/74.9, Juba=-19.9/27.8/78.6, Kabul=-38.6/12.1/60.0, Kampala=-31.5/20.0/67.9, Kandi=-23.4/27.7/79.0, Kankan=-23.2/26.5/81.6, Kano=-27.1/26.4/74.4, Kansas City=-39.3/12.5/62.0, Karachi=-27.1/26.0/75.5, Karonga=-29.7/24.4/70.6, Kathmandu=-34.1/18.3/67.6, Khartoum=-26.2/29.9/77.9, Kingston=-24.3/27.4/81.1, Kinshasa=-22.3/25.3/75.8, Kolkata=-22.0/26.7/79.8, Kuala Lumpur=-22.4/27.3/78.1, Kumasi=-20.9/26.0/76.0, Kunming=-33.5/15.7/69.3, Kuopio=-46.6/3.4/55.9, Kuwait City=-27.2/25.7/75.4, Kyiv=-42.3/8.4/57.5, Kyoto=-32.9/15.8/66.4, La Ceiba=-22.4/26.2/80.0, La Paz=-29.1/23.7/77.9, Lagos=-23.3/26.8/76.5, Lahore=-30.8/24.3/74.6, Lake Havasu City=-27.0/23.7/70.0, Lake Tekapo=-45.1/8.7/56.8, Las Palmas de Gran Canaria=-31.1/21.2/72.2, Las Vegas=-28.6/20.3/69.4, Launceston=-40.0/13.1/65.1, Lhasa=-43.5/7.6/63.7, Libreville=-23.3/25.9/76.1, Lisbon=-34.0/17.5/64.7, Livingstone=-27.7/21.8/72.2, Ljubljana=-42.6/10.9/60.3, Lodwar=-20.6/29.3/76.7, Lomé=-26.5/26.9/76.1, London=-35.9/11.3/59.5, Los Angeles=-34.2/18.6/70.0, Louisville=-36.0/13.9/67.5, Luanda=-26.2/25.8/77.2, Lubumbashi=-27.2/20.8/66.3, Lusaka=-32.0/19.9/70.8, Luxembourg City=-40.8/9.3/61.1, Lviv=-38.6/7.8/59.3, Lyon=-35.0/12.5/57.7, Madrid=-33.2/15.0/63.1, Mahajanga=-26.0/26.3/79.1, Makassar=-22.0/26.7/75.4, Makurdi=-27.2/26.0/81.2, Malabo=-22.2/26.3/77.7, Malé=-20.6/28.0/81.6, Managua=-25.6/27.3/75.2, Manama=-24.6/26.5/74.7, Mandalay=-22.0/28.0/78.6, Mango=-19.7/28.1/80.6, Manila=-20.7/28.4/80.6, Maputo=-25.0/22.8/72.2, Marrakesh=-27.4/19.6/68.8, Marseille=-32.8/15.8/64.9, Maun=-30.5/22.4/73.0, Medan=-26.2/26.5/78.0, Mek'ele=-26.6/22.7/77.8, Melbourne=-46.0/15.1/71.8, Memphis=-35.3/17.2/68.3, Mexicali=-24.8/23.1/75.3, Mexico City=-34.7/17.5/66.8, Miami=-25.3/24.9/73.5, Milan=-34.7/13.0/63.5, Milwaukee=-46.4/8.9/58.4, Minneapolis=-42.0/7.8/56.5, Minsk=-42.8/6.7/55.9, Mogadishu=-27.5/27.1/75.5, Mombasa=-23.1/26.3/72.7, Monaco=-34.4/16.4/65.2, Moncton=-40.1/6.1/59.1, Monterrey=-28.5/22.3/75.7, Montreal=-43.3/6.8/58.5, Moscow=-45.0/5.8/53.6, Mumbai=-19.6/27.1/76.5, Murmansk=-53.3/0.6/50.6, Muscat=-23.0/28.0/80.4, Mzuzu=-32.4/17.7/66.4, N'Djamena=-21.2/28.3/74.8, Naha=-30.1/23.1/74.6, Nairobi=-32.1/17.8/65.2, Nakhon Ratchasima=-24.6/27.3/80.1, Napier=-34.5/14.6/60.2, Napoli=-37.7/15.9/66.2, Nashville=-34.2/15.4/62.5, Nassau=-29.1/24.6/75.7, Ndola=-27.9/20.3/69.4, New Delhi=-30.5/25.0/74.9, New Orleans=-33.1/20.7/77.8, New York City=-37.6/12.9/63.8, Ngaoundéré=-30.2/22.0/75.7, Niamey=-26.6/29.3/79.4, Nicosia=-27.7/19.7/68.8, Niigata=-35.1/13.9/65.4, Nouadhibou=-30.4/21.3/72.7, Nouakchott=-24.9/25.7/73.9, Novosibirsk=-49.9/1.7/54.6, Nuuk=-48.8/-1.4/49.9, Odesa=-38.7/10.7/64.3, Odienné=-24.8/26.0/76.7, Oklahoma City=-31.6/15.9/64.8, Omaha=-39.6/10.6/60.8, Oranjestad=-26.4/28.1/78.1, Oslo=-45.8/5.7/54.8, Ottawa=-42.3/6.6/58.7, Ouagadougou=-20.4/28.3/80.3, Ouahigouya=-18.9/28.6/77.8, Ouarzazate=-30.9/18.9/81.8, Oulu=-45.8/2.7/53.3, Palembang=-20.5/27.3/76.0, Palermo=-35.6/18.5/72.9, Palm Springs=-29.0/24.5/73.2, Palmerston North=-37.8/13.2/63.0, Panama City=-21.2/28.0/77.2, Parakou=-23.3/26.8/77.6, Paris=-41.0/12.3/61.6, Perth=-34.9/18.7/70.0, Petropavlovsk-Kamchatsky=-45.6/1.9/51.1, Philadelphia=-42.3/13.2/64.2, Phnom Penh=-23.5/28.3/80.6, Phoenix=-27.5/23.9/74.1, Pittsburgh=-41.1/10.8/66.7, Podgorica=-36.2/15.3/68.1, Pointe-Noire=-21.2/26.1/76.8, Pontianak=-19.2/27.7/79.8, Port Moresby=-24.0/26.9/74.9, Port Sudan=-19.1/28.4/78.2, Port Vila=-28.2/24.3/71.3, Port-Gentil=-22.6/26.0/81.2, Portland (OR)=-37.2/12.4/64.9, Porto=-34.6/15.7/65.3, Prague=-43.5/8.4/56.4, Praia=-25.1/24.4/73.9, Pretoria=-32.1/18.2/68.7, Pyongyang=-36.5/10.8/62.1, Rabat=-31.8/17.2/65.1, Rangpur=-24.0/24.4/71.3, Reggane=-24.1/28.3/78.0, Reykjavík=-44.0/4.3/54.8, Riga=-46.4/6.2/53.0, Riyadh=-26.5/26.0/75.3, Rome=-37.8/15.2/64.4, Roseau=-22.7/26.2/76.4, Rostov-on-Don=-38.2/9.9/58.8, Sacramento=-37.6/16.3/65.8, Saint Petersburg=-43.3/5.8/53.8, Saint-Pierre=-46.9/5.7/57.1, Salt Lake City=-36.3/11.6/62.2, San Antonio=-28.4/20.8/68.9, San Diego=-30.2/17.8/65.7, San Francisco=-36.1/14.6/63.3, San Jose=-33.5/16.4/66.0, San José=-28.2/22.6/81.0, San Juan=-22.4/27.2/79.3, San Salvador=-27.5/23.1/71.8, Sana'a=-28.6/20.0/70.6, Santo Domingo=-21.4/25.9/78.2, Sapporo=-39.8/8.9/61.5, Sarajevo=-36.3/10.1/59.0, Saskatoon=-45.5/3.3/52.1, Seattle=-34.9/11.3/60.8, Seoul=-34.6/12.5/59.5, Seville=-28.2/19.2/71.0, Shanghai=-37.9/16.7/65.4, Singapore=-24.3/27.0/75.6, Skopje=-37.1/12.4/65.1, Sochi=-41.5/14.2/64.4, Sofia=-38.3/10.6/58.1, Sokoto=-19.5/28.0/76.0, Split=-33.0/16.1/65.9, St. John's=-45.8/5.0/54.4, St. Louis=-38.4/13.9/61.6, Stockholm=-43.3/6.6/61.4, Surabaya=-22.7/27.1/80.4, Suva=-25.5/25.6/75.4, Suwałki=-40.5/7.2/55.1, Sydney=-34.9/17.7/69.5, Ségou=-22.3/28.0/75.5, Tabora=-26.9/23.0/74.5, Tabriz=-35.0/12.6/63.8, Taipei=-28.6/23.0/75.9, Tallinn=-43.8/6.4/56.7, Tamale=-21.5/27.9/78.9, Tamanrasset=-24.9/21.7/73.8, Tampa=-24.2/22.9/72.1, Tashkent=-34.1/14.8/68.4, Tauranga=-34.4/14.8/62.9, Tbilisi=-35.7/12.9/63.7, Tegucigalpa=-29.4/21.7/72.5, Tehran=-31.7/17.0/65.1, Tel Aviv=-32.2/20.0/67.5, Thessaloniki=-35.8/16.0/67.4, Thiès=-28.4/24.0/75.5, Tijuana=-31.2/17.8/71.6, Timbuktu=-20.7/28.0/75.4, Tirana=-34.9/15.2/66.1, Toamasina=-27.0/23.4/72.7, Tokyo=-33.2/15.4/61.9, Toliara=-26.0/24.1/78.0, Toluca=-39.8/12.4/67.9, Toronto=-40.4/9.4/62.2, Tripoli=-28.2/20.0/68.7, Tromsø=-45.0/2.9/54.5, Tucson=-31.0/20.9/71.0, Tunis=-29.8/18.4/68.3, Ulaanbaatar=-50.6/-0.4/47.6, Upington=-27.6/20.4/70.6, Vaduz=-42.2/10.1/59.0, Valencia=-28.5/18.3/71.9, Valletta=-30.3/18.8/68.7, Vancouver=-40.3/10.4/63.5, Veracruz=-21.7/25.4/73.2, Vienna=-42.7/10.4/59.5, Vientiane=-23.7/25.9/73.1, Villahermosa=-20.9/27.1/79.3, Vilnius=-47.1/6.0/55.3, Virginia Beach=-34.2/15.8/69.8, Vladivostok=-43.8/4.9/54.0, Warsaw=-37.1/8.5/60.0, Washington, D.C.=-36.6/14.6/62.5, Wau=-22.2/27.8/76.1, Wellington=-37.5/12.9/64.0, Whitehorse=-49.8/-0.1/59.8, Wichita=-34.0/13.9/65.8, Willemstad=-29.4/28.0/78.5, Winnipeg=-47.4/3.0/55.2, Wrocław=-37.7/9.6/60.3, Xi'an=-37.1/14.1/62.4, Yakutsk=-61.5/-8.8/39.4, Yangon=-20.8/27.5/78.5, Yaoundé=-25.4/23.8/74.6, Yellowknife=-58.3/-4.3/44.8, Yerevan=-35.5/12.4/70.4, Yinchuan=-47.9/9.0/61.2, Zagreb=-41.8/10.7/60.5, Zanzibar City=-21.8/26.0/78.9, Zürich=-41.5/9.3/59.8, Ürümqi=-40.6/7.4/58.6, İzmir=-29.6/17.9/71.1}
78.04user 2.05system 1:19.53elapsed 100%CPU (0avgtext+0avgdata 738180maxresident)k
0inputs+0outputs (0major+185464minor)pagefaults 0swaps
	Command being timed: "time ./calculate_average_baseline.sh"
	User time (seconds): 78.04
	System time (seconds): 2.05
	Percent of CPU this job got: 100%
	Elapsed (wall clock) time (h:mm:ss or m:ss): 1:19.53
	Average shared text size (kbytes): 0
	Average unshared data size (kbytes): 0
	Average stack size (kbytes): 0
	Average total size (kbytes): 0
	Maximum resident set size (kbytes): 738180
	Average resident set size (kbytes): 0
	Major (requiring I/O) page faults: 0
	Minor (reclaiming a frame) page faults: 185553
	Voluntary context switches: 65988
	Involuntary context switches: 1172
	Swaps: 0
	File system inputs: 0
	File system outputs: 0
	Socket messages sent: 0
	Socket messages received: 0
	Signals delivered: 0
	Page size (bytes): 4096
	Exit status: 0

## Trying fastest solution

$ time ./calculate_average_thomaswue.sh 
Chosing to run the app in JVM mode as no native image was found, use prepare_thomaswue.sh to generate.
{Abha=-33.8/18.0/71.1, Abidjan=-23.6/26.0/77.3, Abéché=-23.2/29.4/78.4, Accra=-24.3/26.4/79.3, Addis Ababa=-34.5/16.0/64.9, Adelaide=-30.2/17.3/71.5, Aden=-20.4/29.1/79.8, Ahvaz=-25.4/25.4/73.8, Albuquerque=-39.2/14.0/66.5, Alexandra=-47.2/11.0/63.2, Alexandria=-31.4/20.0/68.1, Algiers=-32.1/18.2/69.8, Alice Springs=-30.5/21.0/68.0, Almaty=-45.3/10.0/58.1, Amsterdam=-40.1/10.2/59.0, Anadyr=-62.8/-6.9/41.8, Anchorage=-45.2/2.8/50.0, Andorra la Vella=-38.7/9.8/63.8, Ankara=-35.6/12.0/61.5, Antananarivo=-38.7/17.9/66.7, Antsiranana=-26.5/25.2/75.0, Arkhangelsk=-48.3/1.3/50.9, Ashgabat=-31.6/17.1/70.0, Asmara=-32.9/15.6/67.9, Assab=-16.7/30.5/77.9, Astana=-44.6/3.5/55.2, Athens=-31.2/19.2/66.6, Atlanta=-34.2/17.0/64.3, Auckland=-40.5/15.2/63.7, Austin=-30.0/20.7/71.6, Baghdad=-26.6/22.8/73.0, Baguio=-34.7/19.5/73.4, Baku=-42.1/15.1/66.5, Baltimore=-38.4/13.1/61.2, Bamako=-22.5/27.8/75.8, Bangkok=-22.3/28.6/78.2, Bangui=-26.7/26.0/73.9, Banjul=-23.0/26.0/74.9, Barcelona=-32.1/18.2/67.3, Bata=-22.9/25.1/76.3, Batumi=-32.6/14.0/64.5, Beijing=-37.7/12.9/60.8, Beirut=-31.0/20.9/69.9, Belgrade=-41.2/12.5/60.6, Belize City=-23.2/26.7/74.2, Benghazi=-34.4/19.9/67.0, Bergen=-39.9/7.7/55.5, Berlin=-40.4/10.3/67.7, Bilbao=-35.5/14.7/63.6, Birao=-29.1/26.5/77.4, Bishkek=-38.0/11.3/60.3, Bissau=-28.3/27.0/76.4, Blantyre=-25.6/22.2/71.8, Bloemfontein=-37.0/15.6/64.2, Boise=-35.2/11.4/59.5, Bordeaux=-33.0/14.2/66.0, Bosaso=-17.8/30.0/80.3, Boston=-36.8/10.9/71.6, Bouaké=-25.7/26.0/75.6, Bratislava=-39.0/10.5/61.6, Brazzaville=-29.1/25.0/73.2, Bridgetown=-21.9/27.0/76.9, Brisbane=-30.6/21.4/70.6, Brussels=-38.1/10.5/60.0, Bucharest=-42.1/10.8/60.8, Budapest=-41.3/11.3/61.7, Bujumbura=-24.1/23.8/72.8, Bulawayo=-31.9/18.9/74.1, Burnie=-34.0/13.1/63.7, Busan=-36.7/15.0/66.3, Cabo San Lucas=-25.5/23.9/72.3, Cairns=-26.3/25.0/74.1, Cairo=-29.7/21.4/72.6, Calgary=-46.0/4.4/55.7, Canberra=-36.7/13.1/66.9, Cape Town=-31.8/16.2/67.1, Changsha=-34.8/17.4/68.1, Charlotte=-36.6/16.1/66.8, Chiang Mai=-29.7/25.8/72.6, Chicago=-39.6/9.8/62.2, Chihuahua=-30.7/18.6/66.7, Chittagong=-26.0/25.9/82.7, Chișinău=-38.7/10.2/55.8, Chongqing=-33.8/18.6/66.7, Christchurch=-38.4/12.2/61.7, City of San Marino=-37.4/11.8/57.4, Colombo=-23.4/27.4/79.1, Columbus=-35.9/11.7/73.2, Conakry=-23.3/26.4/74.6, Copenhagen=-39.3/9.1/60.7, Cotonou=-21.0/27.2/80.1, Cracow=-44.9/9.3/58.3, Da Lat=-32.6/17.9/65.6, Da Nang=-24.8/25.8/75.6, Dakar=-27.6/24.0/73.8, Dallas=-31.3/19.0/70.2, Damascus=-32.9/17.0/64.2, Dampier=-20.4/26.4/77.5, Dar es Salaam=-25.5/25.8/73.2, Darwin=-26.1/27.6/79.0, Denpasar=-23.6/23.7/74.5, Denver=-39.7/10.4/62.4, Detroit=-43.4/10.0/63.1, Dhaka=-22.1/25.9/78.3, Dikson=-64.9/-11.1/39.5, Dili=-22.8/26.6/78.2, Djibouti=-19.0/29.9/84.4, Dodoma=-25.3/22.7/76.2, Dolisie=-24.4/24.0/76.6, Douala=-21.8/26.7/79.3, Dubai=-20.2/26.9/74.2, Dublin=-45.0/9.8/56.9, Dunedin=-44.3/11.1/63.1, Durban=-28.1/20.6/72.6, Dushanbe=-35.9/14.7/63.6, Edinburgh=-43.6/9.3/64.0, Edmonton=-45.4/4.2/52.4, El Paso=-31.7/18.1/65.7, Entebbe=-32.0/21.0/72.1, Erbil=-27.9/19.5/67.4, Erzurum=-42.6/5.1/55.2, Fairbanks=-49.7/-2.3/49.8, Fianarantsoa=-32.9/17.9/66.1, Flores,  Petén=-23.7/26.4/78.9, Frankfurt=-40.1/10.6/58.2, Fresno=-33.9/17.9/66.0, Fukuoka=-33.0/17.0/68.8, Gaborone=-27.4/21.0/68.8, Gabès=-29.9/19.5/67.4, Gagnoa=-25.9/26.0/74.5, Gangtok=-32.0/15.2/65.4, Garissa=-22.6/29.3/77.9, Garoua=-23.0/28.3/80.1, George Town=-22.0/27.9/80.3, Ghanzi=-25.5/21.4/74.6, Gjoa Haven=-64.0/-14.4/36.1, Guadalajara=-28.5/20.9/70.1, Guangzhou=-26.9/22.4/70.8, Guatemala City=-32.0/20.4/70.9, Halifax=-40.7/7.5/55.2, Hamburg=-38.3/9.7/59.7, Hamilton=-37.7/13.8/62.7, Hanga Roa=-29.0/20.5/71.8, Hanoi=-28.9/23.6/75.7, Harare=-37.7/18.4/71.6, Harbin=-48.2/5.0/60.7, Hargeisa=-26.4/21.7/68.6, Hat Yai=-22.5/27.0/74.9, Havana=-23.4/25.2/77.2, Helsinki=-45.7/5.9/60.0, Heraklion=-40.2/18.9/65.3, Hiroshima=-36.1/16.3/65.6, Ho Chi Minh City=-24.4/27.4/76.3, Hobart=-39.3/12.7/62.3, Hong Kong=-24.8/23.3/73.4, Honiara=-27.1/26.5/76.9, Honolulu=-24.1/25.4/74.2, Houston=-28.6/20.8/77.1, Ifrane=-39.4/11.4/63.2, Indianapolis=-42.1/11.8/64.6, Iqaluit=-56.3/-9.3/41.8, Irkutsk=-50.8/1.0/49.9, Istanbul=-40.4/13.9/61.7, Jacksonville=-30.9/20.3/67.6, Jakarta=-21.4/26.7/74.5, Jayapura=-24.6/27.0/79.6, Jerusalem=-30.4/18.3/70.2, Johannesburg=-34.8/15.5/68.2, Jos=-27.0/22.8/74.9, Juba=-19.9/27.8/78.6, Kabul=-38.6/12.1/60.0, Kampala=-31.5/20.0/67.9, Kandi=-23.4/27.7/79.0, Kankan=-23.2/26.5/81.6, Kano=-27.1/26.4/74.4, Kansas City=-39.3/12.5/62.0, Karachi=-27.1/26.0/75.5, Karonga=-29.7/24.4/70.6, Kathmandu=-34.1/18.3/67.6, Khartoum=-26.2/29.9/77.9, Kingston=-24.3/27.4/81.1, Kinshasa=-22.3/25.3/75.8, Kolkata=-22.0/26.7/79.8, Kuala Lumpur=-22.4/27.3/78.1, Kumasi=-20.9/26.0/76.0, Kunming=-33.5/15.7/69.3, Kuopio=-46.6/3.4/55.9, Kuwait City=-27.2/25.7/75.4, Kyiv=-42.3/8.4/57.5, Kyoto=-32.9/15.8/66.4, La Ceiba=-22.4/26.2/80.0, La Paz=-29.1/23.7/77.9, Lagos=-23.3/26.8/76.5, Lahore=-30.8/24.3/74.6, Lake Havasu City=-27.0/23.7/70.0, Lake Tekapo=-45.1/8.7/56.8, Las Palmas de Gran Canaria=-31.1/21.2/72.2, Las Vegas=-28.6/20.3/69.4, Launceston=-40.0/13.1/65.1, Lhasa=-43.5/7.6/63.7, Libreville=-23.3/25.9/76.1, Lisbon=-34.0/17.5/64.7, Livingstone=-27.7/21.8/72.2, Ljubljana=-42.6/10.9/60.3, Lodwar=-20.6/29.3/76.7, Lomé=-26.5/26.9/76.1, London=-35.9/11.3/59.5, Los Angeles=-34.2/18.6/70.0, Louisville=-36.0/13.9/67.5, Luanda=-26.2/25.8/77.2, Lubumbashi=-27.2/20.8/66.3, Lusaka=-32.0/19.9/70.8, Luxembourg City=-40.8/9.3/61.1, Lviv=-38.6/7.8/59.3, Lyon=-35.0/12.5/57.7, Madrid=-33.2/15.0/63.1, Mahajanga=-26.0/26.3/79.1, Makassar=-22.0/26.7/75.4, Makurdi=-27.2/26.0/81.2, Malabo=-22.2/26.3/77.7, Malé=-20.6/28.0/81.6, Managua=-25.6/27.3/75.2, Manama=-24.6/26.5/74.7, Mandalay=-22.0/28.0/78.6, Mango=-19.7/28.1/80.6, Manila=-20.7/28.4/80.6, Maputo=-25.0/22.8/72.2, Marrakesh=-27.4/19.6/68.8, Marseille=-32.8/15.8/64.9, Maun=-30.5/22.4/73.0, Medan=-26.2/26.5/78.0, Mek'ele=-26.6/22.7/77.8, Melbourne=-46.0/15.1/71.8, Memphis=-35.3/17.2/68.3, Mexicali=-24.8/23.1/75.3, Mexico City=-34.7/17.5/66.8, Miami=-25.3/24.9/73.5, Milan=-34.7/13.0/63.5, Milwaukee=-46.4/8.9/58.4, Minneapolis=-42.0/7.8/56.5, Minsk=-42.8/6.7/55.9, Mogadishu=-27.5/27.1/75.5, Mombasa=-23.1/26.3/72.7, Monaco=-34.4/16.4/65.2, Moncton=-40.1/6.1/59.1, Monterrey=-28.5/22.3/75.7, Montreal=-43.3/6.8/58.5, Moscow=-45.0/5.8/53.6, Mumbai=-19.6/27.1/76.5, Murmansk=-53.3/0.6/50.6, Muscat=-23.0/28.0/80.4, Mzuzu=-32.4/17.7/66.4, N'Djamena=-21.2/28.3/74.8, Naha=-30.1/23.1/74.6, Nairobi=-32.1/17.8/65.2, Nakhon Ratchasima=-24.6/27.3/80.1, Napier=-34.5/14.6/60.2, Napoli=-37.7/15.9/66.2, Nashville=-34.2/15.4/62.5, Nassau=-29.1/24.6/75.7, Ndola=-27.9/20.3/69.4, New Delhi=-30.5/25.0/74.9, New Orleans=-33.1/20.7/77.8, New York City=-37.6/12.9/63.8, Ngaoundéré=-30.2/22.0/75.7, Niamey=-26.6/29.3/79.4, Nicosia=-27.7/19.7/68.8, Niigata=-35.1/13.9/65.4, Nouadhibou=-30.4/21.3/72.7, Nouakchott=-24.9/25.7/73.9, Novosibirsk=-49.9/1.7/54.6, Nuuk=-48.8/-1.4/49.9, Odesa=-38.7/10.7/64.3, Odienné=-24.8/26.0/76.7, Oklahoma City=-31.6/15.9/64.8, Omaha=-39.6/10.6/60.8, Oranjestad=-26.4/28.1/78.1, Oslo=-45.8/5.7/54.8, Ottawa=-42.3/6.6/58.7, Ouagadougou=-20.4/28.3/80.3, Ouahigouya=-18.9/28.6/77.8, Ouarzazate=-30.9/18.9/81.8, Oulu=-45.8/2.7/53.3, Palembang=-20.5/27.3/76.0, Palermo=-35.6/18.5/72.9, Palm Springs=-29.0/24.5/73.2, Palmerston North=-37.8/13.2/63.0, Panama City=-21.2/28.0/77.2, Parakou=-23.3/26.8/77.6, Paris=-41.0/12.3/61.6, Perth=-34.9/18.7/70.0, Petropavlovsk-Kamchatsky=-45.6/1.9/51.1, Philadelphia=-42.3/13.2/64.2, Phnom Penh=-23.5/28.3/80.6, Phoenix=-27.5/23.9/74.1, Pittsburgh=-41.1/10.8/66.7, Podgorica=-36.2/15.3/68.1, Pointe-Noire=-21.2/26.1/76.8, Pontianak=-19.2/27.7/79.8, Port Moresby=-24.0/26.9/74.9, Port Sudan=-19.1/28.4/78.2, Port Vila=-28.2/24.3/71.3, Port-Gentil=-22.6/26.0/81.2, Portland (OR)=-37.2/12.4/64.9, Porto=-34.6/15.7/65.3, Prague=-43.5/8.4/56.4, Praia=-25.1/24.4/73.9, Pretoria=-32.1/18.2/68.7, Pyongyang=-36.5/10.8/62.1, Rabat=-31.8/17.2/65.1, Rangpur=-24.0/24.4/71.3, Reggane=-24.1/28.3/78.0, Reykjavík=-44.0/4.3/54.8, Riga=-46.4/6.2/53.0, Riyadh=-26.5/26.0/75.3, Rome=-37.8/15.2/64.4, Roseau=-22.7/26.2/76.4, Rostov-on-Don=-38.2/9.9/58.8, Sacramento=-37.6/16.3/65.8, Saint Petersburg=-43.3/5.8/53.8, Saint-Pierre=-46.9/5.7/57.1, Salt Lake City=-36.3/11.6/62.2, San Antonio=-28.4/20.8/68.9, San Diego=-30.2/17.8/65.7, San Francisco=-36.1/14.6/63.3, San Jose=-33.5/16.4/66.0, San José=-28.2/22.6/81.0, San Juan=-22.4/27.2/79.3, San Salvador=-27.5/23.1/71.8, Sana'a=-28.6/20.0/70.6, Santo Domingo=-21.4/25.9/78.2, Sapporo=-39.8/8.9/61.5, Sarajevo=-36.3/10.1/59.0, Saskatoon=-45.5/3.3/52.1, Seattle=-34.9/11.3/60.8, Seoul=-34.6/12.5/59.5, Seville=-28.2/19.2/71.0, Shanghai=-37.9/16.7/65.4, Singapore=-24.3/27.0/75.6, Skopje=-37.1/12.4/65.1, Sochi=-41.5/14.2/64.4, Sofia=-38.3/10.6/58.1, Sokoto=-19.5/28.0/76.0, Split=-33.0/16.1/65.9, St. John's=-45.8/5.0/54.4, St. Louis=-38.4/13.9/61.6, Stockholm=-43.3/6.6/61.4, Surabaya=-22.7/27.1/80.4, Suva=-25.5/25.6/75.4, Suwałki=-40.5/7.2/55.1, Sydney=-34.9/17.7/69.5, Ségou=-22.3/28.0/75.5, Tabora=-26.9/23.0/74.5, Tabriz=-35.0/12.6/63.8, Taipei=-28.6/23.0/75.9, Tallinn=-43.8/6.4/56.7, Tamale=-21.5/27.9/78.9, Tamanrasset=-24.9/21.7/73.8, Tampa=-24.2/22.9/72.1, Tashkent=-34.1/14.8/68.4, Tauranga=-34.4/14.8/62.9, Tbilisi=-35.7/12.9/63.7, Tegucigalpa=-29.4/21.7/72.5, Tehran=-31.7/17.0/65.1, Tel Aviv=-32.2/20.0/67.5, Thessaloniki=-35.8/16.0/67.4, Thiès=-28.4/24.0/75.5, Tijuana=-31.2/17.8/71.6, Timbuktu=-20.7/28.0/75.4, Tirana=-34.9/15.2/66.1, Toamasina=-27.0/23.4/72.7, Tokyo=-33.2/15.4/61.9, Toliara=-26.0/24.1/78.0, Toluca=-39.8/12.4/67.9, Toronto=-40.4/9.4/62.2, Tripoli=-28.2/20.0/68.7, Tromsø=-45.0/2.9/54.5, Tucson=-31.0/20.9/71.0, Tunis=-29.8/18.4/68.3, Ulaanbaatar=-50.6/-0.4/47.6, Upington=-27.6/20.4/70.6, Vaduz=-42.2/10.1/59.0, Valencia=-28.5/18.3/71.9, Valletta=-30.3/18.8/68.7, Vancouver=-40.3/10.4/63.5, Veracruz=-21.7/25.4/73.2, Vienna=-42.7/10.4/59.5, Vientiane=-23.7/25.9/73.1, Villahermosa=-20.9/27.1/79.3, Vilnius=-47.1/6.0/55.3, Virginia Beach=-34.2/15.8/69.8, Vladivostok=-43.8/4.9/54.0, Warsaw=-37.1/8.5/60.0, Washington, D.C.=-36.6/14.6/62.5, Wau=-22.2/27.8/76.1, Wellington=-37.5/12.9/64.0, Whitehorse=-49.8/-0.1/59.8, Wichita=-34.0/13.9/65.8, Willemstad=-29.4/28.0/78.5, Winnipeg=-47.4/3.0/55.2, Wrocław=-37.7/9.6/60.3, Xi'an=-37.1/14.1/62.4, Yakutsk=-61.5/-8.8/39.4, Yangon=-20.8/27.5/78.5, Yaoundé=-25.4/23.8/74.6, Yellowknife=-58.3/-4.3/44.8, Yerevan=-35.5/12.4/70.4, Yinchuan=-47.9/9.0/61.2, Zagreb=-41.8/10.7/60.5, Zanzibar City=-21.8/26.0/78.9, Zürich=-41.5/9.3/59.8, Ürümqi=-40.6/7.4/58.6, İzmir=-29.6/17.9/71.1}

real	0m0.767s
user	0m14.276s
sys	0m0.373s

$ ./prepare_thomaswue.sh 

Stop! Candidate version is not installed.

$ sdk install java 21.0.2-graal

 ./prepare_thomaswue.sh 

Using java version 21.0.2-graal in this shell.
Warning: The option '-H:-GenLoopSafepoints' is experimental and must be enabled via '-H:+UnlockExperimentalVMOptions' in the future.
Warning: Please re-evaluate whether any experimental option is required, and either remove or unlock it. The build output lists all active experimental options, including where they come from and possible alternatives. If you think an experimental option should be considered as stable, please file an issue.
========================================================================================================================
GraalVM Native Image: Generating 'CalculateAverage_thomaswue_image' (executable)...
========================================================================================================================
[1/8] Initializing...                                                                                    (1.5s @ 0.15GB)
 Java version: 21.0.2+13-LTS, vendor version: Oracle GraalVM 21.0.2+13.1
 Graal compiler: optimization level: 3, target machine: native, PGO: ML-inferred
 C compiler: gcc (linux, x86_64, 15.2.0)
 Garbage collector: Epsilon GC (max heap size: 80% of RAM)
 1 user-specific feature(s):
 - com.oracle.svm.thirdparty.gson.GsonFeature
------------------------------------------------------------------------------------------------------------------------
Build resources:
 - 9.25GB of memory (30.6% of 30.22GB system memory, determined at start)
 - 24 thread(s) (100.0% of 24 available processor(s), determined at start)
[2/8] Performing analysis...  [*****]                                                                    (2.4s @ 0.29GB)
    3,383 reachable types   (72.2% of    4,685 total)
    3,940 reachable fields  (49.5% of    7,963 total)
   17,139 reachable methods (46.2% of   37,098 total)
    1,075 types,   115 fields, and   685 methods registered for reflection
       58 types,    63 fields, and    52 methods registered for JNI access
       0 foreign downcalls registered
        4 native libraries: dl, pthread, rt, z
[3/8] Building universe...                                                                               (0.7s @ 0.36GB)
[4/8] Parsing methods...      [*]                                                                        (1.0s @ 0.43GB)
[5/8] Inlining methods...     [***]                                                                      (0.1s @ 0.45GB)
[6/8] Compiling methods...    [***]                                                                      (9.0s @ 0.48GB)
[7/8] Layouting methods...    [*]                                                                        (0.9s @ 0.74GB)
[8/8] Creating image...       [*
]                                                                        (0.0s @ 0.86GB)
------------------------------------------------------------------------------------------------------------------------
                       1.3s (7.5% of total time) in 218 GCs | Peak RSS: 1.89GB | CPU load: 16.63
------------------------------------------------------------------------------------------------------------------------
Produced artifacts:
 /home/folkol/code/labs/1brc/java-orig/target/svm_err_b_20251223T151454.430_pid6347.md (build_info)
========================================================================================================================
Failed generating 'CalculateAverage_thomaswue_image' after 16.5s.

The build process encountered an unexpected error:

> java.lang.RuntimeException: There was an error linking the native image: Linker command exited with 1

Based on the linker command output, possible reasons for this include:
1. It appears as though libz:.a is missing. Please install it.

Linker command executed:
/usr/bin/gcc -z noexecstack -Wl,--gc-sections -Wl,--version-script,/tmp/SVM-3461978241100526307/exported_symbols.list -Wl,-x -o /home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image CalculateAverage_thomaswue_image.o /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64/liblibchelper.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libnet.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libnio.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libjava.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libzip.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64/libjvm.a -Wl,--export-dynamic -v -L/tmp/SVM-3461978241100526307 -L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc -L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64 -lz -ldl -lpthread -lrt

Linker command output:
Using built-in specs.
COLLECT_GCC=/usr/bin/gcc
COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-linux-gnu/15/lto-wrapper
OFFLOAD_TARGET_NAMES=nvptx-none:amdgcn-amdhsa
OFFLOAD_TARGET_DEFAULT=1
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Ubuntu 15.2.0-4ubuntu4' --with-bugurl=file:///usr/share/doc/gcc-15/README.Bugs --enable-languages=c,ada,c++,go,d,fortran,objc,obj-c++,m2,rust,cobol,algol68 --prefix=/usr --with-gcc-major-version-only --program-suffix=-15 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/libexec --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-libstdcxx-backtrace --enable-gnu-unique-object --disable-vtable-verify --enable-plugin --enable-default-pie --with-system-zlib --enable-libphobos-checking=release --with-target-system-zlib=auto --enable-objc-gc=auto --enable-multiarch --disable-werror --enable-cet --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none=/build/gcc-15-deiAlw/gcc-15-15.2.0/debian/tmp-nvptx/usr,amdgcn-amdhsa=/build/gcc-15-deiAlw/gcc-15-15.2.0/debian/tmp-gcn/usr --enable-offload-defaulted --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu --with-build-config=bootstrap-lto-lean --enable-link-serialization=2
Thread model: posix
Supported LTO compression algorithms: zlib zstd
gcc version 15.2.0 (Ubuntu 15.2.0-4ubuntu4) 
COMPILER_PATH=/usr/libexec/gcc/x86_64-linux-gnu/15/:/usr/libexec/gcc/x86_64-linux-gnu/15/:/usr/libexec/gcc/x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/15/:/usr/lib/gcc/x86_64-linux-gnu/
LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu/15/:/usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/15/../../../../lib/:/lib/x86_64-linux-gnu/:/lib/../lib/:/usr/lib/x86_64-linux-gnu/:/usr/lib/../lib/:/usr/lib/gcc/x86_64-linux-gnu/15/../../../:/lib/:/usr/lib/
COLLECT_GCC_OPTIONS='-z' 'noexecstack' '-o' '/home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image' '-v' '-L/tmp/SVM-3461978241100526307' '-L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc' '-L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64' '-mtune=generic' '-march=x86-64' '-dumpdir' '/home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image.'
 /usr/libexec/gcc/x86_64-linux-gnu/15/collect2 -plugin /usr/libexec/gcc/x86_64-linux-gnu/15/liblto_plugin.so -plugin-opt=/usr/libexec/gcc/x86_64-linux-gnu/15/lto-wrapper -plugin-opt=-fresolution=/tmp/cci8KkGh.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu --as-needed -dynamic-linker /lib64/ld-linux-x86-64.so.2 -pie -z now -z relro -o /home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image -z noexecstack /usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu/Scrt1.o /usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/15/crtbeginS.o -L/tmp/SVM-3461978241100526307 -L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc -L/home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64 -L/usr/lib/gcc/x86_64-linux-gnu/15 -L/usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/15/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/15/../../.. -L/lib -L/usr/lib --gc-sections --version-script /tmp/SVM-3461978241100526307/exported_symbols.list -x CalculateAverage_thomaswue_image.o /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64/liblibchelper.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libnet.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libnio.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libjava.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/static/linux-amd64/glibc/libzip.a /home/folkol/.sdkman/candidates/java/21.0.2-graal/lib/svm/clibraries/linux-amd64/libjvm.a --export-dynamic -lz -ldl -lpthread -lrt -lgcc --push-state --as-needed -lgcc_s --pop-state -lc -lgcc --push-state --as-needed -lgcc_s --pop-state /usr/lib/gcc/x86_64-linux-gnu/15/crtendS.o /usr/lib/gcc/x86_64-linux-gnu/15/../../../x86_64-linux-gnu/crtn.o
/usr/bin/ld: cannot find -lz: No such file or directory
collect2: error: ld returned 1 exit status

Please inspect the generated error report at:
/home/folkol/code/labs/1brc/java-orig/target/svm_err_b_20251223T151454.430_pid6347.md

If you are unable to resolve this problem, please file an issue with the error report at:
https://graalvm.org/support

$ sudo apt install zlib1g-dev

$ ./prepare_thomaswue.sh 

Using java version 21.0.2-graal in this shell.
Warning: The option '-H:-GenLoopSafepoints' is experimental and must be enabled via '-H:+UnlockExperimentalVMOptions' in the future.
Warning: Please re-evaluate whether any experimental option is required, and either remove or unlock it. The build output lists all active experimental options, including where they come from and possible alternatives. If you think an experimental option should be considered as stable, please file an issue.
========================================================================================================================
GraalVM Native Image: Generating 'CalculateAverage_thomaswue_image' (executable)...
========================================================================================================================
[1/8] Initializing...                                                                                    (1.4s @ 0.16GB)
 Java version: 21.0.2+13-LTS, vendor version: Oracle GraalVM 21.0.2+13.1
 Graal compiler: optimization level: 3, target machine: native, PGO: ML-inferred
 C compiler: gcc (linux, x86_64, 15.2.0)
 Garbage collector: Epsilon GC (max heap size: 80% of RAM)
 1 user-specific feature(s):
 - com.oracle.svm.thirdparty.gson.GsonFeature
------------------------------------------------------------------------------------------------------------------------
Build resources:
 - 9.18GB of memory (30.4% of 30.22GB system memory, determined at start)
 - 24 thread(s) (100.0% of 24 available processor(s), determined at start)
[2/8] Performing analysis...  [****]                                                                     (2.3s @ 0.31GB)
    3,383 reachable types   (72.2% of    4,685 total)
    3,940 reachable fields  (49.5% of    7,963 total)
   17,139 reachable methods (46.2% of   37,098 total)
    1,075 types,   115 fields, and   685 methods registered for reflection
       58 types,    63 fields, and    52 methods registered for JNI access
       0 foreign downcalls registered
        4 native libraries: dl, pthread, rt, z
[3/8] Building universe...                                                                               (0.7s @ 0.33GB)
[4/8] Parsing methods...      [*]                                                                        (0.9s @ 0.51GB)
[5/8] Inlining methods...     [***]                                                                      (0.1s @ 0.56GB)
[6/8] Compiling methods...    [***]                                                                      (8.9s @ 0.50GB)
[7/8] Layouting methods...    [*]                                                                        (0.9s @ 0.77GB)
[8/8] Creating image...       [*]                                                                        (0.6s @ 0.89GB)
  11.85MB (58.47%) for code area:     7,892 compilation units
   7.70MB (37.99%) for image heap:  106,852 objects and 47 resources
 734.72kB ( 3.54%) for other data
  20.27MB in total
------------------------------------------------------------------------------------------------------------------------
Top 10 origins of code area:                                Top 10 object types in image heap:
   9.03MB java.base                                            2.87MB byte[] for code metadata
   1.57MB svm.jar (Native Image)                               1.31MB byte[] for java.lang.String
 558.37kB com.oracle.svm.svm_enterprise                      780.19kB java.lang.String
 240.60kB java.logging                                       571.82kB java.lang.Class
  65.01kB jdk.proxy3                                         279.11kB byte[] for general heap data
  63.17kB jdk.proxy1                                         240.47kB java.util.HashMap$Node
  60.54kB jdk.internal.vm.compiler                           173.74kB byte[] for reflection metadata
  60.15kB jdk.internal.vm.ci                                 158.58kB com.oracle.svm.core.hub.DynamicHubCompanion
  57.33kB org.graalvm.nativeimage.base                       154.34kB byte[] for embedded resources
  55.16kB average-1.0.0-SNAPSHOT.jar                         145.88kB char[]
  66.33kB for 5 more packages                                  1.07MB for 885 more object types
                              Use '-H:+BuildReport' to create a report with more details.
------------------------------------------------------------------------------------------------------------------------
Security report:
 - Binary includes Java deserialization.
 - Use '--enable-sbom' to embed a Software Bill of Materials (SBOM) in the binary.
------------------------------------------------------------------------------------------------------------------------
Recommendations:
 PGO:  Use Profile-Guided Optimizations ('--pgo') for improved throughput.
 INIT: Adopt '--strict-image-heap' to prepare for the next GraalVM release.
 HEAP: Set max heap for improved and more predictable memory usage.
 QBM:  Use the quick build mode ('-Ob') to speed up builds during development.
------------------------------------------------------------------------------------------------------------------------
                       1.2s (7.1% of total time) in 189 GCs | Peak RSS: 2.80GB | CPU load: 16.97
------------------------------------------------------------------------------------------------------------------------
Produced artifacts:
 /home/folkol/code/labs/1brc/java-orig/target/CalculateAverage_thomaswue_image (executable)
========================================================================================================================
Finished generating 'CalculateAverage_thomaswue_image' in 16.1s.

$ time ./calculate_average_thomaswue.sh 
Picking up existing native image 'target/CalculateAverage_thomaswue_image', delete the file to select JVM mode.
{Abha=-33.8/18.0/71.1, Abidjan=-23.6/26.0/77.3, Abéché=-23.2/29.4/78.4, Accra=-24.3/26.4/79.3, Addis Ababa=-34.5/16.0/64.9, Adelaide=-30.2/17.3/71.5, Aden=-20.4/29.1/79.8, Ahvaz=-25.4/25.4/73.8, Albuquerque=-39.2/14.0/66.5, Alexandra=-47.2/11.0/63.2, Alexandria=-31.4/20.0/68.1, Algiers=-32.1/18.2/69.8, Alice Springs=-30.5/21.0/68.0, Almaty=-45.3/10.0/58.1, Amsterdam=-40.1/10.2/59.0, Anadyr=-62.8/-6.9/41.8, Anchorage=-45.2/2.8/50.0, Andorra la Vella=-38.7/9.8/63.8, Ankara=-35.6/12.0/61.5, Antananarivo=-38.7/17.9/66.7, Antsiranana=-26.5/25.2/75.0, Arkhangelsk=-48.3/1.3/50.9, Ashgabat=-31.6/17.1/70.0, Asmara=-32.9/15.6/67.9, Assab=-16.7/30.5/77.9, Astana=-44.6/3.5/55.2, Athens=-31.2/19.2/66.6, Atlanta=-34.2/17.0/64.3, Auckland=-40.5/15.2/63.7, Austin=-30.0/20.7/71.6, Baghdad=-26.6/22.8/73.0, Baguio=-34.7/19.5/73.4, Baku=-42.1/15.1/66.5, Baltimore=-38.4/13.1/61.2, Bamako=-22.5/27.8/75.8, Bangkok=-22.3/28.6/78.2, Bangui=-26.7/26.0/73.9, Banjul=-23.0/26.0/74.9, Barcelona=-32.1/18.2/67.3, Bata=-22.9/25.1/76.3, Batumi=-32.6/14.0/64.5, Beijing=-37.7/12.9/60.8, Beirut=-31.0/20.9/69.9, Belgrade=-41.2/12.5/60.6, Belize City=-23.2/26.7/74.2, Benghazi=-34.4/19.9/67.0, Bergen=-39.9/7.7/55.5, Berlin=-40.4/10.3/67.7, Bilbao=-35.5/14.7/63.6, Birao=-29.1/26.5/77.4, Bishkek=-38.0/11.3/60.3, Bissau=-28.3/27.0/76.4, Blantyre=-25.6/22.2/71.8, Bloemfontein=-37.0/15.6/64.2, Boise=-35.2/11.4/59.5, Bordeaux=-33.0/14.2/66.0, Bosaso=-17.8/30.0/80.3, Boston=-36.8/10.9/71.6, Bouaké=-25.7/26.0/75.6, Bratislava=-39.0/10.5/61.6, Brazzaville=-29.1/25.0/73.2, Bridgetown=-21.9/27.0/76.9, Brisbane=-30.6/21.4/70.6, Brussels=-38.1/10.5/60.0, Bucharest=-42.1/10.8/60.8, Budapest=-41.3/11.3/61.7, Bujumbura=-24.1/23.8/72.8, Bulawayo=-31.9/18.9/74.1, Burnie=-34.0/13.1/63.7, Busan=-36.7/15.0/66.3, Cabo San Lucas=-25.5/23.9/72.3, Cairns=-26.3/25.0/74.1, Cairo=-29.7/21.4/72.6, Calgary=-46.0/4.4/55.7, Canberra=-36.7/13.1/66.9, Cape Town=-31.8/16.2/67.1, Changsha=-34.8/17.4/68.1, Charlotte=-36.6/16.1/66.8, Chiang Mai=-29.7/25.8/72.6, Chicago=-39.6/9.8/62.2, Chihuahua=-30.7/18.6/66.7, Chittagong=-26.0/25.9/82.7, Chișinău=-38.7/10.2/55.8, Chongqing=-33.8/18.6/66.7, Christchurch=-38.4/12.2/61.7, City of San Marino=-37.4/11.8/57.4, Colombo=-23.4/27.4/79.1, Columbus=-35.9/11.7/73.2, Conakry=-23.3/26.4/74.6, Copenhagen=-39.3/9.1/60.7, Cotonou=-21.0/27.2/80.1, Cracow=-44.9/9.3/58.3, Da Lat=-32.6/17.9/65.6, Da Nang=-24.8/25.8/75.6, Dakar=-27.6/24.0/73.8, Dallas=-31.3/19.0/70.2, Damascus=-32.9/17.0/64.2, Dampier=-20.4/26.4/77.5, Dar es Salaam=-25.5/25.8/73.2, Darwin=-26.1/27.6/79.0, Denpasar=-23.6/23.7/74.5, Denver=-39.7/10.4/62.4, Detroit=-43.4/10.0/63.1, Dhaka=-22.1/25.9/78.3, Dikson=-64.9/-11.1/39.5, Dili=-22.8/26.6/78.2, Djibouti=-19.0/29.9/84.4, Dodoma=-25.3/22.7/76.2, Dolisie=-24.4/24.0/76.6, Douala=-21.8/26.7/79.3, Dubai=-20.2/26.9/74.2, Dublin=-45.0/9.8/56.9, Dunedin=-44.3/11.1/63.1, Durban=-28.1/20.6/72.6, Dushanbe=-35.9/14.7/63.6, Edinburgh=-43.6/9.3/64.0, Edmonton=-45.4/4.2/52.4, El Paso=-31.7/18.1/65.7, Entebbe=-32.0/21.0/72.1, Erbil=-27.9/19.5/67.4, Erzurum=-42.6/5.1/55.2, Fairbanks=-49.7/-2.3/49.8, Fianarantsoa=-32.9/17.9/66.1, Flores,  Petén=-23.7/26.4/78.9, Frankfurt=-40.1/10.6/58.2, Fresno=-33.9/17.9/66.0, Fukuoka=-33.0/17.0/68.8, Gaborone=-27.4/21.0/68.8, Gabès=-29.9/19.5/67.4, Gagnoa=-25.9/26.0/74.5, Gangtok=-32.0/15.2/65.4, Garissa=-22.6/29.3/77.9, Garoua=-23.0/28.3/80.1, George Town=-22.0/27.9/80.3, Ghanzi=-25.5/21.4/74.6, Gjoa Haven=-64.0/-14.4/36.1, Guadalajara=-28.5/20.9/70.1, Guangzhou=-26.9/22.4/70.8, Guatemala City=-32.0/20.4/70.9, Halifax=-40.7/7.5/55.2, Hamburg=-38.3/9.7/59.7, Hamilton=-37.7/13.8/62.7, Hanga Roa=-29.0/20.5/71.8, Hanoi=-28.9/23.6/75.7, Harare=-37.7/18.4/71.6, Harbin=-48.2/5.0/60.7, Hargeisa=-26.4/21.7/68.6, Hat Yai=-22.5/27.0/74.9, Havana=-23.4/25.2/77.2, Helsinki=-45.7/5.9/60.0, Heraklion=-40.2/18.9/65.3, Hiroshima=-36.1/16.3/65.6, Ho Chi Minh City=-24.4/27.4/76.3, Hobart=-39.3/12.7/62.3, Hong Kong=-24.8/23.3/73.4, Honiara=-27.1/26.5/76.9, Honolulu=-24.1/25.4/74.2, Houston=-28.6/20.8/77.1, Ifrane=-39.4/11.4/63.2, Indianapolis=-42.1/11.8/64.6, Iqaluit=-56.3/-9.3/41.8, Irkutsk=-50.8/1.0/49.9, Istanbul=-40.4/13.9/61.7, Jacksonville=-30.9/20.3/67.6, Jakarta=-21.4/26.7/74.5, Jayapura=-24.6/27.0/79.6, Jerusalem=-30.4/18.3/70.2, Johannesburg=-34.8/15.5/68.2, Jos=-27.0/22.8/74.9, Juba=-19.9/27.8/78.6, Kabul=-38.6/12.1/60.0, Kampala=-31.5/20.0/67.9, Kandi=-23.4/27.7/79.0, Kankan=-23.2/26.5/81.6, Kano=-27.1/26.4/74.4, Kansas City=-39.3/12.5/62.0, Karachi=-27.1/26.0/75.5, Karonga=-29.7/24.4/70.6, Kathmandu=-34.1/18.3/67.6, Khartoum=-26.2/29.9/77.9, Kingston=-24.3/27.4/81.1, Kinshasa=-22.3/25.3/75.8, Kolkata=-22.0/26.7/79.8, Kuala Lumpur=-22.4/27.3/78.1, Kumasi=-20.9/26.0/76.0, Kunming=-33.5/15.7/69.3, Kuopio=-46.6/3.4/55.9, Kuwait City=-27.2/25.7/75.4, Kyiv=-42.3/8.4/57.5, Kyoto=-32.9/15.8/66.4, La Ceiba=-22.4/26.2/80.0, La Paz=-29.1/23.7/77.9, Lagos=-23.3/26.8/76.5, Lahore=-30.8/24.3/74.6, Lake Havasu City=-27.0/23.7/70.0, Lake Tekapo=-45.1/8.7/56.8, Las Palmas de Gran Canaria=-31.1/21.2/72.2, Las Vegas=-28.6/20.3/69.4, Launceston=-40.0/13.1/65.1, Lhasa=-43.5/7.6/63.7, Libreville=-23.3/25.9/76.1, Lisbon=-34.0/17.5/64.7, Livingstone=-27.7/21.8/72.2, Ljubljana=-42.6/10.9/60.3, Lodwar=-20.6/29.3/76.7, Lomé=-26.5/26.9/76.1, London=-35.9/11.3/59.5, Los Angeles=-34.2/18.6/70.0, Louisville=-36.0/13.9/67.5, Luanda=-26.2/25.8/77.2, Lubumbashi=-27.2/20.8/66.3, Lusaka=-32.0/19.9/70.8, Luxembourg City=-40.8/9.3/61.1, Lviv=-38.6/7.8/59.3, Lyon=-35.0/12.5/57.7, Madrid=-33.2/15.0/63.1, Mahajanga=-26.0/26.3/79.1, Makassar=-22.0/26.7/75.4, Makurdi=-27.2/26.0/81.2, Malabo=-22.2/26.3/77.7, Malé=-20.6/28.0/81.6, Managua=-25.6/27.3/75.2, Manama=-24.6/26.5/74.7, Mandalay=-22.0/28.0/78.6, Mango=-19.7/28.1/80.6, Manila=-20.7/28.4/80.6, Maputo=-25.0/22.8/72.2, Marrakesh=-27.4/19.6/68.8, Marseille=-32.8/15.8/64.9, Maun=-30.5/22.4/73.0, Medan=-26.2/26.5/78.0, Mek'ele=-26.6/22.7/77.8, Melbourne=-46.0/15.1/71.8, Memphis=-35.3/17.2/68.3, Mexicali=-24.8/23.1/75.3, Mexico City=-34.7/17.5/66.8, Miami=-25.3/24.9/73.5, Milan=-34.7/13.0/63.5, Milwaukee=-46.4/8.9/58.4, Minneapolis=-42.0/7.8/56.5, Minsk=-42.8/6.7/55.9, Mogadishu=-27.5/27.1/75.5, Mombasa=-23.1/26.3/72.7, Monaco=-34.4/16.4/65.2, Moncton=-40.1/6.1/59.1, Monterrey=-28.5/22.3/75.7, Montreal=-43.3/6.8/58.5, Moscow=-45.0/5.8/53.6, Mumbai=-19.6/27.1/76.5, Murmansk=-53.3/0.6/50.6, Muscat=-23.0/28.0/80.4, Mzuzu=-32.4/17.7/66.4, N'Djamena=-21.2/28.3/74.8, Naha=-30.1/23.1/74.6, Nairobi=-32.1/17.8/65.2, Nakhon Ratchasima=-24.6/27.3/80.1, Napier=-34.5/14.6/60.2, Napoli=-37.7/15.9/66.2, Nashville=-34.2/15.4/62.5, Nassau=-29.1/24.6/75.7, Ndola=-27.9/20.3/69.4, New Delhi=-30.5/25.0/74.9, New Orleans=-33.1/20.7/77.8, New York City=-37.6/12.9/63.8, Ngaoundéré=-30.2/22.0/75.7, Niamey=-26.6/29.3/79.4, Nicosia=-27.7/19.7/68.8, Niigata=-35.1/13.9/65.4, Nouadhibou=-30.4/21.3/72.7, Nouakchott=-24.9/25.7/73.9, Novosibirsk=-49.9/1.7/54.6, Nuuk=-48.8/-1.4/49.9, Odesa=-38.7/10.7/64.3, Odienné=-24.8/26.0/76.7, Oklahoma City=-31.6/15.9/64.8, Omaha=-39.6/10.6/60.8, Oranjestad=-26.4/28.1/78.1, Oslo=-45.8/5.7/54.8, Ottawa=-42.3/6.6/58.7, Ouagadougou=-20.4/28.3/80.3, Ouahigouya=-18.9/28.6/77.8, Ouarzazate=-30.9/18.9/81.8, Oulu=-45.8/2.7/53.3, Palembang=-20.5/27.3/76.0, Palermo=-35.6/18.5/72.9, Palm Springs=-29.0/24.5/73.2, Palmerston North=-37.8/13.2/63.0, Panama City=-21.2/28.0/77.2, Parakou=-23.3/26.8/77.6, Paris=-41.0/12.3/61.6, Perth=-34.9/18.7/70.0, Petropavlovsk-Kamchatsky=-45.6/1.9/51.1, Philadelphia=-42.3/13.2/64.2, Phnom Penh=-23.5/28.3/80.6, Phoenix=-27.5/23.9/74.1, Pittsburgh=-41.1/10.8/66.7, Podgorica=-36.2/15.3/68.1, Pointe-Noire=-21.2/26.1/76.8, Pontianak=-19.2/27.7/79.8, Port Moresby=-24.0/26.9/74.9, Port Sudan=-19.1/28.4/78.2, Port Vila=-28.2/24.3/71.3, Port-Gentil=-22.6/26.0/81.2, Portland (OR)=-37.2/12.4/64.9, Porto=-34.6/15.7/65.3, Prague=-43.5/8.4/56.4, Praia=-25.1/24.4/73.9, Pretoria=-32.1/18.2/68.7, Pyongyang=-36.5/10.8/62.1, Rabat=-31.8/17.2/65.1, Rangpur=-24.0/24.4/71.3, Reggane=-24.1/28.3/78.0, Reykjavík=-44.0/4.3/54.8, Riga=-46.4/6.2/53.0, Riyadh=-26.5/26.0/75.3, Rome=-37.8/15.2/64.4, Roseau=-22.7/26.2/76.4, Rostov-on-Don=-38.2/9.9/58.8, Sacramento=-37.6/16.3/65.8, Saint Petersburg=-43.3/5.8/53.8, Saint-Pierre=-46.9/5.7/57.1, Salt Lake City=-36.3/11.6/62.2, San Antonio=-28.4/20.8/68.9, San Diego=-30.2/17.8/65.7, San Francisco=-36.1/14.6/63.3, San Jose=-33.5/16.4/66.0, San José=-28.2/22.6/81.0, San Juan=-22.4/27.2/79.3, San Salvador=-27.5/23.1/71.8, Sana'a=-28.6/20.0/70.6, Santo Domingo=-21.4/25.9/78.2, Sapporo=-39.8/8.9/61.5, Sarajevo=-36.3/10.1/59.0, Saskatoon=-45.5/3.3/52.1, Seattle=-34.9/11.3/60.8, Seoul=-34.6/12.5/59.5, Seville=-28.2/19.2/71.0, Shanghai=-37.9/16.7/65.4, Singapore=-24.3/27.0/75.6, Skopje=-37.1/12.4/65.1, Sochi=-41.5/14.2/64.4, Sofia=-38.3/10.6/58.1, Sokoto=-19.5/28.0/76.0, Split=-33.0/16.1/65.9, St. John's=-45.8/5.0/54.4, St. Louis=-38.4/13.9/61.6, Stockholm=-43.3/6.6/61.4, Surabaya=-22.7/27.1/80.4, Suva=-25.5/25.6/75.4, Suwałki=-40.5/7.2/55.1, Sydney=-34.9/17.7/69.5, Ségou=-22.3/28.0/75.5, Tabora=-26.9/23.0/74.5, Tabriz=-35.0/12.6/63.8, Taipei=-28.6/23.0/75.9, Tallinn=-43.8/6.4/56.7, Tamale=-21.5/27.9/78.9, Tamanrasset=-24.9/21.7/73.8, Tampa=-24.2/22.9/72.1, Tashkent=-34.1/14.8/68.4, Tauranga=-34.4/14.8/62.9, Tbilisi=-35.7/12.9/63.7, Tegucigalpa=-29.4/21.7/72.5, Tehran=-31.7/17.0/65.1, Tel Aviv=-32.2/20.0/67.5, Thessaloniki=-35.8/16.0/67.4, Thiès=-28.4/24.0/75.5, Tijuana=-31.2/17.8/71.6, Timbuktu=-20.7/28.0/75.4, Tirana=-34.9/15.2/66.1, Toamasina=-27.0/23.4/72.7, Tokyo=-33.2/15.4/61.9, Toliara=-26.0/24.1/78.0, Toluca=-39.8/12.4/67.9, Toronto=-40.4/9.4/62.2, Tripoli=-28.2/20.0/68.7, Tromsø=-45.0/2.9/54.5, Tucson=-31.0/20.9/71.0, Tunis=-29.8/18.4/68.3, Ulaanbaatar=-50.6/-0.4/47.6, Upington=-27.6/20.4/70.6, Vaduz=-42.2/10.1/59.0, Valencia=-28.5/18.3/71.9, Valletta=-30.3/18.8/68.7, Vancouver=-40.3/10.4/63.5, Veracruz=-21.7/25.4/73.2, Vienna=-42.7/10.4/59.5, Vientiane=-23.7/25.9/73.1, Villahermosa=-20.9/27.1/79.3, Vilnius=-47.1/6.0/55.3, Virginia Beach=-34.2/15.8/69.8, Vladivostok=-43.8/4.9/54.0, Warsaw=-37.1/8.5/60.0, Washington, D.C.=-36.6/14.6/62.5, Wau=-22.2/27.8/76.1, Wellington=-37.5/12.9/64.0, Whitehorse=-49.8/-0.1/59.8, Wichita=-34.0/13.9/65.8, Willemstad=-29.4/28.0/78.5, Winnipeg=-47.4/3.0/55.2, Wrocław=-37.7/9.6/60.3, Xi'an=-37.1/14.1/62.4, Yakutsk=-61.5/-8.8/39.4, Yangon=-20.8/27.5/78.5, Yaoundé=-25.4/23.8/74.6, Yellowknife=-58.3/-4.3/44.8, Yerevan=-35.5/12.4/70.4, Yinchuan=-47.9/9.0/61.2, Zagreb=-41.8/10.7/60.5, Zanzibar City=-21.8/26.0/78.9, Zürich=-41.5/9.3/59.8, Ürümqi=-40.6/7.4/58.6, İzmir=-29.6/17.9/71.1}

real	0m0.216s
user	0m0.001s
sys	0m0.003s

>> Trying latest graal as well for comparison

$ sdk install java 26.ea.13-graal

>> 15 min later... had to remove a lot of contributions that did not build with this ea(!) graal release. Changed graal version in the ./prepare script and changed compiler version in the pom.xml

No difference :)

(Tried 25 and 24 as well, no difference. But I had to use -H:+ForeignAPISupport with 24...)

## So, what does it do?

/**
 * The solution starts a child worker process for the actual work such that clean up of the memory mapping can occur
 * while the main process already returns with the result. The worker then memory maps the input file, creates a worker
 * thread per available core, and then processes segments of size {@link #SEGMENT_SIZE} at a time. The segments are
 * split into 3 parts and cursors for each of those parts are processing the segment simultaneously in the same thread.
 * Results are accumulated into {@link Result} objects and a tree map is used to sequentially accumulate the results in
 * the end.
 * Runs in 0.31 on an Intel i9-13900K while the reference implementation takes 120.37s.
 * Credit:
 *  Quan Anh Mai for branchless number parsing code
 *  Alfonso² Peterssen for suggesting memory mapping with unsafe and the subprocess idea
 *  Artsiom Korzun for showing the benefits of work stealing at 2MB segments instead of equal split between workers
 *  Jaromir Hamala for showing that avoiding the branch misprediction between <8 and 8-16 cases is a big win even if
 *  more work is performed
 *  Van Phu DO for demonstrating the lookup tables based on masks instead of bit shifting
 */
public class CalculateAverage_thomaswue {

Try with different core counts (0-7 are P cores)

$ for c in /sys/devices/system/cpu/cpu*/topology/cluster_cpus_list; do   echo "$c: $(cat $c)"; done | sort -V
/sys/devices/system/cpu/cpu0/topology/cluster_cpus_list: 0
/sys/devices/system/cpu/cpu1/topology/cluster_cpus_list: 1
/sys/devices/system/cpu/cpu2/topology/cluster_cpus_list: 2
/sys/devices/system/cpu/cpu3/topology/cluster_cpus_list: 3
/sys/devices/system/cpu/cpu4/topology/cluster_cpus_list: 4
/sys/devices/system/cpu/cpu5/topology/cluster_cpus_list: 5
/sys/devices/system/cpu/cpu6/topology/cluster_cpus_list: 6
/sys/devices/system/cpu/cpu7/topology/cluster_cpus_list: 7
/sys/devices/system/cpu/cpu8/topology/cluster_cpus_list: 8-11
/sys/devices/system/cpu/cpu9/topology/cluster_cpus_list: 8-11
/sys/devices/system/cpu/cpu10/topology/cluster_cpus_list: 8-11
/sys/devices/system/cpu/cpu11/topology/cluster_cpus_list: 8-11
/sys/devices/system/cpu/cpu12/topology/cluster_cpus_list: 12-15
/sys/devices/system/cpu/cpu13/topology/cluster_cpus_list: 12-15
/sys/devices/system/cpu/cpu14/topology/cluster_cpus_list: 12-15
/sys/devices/system/cpu/cpu15/topology/cluster_cpus_list: 12-15
/sys/devices/system/cpu/cpu16/topology/cluster_cpus_list: 16-19
/sys/devices/system/cpu/cpu17/topology/cluster_cpus_list: 16-19
/sys/devices/system/cpu/cpu18/topology/cluster_cpus_list: 16-19
/sys/devices/system/cpu/cpu19/topology/cluster_cpus_list: 16-19
/sys/devices/system/cpu/cpu20/topology/cluster_cpus_list: 20-23
/sys/devices/system/cpu/cpu21/topology/cluster_cpus_list: 20-23
/sys/devices/system/cpu/cpu22/topology/cluster_cpus_list: 20-23
/sys/devices/system/cpu/cpu23/topology/cluster_cpus_list: 20-23


$ git diff
diff --git a/calculate_average_thomaswue.sh b/calculate_average_thomaswue.sh
index 58c6701..caf97e5 100755
--- a/calculate_average_thomaswue.sh
+++ b/calculate_average_thomaswue.sh
@@ -21,6 +21,6 @@ if [ -f target/CalculateAverage_thomaswue_image ]; then
 else
     JAVA_OPTS="--enable-preview"
     echo "Chosing to run the app in JVM mode as no native image was found, use prepare_thomaswue.sh to generate." 1>&2
-    java $JAVA_OPTS --class-path target/average-1.0.0-SNAPSHOT.jar dev.morling.onebrc.CalculateAverage_thomaswue
+    java $JAVA_OPTS $NUM_PROCS --class-path target/average-1.0.0-SNAPSHOT.jar dev.morling.onebrc.CalculateAverage_thomaswue
 fi

$ for n in {1..40}; do { echo "n: $n" >&2; /usr/bin/time -f '%e' sudo systemd-run --quiet --scope -p CPUQuota=$((n * 100))% target/CalculateAverage_thomaswue_image >/dev/null; } ; done |& sed 's/n: //' | xargs -L2 | uplot bar -d ' ' -w 80
      ┌                                                                                ┐ 
    1 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 4.16   
    2 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 2.22                                      
    3 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■ 1.51                                                  
    4 ┤■■■■■■■■■■■■■■■■■■■■■ 1.16                                                        
    5 ┤■■■■■■■■■■■■■■■■■ 0.93                                                            
    6 ┤■■■■■■■■■■■■■■ 0.78                                                               
    7 ┤■■■■■■■■■■■■ 0.69                                                                 
    8 ┤■■■■■■■■■■■ 0.61                                                                  
    9 ┤■■■■■■■■■■ 0.55                                                                   
   10 ┤■■■■■■■■■ 0.5                                                                     
   11 ┤■■■■■■■■ 0.45                                                                     
   12 ┤■■■■■■■ 0.41                                                                      
   13 ┤■■■■■■■ 0.39                                                                      
   14 ┤■■■■■■ 0.36                                                                       
   15 ┤■■■■■■ 0.35                                                                       
   16 ┤■■■■■■ 0.32                                                                       
   17 ┤■■■■■ 0.3                                                                         
   18 ┤■■■■■ 0.28                                                                        
   19 ┤■■■■■ 0.28                                                                        
   20 ┤■■■■■ 0.27                                                                        
   21 ┤■■■■■ 0.26                                                                        
   22 ┤■■■■ 0.24                                                                         
   23 ┤■■■■ 0.23                                                                         
   24 ┤■■■■ 0.22                                                                         
   25 ┤■■■■ 0.24                                                                         
   26 ┤■■■■ 0.23                                                                         
   27 ┤■■■■ 0.23                                                                         
   28 ┤■■■■ 0.23                                                                         
   29 ┤■■■■ 0.23                                                                         
   30 ┤■■■■ 0.24                                                                         
   31 ┤■■■■ 0.23                                                                         
   32 ┤■■■■ 0.24                                                                         
   33 ┤■■■■ 0.24                                                                         
   34 ┤■■■■ 0.25                                                                         
   35 ┤■■■■ 0.23                                                                         
   36 ┤■■■■ 0.22                                                                         
   37 ┤■■■■ 0.25                                                                         
   38 ┤■■■■ 0.24                                                                         
   39 ┤■■■■ 0.23                                                                         
   40 ┤■■■■ 0.23                                                                         
      └           

Same, but without native image (cold-start jvm etc):

$ for n in {1..40}; do { echo "n: $n" >&2; /usr/bin/time -f '%e' sudo systemd-run --quiet --scope -p CPUQuota=$((n * 100))% /home/folkol/.sdkman/candidates/java/21.0.2-graal/bin/java --enable-preview --class-path target/average-1.0.0-SNAPSHOT.jar dev.morling.onebrc.CalculateAverage_thomaswue >/dev/null; } ; done |& sed 's/n: //' | xargs -L2 | uplot bar -d ' ' -w 80
      ┌                                                                                ┐ 
    1 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 14.39   
    2 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ 8.72                                 
    3 ┤■■■■■■■■■■■■■■■■■■■■■■■■■■ 5.03                                                   
    4 ┤■■■■■■■■■■■■■■■■■■ 3.61                                                           
    5 ┤■■■■■■■■■■■■■■■■ 3.19                                                             
    6 ┤■■■■■■■■■■■■■■ 2.75                                                               
    7 ┤■■■■■■■■■■■■■■ 2.73                                                               
    8 ┤■■■■■■■■■■■ 2.2                                                                   
    9 ┤■■■■■■■■■■■ 2.09                                                                  
   10 ┤■■■■■■■■■ 1.84                                                                    
   11 ┤■■■■■■■■■ 1.8                                                                     
   12 ┤■■■■■■■■ 1.62                                                                     
   13 ┤■■■■■■■ 1.38                                                                      
   14 ┤■■■■■■■ 1.35                                                                      
   15 ┤■■■■■■ 1.15                                                                       
   16 ┤■■■■■■ 1.24                                                                       
   17 ┤■■■■■■ 1.27                                                                       
   18 ┤■■■■■■ 1.14                                                                       
   19 ┤■■■■■ 1.02                                                                        
   20 ┤■■■■■■ 1.14                                                                       
   21 ┤■■■■■ 1.08                                                                        
   22 ┤■■■■■ 0.94                                                                        
   23 ┤■■■■■ 1.05                                                                        
   24 ┤■■■■■ 1.06                                                                        
   25 ┤■■■■■ 0.98                                                                        
   26 ┤■■■■■ 0.99                                                                        
   27 ┤■■■■■ 0.96                                                                        
   28 ┤■■■■ 0.88                                                                         
   29 ┤■■■■■ 0.91                                                                        
   30 ┤■■■■■ 0.92                                                                        
   31 ┤■■■■■ 0.94                                                                        
   32 ┤■■■■■ 0.97                                                                        
   33 ┤■■■■■ 0.94                                                                        
   34 ┤■■■■■ 0.97                                                                        
   35 ┤■■■■■ 0.95                                                                        
   36 ┤■■■■■ 0.94                                                                        
   37 ┤■■■■■ 1.02                                                                        
   38 ┤■■■■■ 0.97                                                                        
   39 ┤■■■■■ 0.99                                                                        
   40 ┤■■■■■ 1.03                                                                        
      └             

## Baseline Rust iteration

Single threaded, naive / straight forward unwrapful 'lines' scanner.

use std::collections::BTreeMap;
use std::io::BufRead;

struct Stats {
    min: f64,
    sum: f64,
    count: usize,
    max: f64,
}

impl Stats {
    fn update(&mut self, temp: f64) {
        self.min = self.min.min(temp);
        self.max = self.max.max(temp);
        self.sum += temp;
        self.count += 1;
    }
}

impl Default for Stats {
    fn default() -> Self {
        Self {
            min: f64::MAX,
            sum: 0.0,
            count: 0,
            max: f64::MIN,
        }
    }
}

fn main() {
    let file = std::fs::File::open("../java-orig/measurements.txt").unwrap();
    let reader = std::io::BufReader::new(file);
    let mut stats: BTreeMap<String, Stats> = Default::default();

    for line in reader.lines() {
        let line = line.unwrap();
        let (station, temp) = line.split_once(';').unwrap();
        let temp: f64 = temp.parse().unwrap();

        stats.entry(station.to_string()).or_default().update(temp);
    }

    print!("{{");
    let num_stations = stats.len();
    for (i, (station, stats)) in stats.iter().enumerate() {
        print!(
            "{station}={:.1}/{:.1}/{:.1}",
            stats.min,
            stats.sum / stats.count as f64,
            stats.max
        );
        if i != num_stations - 1 {
            print!(", ");
        }
    }
    println!("}}");
}

folkol@ubuntu:~/code/labs/1brc/onebrc$ time cargo run --release >output.txt
   Compiling onebrc v0.1.0 (/home/folkol/code/labs/1brc/onebrc)
    Finished `release` profile [optimized] target(s) in 0.12s
     Running `target/release/onebrc`

real	1m32.937s
user	1m32.094s
sys	0m0.946s
folkol@ubuntu:~/code/labs/1brc/onebrc$ git diff --no-index --word-diff output.txt ../expected.txt 
folkol@ubuntu:~/code/labs/1brc/onebrc$ 

Produces the same result at least.

## Where do we spend our time?

Add debug = true to profile.release in Cargo.toml

$ sudo sysctl -w kernel.perf_event_paranoid=1
kernel.perf_event_paranoid = 1
$ sudo sysctl -w kernel.kptr_restrict=0
kernel.kptr_restrict = 0

>> optionally: sudo cpupower frequency-set -g performance

https://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html

$ perf record -F 999 -g --call-graph dwarf ./target/release/onebrc
$ perf report --stdio
$ git clone https://github.com/brendangregg/FlameGraph
$ perf script | FlameGraph/stackcollapse-perf.pl > out.perf-folded
$ FlameGraph/flamegraph.pl ./out.perf-folded >perf.svg
$ open perf.svg 

### Partition the file

- find partition boundaries by scanning for newlines at total_size / num_partitions
- also add some threading scaffolding so that we can run this on multiple cores
- the join code will wait for threads in spawn-order, but let's go with this
- (The java code used mmaps, but I'll stick with .lines() for now)

folkol@ubuntu:~/code/labs/1brc/onebrc$ time ./target/release/onebrc 
{Abha=-33.8/18.0/71.1, Abidjan=-23.6/26.0/77.3, Abéché=-23.2/29.4/78.4, Accra=-24.3/26.4/79.3, Addis Ababa=-34.5/16.0/64.9, Adelaide=-30.2/17.3/71.5, Aden=-20.4/29.1/79.8, Ahvaz=-25.4/25.4/73.8, Albuquerque=-39.2/14.0/66.5, Alexandra=-47.2/11.0/63.2, Alexandria=-31.4/20.0/68.1, Algiers=-32.1/18.2/69.8, Alice Springs=-30.5/21.0/68.0, Almaty=-45.3/10.0/58.1, Amsterdam=-40.1/10.2/59.0, Anadyr=-62.8/-6.9/41.8, Anchorage=-45.2/2.8/50.0, Andorra la Vella=-38.7/9.8/63.8, Ankara=-35.6/12.0/61.5, Antananarivo=-38.7/17.9/66.7, Antsiranana=-26.5/25.2/75.0, Arkhangelsk=-48.3/1.3/50.9, Ashgabat=-31.6/17.1/70.0, Asmara=-32.9/15.6/67.9, Assab=-16.7/30.5/77.9, Astana=-44.6/3.5/55.2, Athens=-31.2/19.2/66.6, Atlanta=-34.2/17.0/64.3, Auckland=-40.5/15.2/63.7, Austin=-30.0/20.7/71.6, Baghdad=-26.6/22.8/73.0, Baguio=-34.7/19.5/73.4, Baku=-42.1/15.1/66.5, Baltimore=-38.4/13.1/61.2, Bamako=-22.5/27.8/75.8, Bangkok=-22.3/28.6/78.2, Bangui=-26.7/26.0/73.9, Banjul=-23.0/26.0/74.9, Barcelona=-32.1/18.2/67.3, Bata=-22.9/25.1/76.3, Batumi=-32.6/14.0/64.5, Beijing=-37.7/12.9/60.8, Beirut=-31.0/20.9/69.9, Belgrade=-41.2/12.5/60.6, Belize City=-23.2/26.7/74.2, Benghazi=-34.4/19.9/67.0, Bergen=-39.9/7.7/55.5, Berlin=-40.4/10.3/67.7, Bilbao=-35.5/14.7/63.6, Birao=-29.1/26.5/77.4, Bishkek=-38.0/11.3/60.3, Bissau=-28.3/27.0/76.4, Blantyre=-25.6/22.2/71.8, Bloemfontein=-37.0/15.6/64.2, Boise=-35.2/11.4/59.5, Bordeaux=-33.0/14.2/66.0, Bosaso=-17.8/30.0/80.3, Boston=-36.8/10.9/71.6, Bouaké=-25.7/26.0/75.6, Bratislava=-39.0/10.5/61.6, Brazzaville=-29.1/25.0/73.2, Bridgetown=-21.9/27.0/76.9, Brisbane=-30.6/21.4/70.6, Brussels=-38.1/10.5/60.0, Bucharest=-42.1/10.8/60.8, Budapest=-41.3/11.3/61.7, Bujumbura=-24.1/23.8/72.8, Bulawayo=-31.9/18.9/74.1, Burnie=-34.0/13.1/63.7, Busan=-36.7/15.0/66.3, Cabo San Lucas=-25.5/23.9/72.3, Cairns=-26.3/25.0/74.1, Cairo=-29.7/21.4/72.6, Calgary=-46.0/4.4/55.7, Canberra=-36.7/13.1/66.9, Cape Town=-31.8/16.2/67.1, Changsha=-34.8/17.4/68.1, Charlotte=-36.6/16.1/66.8, Chiang Mai=-29.7/25.8/72.6, Chicago=-39.6/9.8/62.2, Chihuahua=-30.7/18.6/66.7, Chittagong=-26.0/25.9/82.7, Chișinău=-38.7/10.2/55.8, Chongqing=-33.8/18.6/66.7, Christchurch=-38.4/12.2/61.7, City of San Marino=-37.4/11.8/57.4, Colombo=-23.4/27.4/79.1, Columbus=-35.9/11.7/73.2, Conakry=-23.3/26.4/74.6, Copenhagen=-39.3/9.1/60.7, Cotonou=-21.0/27.2/80.1, Cracow=-44.9/9.3/58.3, Da Lat=-32.6/17.9/65.6, Da Nang=-24.8/25.8/75.6, Dakar=-27.6/24.0/73.8, Dallas=-31.3/19.0/70.2, Damascus=-32.9/17.0/64.2, Dampier=-20.4/26.4/77.5, Dar es Salaam=-25.5/25.8/73.2, Darwin=-26.1/27.6/79.0, Denpasar=-23.6/23.7/74.5, Denver=-39.7/10.4/62.4, Detroit=-43.4/10.0/63.1, Dhaka=-22.1/25.9/78.3, Dikson=-64.9/-11.1/39.5, Dili=-22.8/26.6/78.2, Djibouti=-19.0/29.9/84.4, Dodoma=-25.3/22.7/76.2, Dolisie=-24.4/24.0/76.6, Douala=-21.8/26.7/79.3, Dubai=-20.2/26.9/74.2, Dublin=-45.0/9.8/56.9, Dunedin=-44.3/11.1/63.1, Durban=-28.1/20.6/72.6, Dushanbe=-35.9/14.7/63.6, Edinburgh=-43.6/9.3/64.0, Edmonton=-45.4/4.2/52.4, El Paso=-31.7/18.1/65.7, Entebbe=-32.0/21.0/72.1, Erbil=-27.9/19.5/67.4, Erzurum=-42.6/5.1/55.2, Fairbanks=-49.7/-2.3/49.8, Fianarantsoa=-32.9/17.9/66.1, Flores,  Petén=-23.7/26.4/78.9, Frankfurt=-40.1/10.6/58.2, Fresno=-33.9/17.9/66.0, Fukuoka=-33.0/17.0/68.8, Gaborone=-27.4/21.0/68.8, Gabès=-29.9/19.5/67.4, Gagnoa=-25.9/26.0/74.5, Gangtok=-32.0/15.2/65.4, Garissa=-22.6/29.3/77.9, Garoua=-23.0/28.3/80.1, George Town=-22.0/27.9/80.3, Ghanzi=-25.5/21.4/74.6, Gjoa Haven=-64.0/-14.4/36.1, Guadalajara=-28.5/20.9/70.1, Guangzhou=-26.9/22.4/70.8, Guatemala City=-32.0/20.4/70.9, Halifax=-40.7/7.5/55.2, Hamburg=-38.3/9.7/59.7, Hamilton=-37.7/13.8/62.7, Hanga Roa=-29.0/20.5/71.8, Hanoi=-28.9/23.6/75.7, Harare=-37.7/18.4/71.6, Harbin=-48.2/5.0/60.7, Hargeisa=-26.4/21.7/68.6, Hat Yai=-22.5/27.0/74.9, Havana=-23.4/25.2/77.2, Helsinki=-45.7/5.9/60.0, Heraklion=-40.2/18.9/65.3, Hiroshima=-36.1/16.3/65.6, Ho Chi Minh City=-24.4/27.4/76.3, Hobart=-39.3/12.7/62.3, Hong Kong=-24.8/23.3/73.4, Honiara=-27.1/26.5/76.9, Honolulu=-24.1/25.4/74.2, Houston=-28.6/20.8/77.1, Ifrane=-39.4/11.4/63.2, Indianapolis=-42.1/11.8/64.6, Iqaluit=-56.3/-9.3/41.8, Irkutsk=-50.8/1.0/49.9, Istanbul=-40.4/13.9/61.7, Jacksonville=-30.9/20.3/67.6, Jakarta=-21.4/26.7/74.5, Jayapura=-24.6/27.0/79.6, Jerusalem=-30.4/18.3/70.2, Johannesburg=-34.8/15.5/68.2, Jos=-27.0/22.8/74.9, Juba=-19.9/27.8/78.6, Kabul=-38.6/12.1/60.0, Kampala=-31.5/20.0/67.9, Kandi=-23.4/27.7/79.0, Kankan=-23.2/26.5/81.6, Kano=-27.1/26.4/74.4, Kansas City=-39.3/12.5/62.0, Karachi=-27.1/26.0/75.5, Karonga=-29.7/24.4/70.6, Kathmandu=-34.1/18.3/67.6, Khartoum=-26.2/29.9/77.9, Kingston=-24.3/27.4/81.1, Kinshasa=-22.3/25.3/75.8, Kolkata=-22.0/26.7/79.8, Kuala Lumpur=-22.4/27.3/78.1, Kumasi=-20.9/26.0/76.0, Kunming=-33.5/15.7/69.3, Kuopio=-46.6/3.4/55.9, Kuwait City=-27.2/25.7/75.4, Kyiv=-42.3/8.4/57.5, Kyoto=-32.9/15.8/66.4, La Ceiba=-22.4/26.2/80.0, La Paz=-29.1/23.7/77.9, Lagos=-23.3/26.8/76.5, Lahore=-30.8/24.3/74.6, Lake Havasu City=-27.0/23.7/70.0, Lake Tekapo=-45.1/8.7/56.8, Las Palmas de Gran Canaria=-31.1/21.2/72.2, Las Vegas=-28.6/20.3/69.4, Launceston=-40.0/13.1/65.1, Lhasa=-43.5/7.6/63.7, Libreville=-23.3/25.9/76.1, Lisbon=-34.0/17.5/64.7, Livingstone=-27.7/21.8/72.2, Ljubljana=-42.6/10.9/60.3, Lodwar=-20.6/29.3/76.7, Lomé=-26.5/26.9/76.1, London=-35.9/11.3/59.5, Los Angeles=-34.2/18.6/70.0, Louisville=-36.0/13.9/67.5, Luanda=-26.2/25.8/77.2, Lubumbashi=-27.2/20.8/66.3, Lusaka=-32.0/19.9/70.8, Luxembourg City=-40.8/9.3/61.1, Lviv=-38.6/7.8/59.3, Lyon=-35.0/12.5/57.7, Madrid=-33.2/15.0/63.1, Mahajanga=-26.0/26.3/79.1, Makassar=-22.0/26.7/75.4, Makurdi=-27.2/26.0/81.2, Malabo=-22.2/26.3/77.7, Malé=-20.6/28.0/81.6, Managua=-25.6/27.3/75.2, Manama=-24.6/26.5/74.7, Mandalay=-22.0/28.0/78.6, Mango=-19.7/28.1/80.6, Manila=-20.7/28.4/80.6, Maputo=-25.0/22.8/72.2, Marrakesh=-27.4/19.6/68.8, Marseille=-32.8/15.8/64.9, Maun=-30.5/22.4/73.0, Medan=-26.2/26.5/78.0, Mek'ele=-26.6/22.7/77.8, Melbourne=-46.0/15.1/71.8, Memphis=-35.3/17.2/68.3, Mexicali=-24.8/23.1/75.3, Mexico City=-34.7/17.5/66.8, Miami=-25.3/24.9/73.5, Milan=-34.7/13.0/63.5, Milwaukee=-46.4/8.9/58.4, Minneapolis=-42.0/7.8/56.5, Minsk=-42.8/6.7/55.9, Mogadishu=-27.5/27.1/75.5, Mombasa=-23.1/26.3/72.7, Monaco=-34.4/16.4/65.2, Moncton=-40.1/6.1/59.1, Monterrey=-28.5/22.3/75.7, Montreal=-43.3/6.8/58.5, Moscow=-45.0/5.8/53.6, Mumbai=-19.6/27.1/76.5, Murmansk=-53.3/0.6/50.6, Muscat=-23.0/28.0/80.4, Mzuzu=-32.4/17.7/66.4, N'Djamena=-21.2/28.3/74.8, Naha=-30.1/23.1/74.6, Nairobi=-32.1/17.8/65.2, Nakhon Ratchasima=-24.6/27.3/80.1, Napier=-34.5/14.6/60.2, Napoli=-37.7/15.9/66.2, Nashville=-34.2/15.4/62.5, Nassau=-29.1/24.6/75.7, Ndola=-27.9/20.3/69.4, New Delhi=-30.5/25.0/74.9, New Orleans=-33.1/20.7/77.8, New York City=-37.6/12.9/63.8, Ngaoundéré=-30.2/22.0/75.7, Niamey=-26.6/29.3/79.4, Nicosia=-27.7/19.7/68.8, Niigata=-35.1/13.9/65.4, Nouadhibou=-30.4/21.3/72.7, Nouakchott=-24.9/25.7/73.9, Novosibirsk=-49.9/1.7/54.6, Nuuk=-48.8/-1.4/49.9, Odesa=-38.7/10.7/64.3, Odienné=-24.8/26.0/76.7, Oklahoma City=-31.6/15.9/64.8, Omaha=-39.6/10.6/60.8, Oranjestad=-26.4/28.1/78.1, Oslo=-45.8/5.7/54.8, Ottawa=-42.3/6.6/58.7, Ouagadougou=-20.4/28.3/80.3, Ouahigouya=-18.9/28.6/77.8, Ouarzazate=-30.9/18.9/81.8, Oulu=-45.8/2.7/53.3, Palembang=-20.5/27.3/76.0, Palermo=-35.6/18.5/72.9, Palm Springs=-29.0/24.5/73.2, Palmerston North=-37.8/13.2/63.0, Panama City=-21.2/28.0/77.2, Parakou=-23.3/26.8/77.6, Paris=-41.0/12.3/61.6, Perth=-34.9/18.7/70.0, Petropavlovsk-Kamchatsky=-45.6/1.9/51.1, Philadelphia=-42.3/13.2/64.2, Phnom Penh=-23.5/28.3/80.6, Phoenix=-27.5/23.9/74.1, Pittsburgh=-41.1/10.8/66.7, Podgorica=-36.2/15.3/68.1, Pointe-Noire=-21.2/26.1/76.8, Pontianak=-19.2/27.7/79.8, Port Moresby=-24.0/26.9/74.9, Port Sudan=-19.1/28.4/78.2, Port Vila=-28.2/24.3/71.3, Port-Gentil=-22.6/26.0/81.2, Portland (OR)=-37.2/12.4/64.9, Porto=-34.6/15.7/65.3, Prague=-43.5/8.4/56.4, Praia=-25.1/24.4/73.9, Pretoria=-32.1/18.2/68.7, Pyongyang=-36.5/10.8/62.1, Rabat=-31.8/17.2/65.1, Rangpur=-24.0/24.4/71.3, Reggane=-24.1/28.3/78.0, Reykjavík=-44.0/4.3/54.8, Riga=-46.4/6.2/53.0, Riyadh=-26.5/26.0/75.3, Rome=-37.8/15.2/64.4, Roseau=-22.7/26.2/76.4, Rostov-on-Don=-38.2/9.9/58.8, Sacramento=-37.6/16.3/65.8, Saint Petersburg=-43.3/5.8/53.8, Saint-Pierre=-46.9/5.7/57.1, Salt Lake City=-36.3/11.6/62.2, San Antonio=-28.4/20.8/68.9, San Diego=-30.2/17.8/65.7, San Francisco=-36.1/14.6/63.3, San Jose=-33.5/16.4/66.0, San José=-28.2/22.6/81.0, San Juan=-22.4/27.2/79.3, San Salvador=-27.5/23.1/71.8, Sana'a=-28.6/20.0/70.6, Santo Domingo=-21.4/25.9/78.2, Sapporo=-39.8/8.9/61.5, Sarajevo=-36.3/10.1/59.0, Saskatoon=-45.5/3.3/52.1, Seattle=-34.9/11.3/60.8, Seoul=-34.6/12.5/59.5, Seville=-28.2/19.2/71.0, Shanghai=-37.9/16.7/65.4, Singapore=-24.3/27.0/75.6, Skopje=-37.1/12.4/65.1, Sochi=-41.5/14.2/64.4, Sofia=-38.3/10.6/58.1, Sokoto=-19.5/28.0/76.0, Split=-33.0/16.1/65.9, St. John's=-45.8/5.0/54.4, St. Louis=-38.4/13.9/61.6, Stockholm=-43.3/6.6/61.4, Surabaya=-22.7/27.1/80.4, Suva=-25.5/25.6/75.4, Suwałki=-40.5/7.2/55.1, Sydney=-34.9/17.7/69.5, Ségou=-22.3/28.0/75.5, Tabora=-26.9/23.0/74.5, Tabriz=-35.0/12.6/63.8, Taipei=-28.6/23.0/75.9, Tallinn=-43.8/6.4/56.7, Tamale=-21.5/27.9/78.9, Tamanrasset=-24.9/21.7/73.8, Tampa=-24.2/22.9/72.1, Tashkent=-34.1/14.8/68.4, Tauranga=-34.4/14.8/62.9, Tbilisi=-35.7/12.9/63.7, Tegucigalpa=-29.4/21.7/72.5, Tehran=-31.7/17.0/65.1, Tel Aviv=-32.2/20.0/67.5, Thessaloniki=-35.8/16.0/67.4, Thiès=-28.4/24.0/75.5, Tijuana=-31.2/17.8/71.6, Timbuktu=-20.7/28.0/75.4, Tirana=-34.9/15.2/66.1, Toamasina=-27.0/23.4/72.7, Tokyo=-33.2/15.4/61.9, Toliara=-26.0/24.1/78.0, Toluca=-39.8/12.4/67.9, Toronto=-40.4/9.4/62.2, Tripoli=-28.2/20.0/68.7, Tromsø=-45.0/2.9/54.5, Tucson=-31.0/20.9/71.0, Tunis=-29.8/18.4/68.3, Ulaanbaatar=-50.6/-0.4/47.6, Upington=-27.6/20.4/70.6, Vaduz=-42.2/10.1/59.0, Valencia=-28.5/18.3/71.9, Valletta=-30.3/18.8/68.7, Vancouver=-40.3/10.4/63.5, Veracruz=-21.7/25.4/73.2, Vienna=-42.7/10.4/59.5, Vientiane=-23.7/25.9/73.1, Villahermosa=-20.9/27.1/79.3, Vilnius=-47.1/6.0/55.3, Virginia Beach=-34.2/15.8/69.8, Vladivostok=-43.8/4.9/54.0, Warsaw=-37.1/8.5/60.0, Washington, D.C.=-36.6/14.6/62.5, Wau=-22.2/27.8/76.1, Wellington=-37.5/12.9/64.0, Whitehorse=-49.8/-0.1/59.8, Wichita=-34.0/13.9/65.8, Willemstad=-29.4/28.0/78.5, Winnipeg=-47.4/3.0/55.2, Wrocław=-37.7/9.6/60.3, Xi'an=-37.1/14.1/62.4, Yakutsk=-61.5/-8.8/39.4, Yangon=-20.8/27.5/78.5, Yaoundé=-25.4/23.8/74.6, Yellowknife=-58.3/-4.3/44.8, Yerevan=-35.5/12.4/70.4, Yinchuan=-47.9/9.0/61.2, Zagreb=-41.8/10.7/60.5, Zanzibar City=-21.8/26.0/78.9, Zürich=-41.5/9.3/59.8, Ürümqi=-40.6/7.4/58.6, İzmir=-29.6/17.9/71.1}

real	0m4.573s
user	1m41.831s
sys	0m1.116s


#### BTreeMap -> HashMap

We spend most of the time scanning the BTreeMap, so let's replace it with a HashMap in the threads and keep the BTreeMap in main for ordering.



